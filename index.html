<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASIS Boats — Quotation Management System</title>
    <link rel="icon" type="image/png" href="//asisboats.com/images/2022/03/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PDF Generation Libraries -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
    <!-- Excel Export Library with styling support -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <!-- Firebase SDK (Modular via compat for simplicity) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --navy: #0f2847; --navy-dark: #0a1628; --navy-light: #1a3a5c;
            --gold: #B83240; --gold-light: #d13d4c; --gold-dark: #A52A3A;
            --white: #ffffff; --gray-100: #f8f9fa; --gray-200: #e9ecef; --gray-300: #dee2e6;
            --gray-400: #ced4da; --gray-500: #adb5bd; --gray-600: #6c757d; --gray-700: #495057;
            --success: #28a745; --danger: #dc3545; --warning: #ffc107;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Montserrat', sans-serif; background: var(--gray-100); min-height: 100vh; }
        
        /* Header */
        .header { background: linear-gradient(135deg, var(--navy-dark), var(--navy)); padding: 12px 30px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .header-inner { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; position: relative; }
        .logo-area { display: flex; align-items: center; gap: 20px; }
        .logo-divider { width: 1px; height: 40px; background: linear-gradient(180deg, transparent, rgba(255,255,255,0.5), transparent); }
        .logo-text span { font-size: 10px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 2px; }
        .logo-text h1 { color: var(--white); font-size: 18px; font-weight: 600; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .header-title { font-size: 12px; color: rgba(255,255,255,0.55); text-transform: uppercase; letter-spacing: 2.5px; font-weight: 500; white-space: nowrap; position: absolute; left: 50%; transform: translateX(-50%); }
        .quote-badge { background: var(--gold); border: 1px solid var(--gold); color: white; padding: 8px 18px; border-radius: 8px; font-weight: 600; font-size: 13px; }
        .quote-badge-input { background: var(--gold); border: 2px solid var(--gold); color: white; padding: 8px 18px; border-radius: 8px; font-weight: 600; font-size: 13px; text-align: center; width: 160px; cursor: text; transition: all 0.2s; }
        .quote-badge-input:hover { background: #d4a800; border-color: #d4a800; }
        .quote-badge-input:focus { outline: none; background: white; color: var(--navy); border-color: var(--navy); }
        .quote-badge-input::placeholder { color: rgba(255,255,255,0.7); }
        
        /* Progress */
        .progress-bar { background: var(--navy-dark); padding: 12px 30px; border-top: 1px solid rgba(255,255,255,0.1); position: sticky; top: 52px; z-index: 99; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .progress-inner { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; position: relative; }
        .progress-inner::before { content: ''; position: absolute; top: 16px; left: 60px; right: 60px; height: 2px; background: rgba(255,255,255,0.2); }
        .step { display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; z-index: 1; }
        .step-num { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; color: var(--gray-500); font-weight: 600; font-size: 12px; margin-bottom: 4px; transition: all 0.3s; }
        .step-label { font-size: 10px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s; }
        .step.active .step-num { background: var(--gold); border-color: var(--gold); color: white; box-shadow: 0 0 20px rgba(184,50,64,0.4); }
        .step.active .step-label { color: white; }
        .step.done .step-num { background: var(--success); border-color: var(--success); color: white; }
        .step.done .step-label { color: var(--success); }
        
        /* Toast Notifications */
        .toast-container { position: fixed; top: 120px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
        .toast { pointer-events: auto; display: flex; align-items: center; gap: 10px; padding: 12px 18px; border-radius: 10px; font-size: 13px; font-weight: 500; box-shadow: 0 8px 30px rgba(0,0,0,0.15); transform: translateX(120%); opacity: 0; transition: all 0.35s cubic-bezier(0.4,0,0.2,1); max-width: 420px; backdrop-filter: blur(8px); }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.hiding { transform: translateX(120%); opacity: 0; }
        .toast-error { background: linear-gradient(135deg, #fef2f2, #fee2e2); border: 1px solid #fca5a5; color: #991b1b; }
        .toast-warning { background: linear-gradient(135deg, #fffbeb, #fef3c7); border: 1px solid #fcd34d; color: #92400e; }
        .toast-success { background: linear-gradient(135deg, #f0fdf4, #dcfce7); border: 1px solid #86efac; color: #166534; }
        .toast-info { background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 1px solid #93c5fd; color: #1e40af; }
        .toast-icon { font-size: 18px; flex-shrink: 0; }
        .toast-msg { flex: 1; line-height: 1.4; }
        .toast-close { background: none; border: none; font-size: 16px; cursor: pointer; opacity: 0.5; padding: 0 0 0 8px; color: inherit; }
        .toast-close:hover { opacity: 1; }
        
        /* Cloud Save Indicator */
        .cloud-status { display: flex; align-items: center; gap: 6px; font-size: 11px; color: rgba(255,255,255,0.7); padding: 4px 12px; border-radius: 6px; background: rgba(255,255,255,0.08); }
        .cloud-status .dot { width: 7px; height: 7px; border-radius: 50%; }
        .cloud-status .dot.saved { background: var(--success); box-shadow: 0 0 6px rgba(40,167,69,0.5); }
        .cloud-status .dot.saving { background: var(--warning); animation: pulse 1s infinite; }
        .cloud-status .dot.offline { background: var(--gray-500); }
        .cloud-status .dot.error { background: var(--danger); }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

        /* Login Screen */
        .login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, var(--navy-dark) 0%, var(--navy) 50%, var(--navy-light) 100%); padding: 20px; }
        .login-card { background: white; border-radius: 16px; padding: 40px 36px 36px; max-width: 420px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; }
        .login-card .login-logo { height: 60px; margin-bottom: 6px; }
        .login-card .login-tagline { font-size: 11px; color: var(--gray-500); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 28px; }
        .login-card .login-subtitle { font-size: 13px; color: var(--gray-600); margin-bottom: 18px; font-weight: 500; }
        .avatar-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }
        .avatar-item { cursor: pointer; text-align: center; transition: all 0.25s ease; padding: 10px 4px; border-radius: 10px; }
        .avatar-item:hover { transform: translateY(-3px); background: var(--gray-100); }
        .avatar-item .circle { width: 48px; height: 48px; border-radius: 50%; background: var(--gray-100); border: 2px solid var(--gray-200); display: flex; align-items: center; justify-content: center; margin: 0 auto 6px; font-size: 14px; font-weight: 700; color: var(--gray-600); transition: all 0.25s ease; }
        .avatar-item:hover .circle { border-color: var(--navy-light); box-shadow: 0 4px 12px rgba(15,40,71,0.15); }
        .avatar-item.selected .circle { background: var(--gold); border-color: var(--gold); color: white; box-shadow: 0 4px 15px rgba(184,50,64,0.3); }
        .avatar-item .aname { font-size: 11px; font-weight: 600; color: var(--navy); line-height: 1.2; }
        .avatar-item.selected .aname { color: var(--gold); }
        .pin-row { display: flex; gap: 10px; align-items: center; }
        .pin-row input { flex: 1; padding: 12px 14px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; font-family: 'Montserrat', sans-serif; text-align: center; letter-spacing: 6px; }
        .pin-row input:focus { outline: none; border-color: var(--navy); box-shadow: 0 0 0 3px rgba(15,40,71,0.1); }
        .login-btn { flex-shrink: 0; padding: 12px 24px; background: linear-gradient(135deg, var(--gold), var(--gold-light)); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: 'Montserrat', sans-serif; transition: all 0.2s; }
        .login-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(184,50,64,0.3); }
        .login-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .login-error { color: var(--danger); font-size: 12px; margin-top: 12px; display: none; }

        /* Dashboard */
        .dashboard-screen { display: none; flex: 1; }
        .dashboard-screen.active { display: flex; flex-direction: column; }
        .dashboard-screen > main { flex: 1; }
        #appWrapper.visible { display: flex !important; flex-direction: column; min-height: 100vh; }
        #editorScreen { flex: 1; }
        .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
        .dash-header h2 { font-size: 22px; color: var(--navy); font-weight: 700; }
        .dash-header-actions { display: flex; gap: 10px; align-items: center; }
        .dash-user { display: flex; align-items: center; gap: 8px; font-size: 13px; color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.1); padding: 8px 14px; border-radius: 8px; }
        .dash-user strong { color: white; }
        .logout-btn { background: none; border: 1.5px solid var(--gray-400); padding: 8px 14px; border-radius: 8px; font-size: 12px; cursor: pointer; color: var(--gray-700); font-family: 'Montserrat', sans-serif; font-weight: 500; transition: all 0.2s; }
        .logout-btn:hover { border-color: var(--danger); color: var(--danger); background: rgba(220,53,69,0.05); }
        
        /* Dashboard Stats */
        .dash-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; margin-bottom: 24px; }
        .dash-stat { background: white; border-radius: 10px; padding: 18px 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .dash-stat .label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--gray-500); margin-bottom: 4px; }
        .dash-stat .value { font-size: 24px; font-weight: 700; color: var(--navy); }
        .dash-stat .value.small { font-size: 18px; }

        /* Dashboard Filters */
        .dash-filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .dash-filters input, .dash-filters select { padding: 9px 14px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 13px; font-family: 'Montserrat', sans-serif; background: white; }
        .dash-filters input { min-width: 260px; flex: 1; }
        .dash-filters input:focus, .dash-filters select:focus { outline: none; border-color: var(--navy); box-shadow: 0 0 0 3px rgba(15,40,71,0.08); }
        .dash-filter-label { font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Dashboard Table */
        .dash-table-wrap { background: white; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); overflow: hidden; }
        .dash-table { width: 100%; border-collapse: collapse; }
        .dash-table th { background: var(--navy); color: white; text-align: left; padding: 14px 16px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; white-space: nowrap; cursor: pointer; user-select: none; }
        .dash-table th:hover { background: var(--navy-light); }
        .dash-table th .sort-arrow { opacity: 0.4; margin-left: 4px; }
        .dash-table th.sorted .sort-arrow { opacity: 1; }
        .dash-table td { padding: 14px 16px; font-size: 13px; border-bottom: 1px solid var(--gray-200); color: var(--gray-700); }
        .dash-table tr:hover td { background: var(--gray-100); }
        .dash-table tr { cursor: pointer; transition: background 0.15s; }
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-draft { background: #e3e8ef; color: #4a5568; }
        .status-sent { background: #dbeafe; color: #1e40af; }
        .status-accepted { background: #dcfce7; color: #166534; }
        .status-expired { background: #fee2e2; color: #991b1b; }
        .dash-empty { text-align: center; padding: 60px 20px; color: var(--gray-500); }
        .dash-empty h3 { color: var(--gray-600); margin-bottom: 8px; }
        .dash-actions { display: flex; gap: 6px; }
        .dash-actions button { padding: 6px 10px; border: 1px solid var(--gray-300); background: white; border-radius: 6px; font-size: 11px; cursor: pointer; font-family: 'Montserrat', sans-serif; transition: all 0.15s; }
        .dash-actions button:hover { border-color: var(--navy); color: var(--navy); }
        .dash-actions button.danger:hover { border-color: var(--danger); color: var(--danger); }
        .status-select { padding: 4px 8px !important; border-radius: 6px !important; font-size: 11px !important; min-width: 0 !important; border: 1px solid var(--gray-300) !important; font-family: 'Montserrat', sans-serif; }
        .dash-loading { text-align: center; padding: 40px; color: var(--gray-500); }

        /* Custom Confirmation Modal */
        .confirm-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10,22,40,0.6); backdrop-filter: blur(4px); z-index: 9999; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.25s ease; pointer-events: none; }
        .confirm-overlay.active { opacity: 1; pointer-events: all; }
        .confirm-modal { background: white; border-radius: 16px; padding: 32px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; transform: scale(0.9) translateY(10px); transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1); }
        .confirm-overlay.active .confirm-modal { transform: scale(1) translateY(0); }
        .confirm-modal .confirm-icon { width: 48px; height: 48px; border-radius: 50%; background: #fef3c7; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 22px; }
        .confirm-modal h3 { font-size: 16px; color: var(--navy); margin-bottom: 8px; }
        .confirm-modal p { font-size: 13px; color: var(--gray-600); line-height: 1.5; margin-bottom: 24px; }
        .confirm-modal .confirm-actions { display: flex; gap: 10px; justify-content: center; }
        .confirm-modal .confirm-btn { padding: 10px 24px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: 'Montserrat', sans-serif; transition: all 0.2s; border: none; }
        .confirm-modal .confirm-btn.cancel { background: var(--gray-100); color: var(--gray-700); }
        .confirm-modal .confirm-btn.cancel:hover { background: var(--gray-200); }
        .confirm-modal .confirm-btn.danger { background: linear-gradient(135deg, var(--gold), var(--gold-light)); color: white; }
        .confirm-modal .confirm-btn.danger:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(184,50,64,0.3); }

        /* Professional Footer */
        .app-footer { background: var(--navy-dark); padding: 14px 30px; text-align: center; border-top: 1px solid rgba(255,255,255,0.06); margin-top: auto; }
        .app-footer-inner { max-width: 1400px; margin: 0 auto; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .app-footer .footer-arrow { height: 16px; opacity: 0.4; }
        .app-footer .footer-text { font-size: 10px; color: rgba(255,255,255,0.35); letter-spacing: 0.5px; }
        .app-footer .footer-text a { color: rgba(255,255,255,0.45); text-decoration: none; }
        .app-footer .footer-text a:hover { color: rgba(255,255,255,0.7); }

        /* Step 4 Button Hover Animations */
        #page4 .btn { transition: all 0.25s cubic-bezier(0.4,0,0.2,1); }
        #page4 .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        #page4 .btn:active { transform: translateY(0); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        /* Clickable Cloud Status */
        .cloud-status { cursor: pointer; transition: all 0.2s; }
        .cloud-status:hover { background: rgba(255,255,255,0.15); }

        /* Header Logo */
        .header-logo { height: 30px; display: block; }
        .login-card .login-logo-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 6px; }

        /* Main */
        .main { max-width: 1400px; margin: 0 auto; padding: 30px; }
        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Layout */
        .layout { display: grid; grid-template-columns: 1fr 350px; gap: 25px; align-items: start; }
        @media (max-width: 1100px) { .layout { grid-template-columns: 1fr; } }
        
        /* Cards */
        .card { background: var(--white); border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 20px; overflow: hidden; }
        .card-header { background: linear-gradient(135deg, var(--navy), var(--navy-light)); padding: 18px 22px; display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { color: var(--white); font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 10px; }
        .card-header h2::before { content: ''; width: 4px; height: 20px; background: var(--gold); border-radius: 2px; }
        .card-body { padding: 22px; }
        
        /* Boat Types */
        .boat-types { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        @media (max-width: 900px) { .boat-types { grid-template-columns: 1fr; } }
        .boat-type { background: var(--gray-100); border: 2px solid var(--gray-200); border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.3s; text-align: center; position: relative; overflow: hidden; }
        .boat-type::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--gray-300); transition: all 0.3s; }
        .boat-type:hover { border-color: var(--navy); transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .boat-type:hover::before { background: var(--navy); }
        .boat-type.selected { border-color: var(--gold); background: linear-gradient(135deg, #fef5f6, #fdeaec); }
        .boat-type.selected::before { background: var(--gold); }
        .boat-type.selected::after { content: '✓'; position: absolute; top: 12px; right: 12px; width: 24px; height: 24px; background: var(--gold); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; }
        .boat-type-icon { width: 80px; height: 80px; margin: 0 auto 15px; background: var(--white); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .boat-type h3 { font-size: 18px; font-weight: 700; color: var(--navy); margin-bottom: 8px; }
        .boat-type p { font-size: 13px; color: var(--gray-600); margin-bottom: 15px; }
        .boat-type-stats { display: flex; justify-content: center; gap: 25px; padding-top: 15px; border-top: 1px solid var(--gray-300); }
        .stat { text-align: center; }
        .stat-val { font-size: 16px; font-weight: 700; color: var(--navy); }
        .stat-label { font-size: 10px; color: var(--gray-500); text-transform: uppercase; }
        
        /* Boat Sizes */
        .boat-sizes { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
        .boat-size { background: var(--gray-100); border: 2px solid var(--gray-200); border-radius: 10px; padding: 18px; cursor: pointer; text-align: center; transition: all 0.3s; position: relative; }
        .boat-size:hover { border-color: var(--navy); transform: translateY(-2px); }
        .boat-size.selected { border-color: var(--gold); background: linear-gradient(135deg, #fef5f6, #fdeaec); }
        .boat-size.selected::after { content: '✓'; position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; background: var(--gold); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; }
        .boat-size .size { font-size: 22px; font-weight: 700; color: var(--navy); }
        .boat-size .price { font-size: 15px; font-weight: 600; color: var(--gold-dark); margin: 6px 0; }
        .boat-size .specs { font-size: 11px; color: var(--gray-500); }
        
        /* Summary Sidebar */
        .summary { background: linear-gradient(135deg, var(--navy-dark), var(--navy)); border-radius: 12px; padding: 22px; color: var(--white); }
        #page2 aside, #page1 aside, #page3 aside { position: sticky; top: 135px; align-self: start; max-height: calc(100vh - 155px); overflow-y: auto; }
        .summary-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: white; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .summary-row .lbl { color: var(--gray-400); }
        .summary-row .val { font-weight: 600; }
        .summary-total { display: flex; justify-content: space-between; padding: 15px 0; margin-top: 10px; border-top: 2px solid var(--gold); font-size: 18px; font-weight: 700; }
        .summary-total .lbl { color: white; }
        .curr-btns { display: flex; gap: 5px; margin-top: 15px; }
        .rate-info { font-size: 11px; color: var(--gray-500); margin-top: 8px; text-align: center; }
        .curr-btn { flex: 1; padding: 10px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: var(--gray-400); border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.3s; }
        .curr-btn.active { background: var(--gold); border-color: var(--gold); color: white; }
        
        /* Button below sticky summary */
        .summary-next-btn { width: 100%; margin-top: 15px; padding: 14px 20px; background: linear-gradient(135deg, #c41230, #a00f28); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(196,18,48,0.3); text-transform: uppercase; letter-spacing: 0.5px; }
        .summary-next-btn:hover { background: linear-gradient(135deg, #a00f28, #c41230); transform: translateY(-2px); box-shadow: 0 6px 16px rgba(196,18,48,0.4); }
        .summary-next-btn:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; transform: none; }
        
        /* ===== HIDE NATIVE NUMBER SPINNERS (still allows raw number input) ===== */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; appearance: textfield; }
        
        /* ===== STEP 2 SEARCH BAR ===== */
        .config-search-wrap { position: relative; margin-bottom: 16px; }
        .config-search-wrap input { width: 100%; padding: 13px 18px 13px 44px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 14px; font-family: inherit; background: var(--white); transition: all 0.25s; }
        .config-search-wrap input:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 0 3px rgba(184,50,64,0.1); }
        .config-search-wrap input::placeholder { color: var(--gray-400); }
        .config-search-wrap .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--gray-400); font-size: 16px; pointer-events: none; }
        .config-search-wrap .clear-search { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: var(--gray-200); border: none; border-radius: 50%; width: 22px; height: 22px; display: none; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; color: var(--gray-600); }
        .config-search-wrap .clear-search.visible { display: flex; }
        
        /* ===== CATEGORIES — Cleaner, Flatter ===== */
        .category { background: var(--white); border: 1px solid var(--gray-200); border-radius: 10px; margin-bottom: 6px; overflow: hidden; transition: box-shadow 0.25s; }
        .category:hover { box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
        .cat-header { background: var(--white); color: var(--navy); padding: 10px 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; border-bottom: 1px solid transparent; user-select: none; }
        .cat-header:hover { background: var(--gray-100); }
        .cat-header.open { border-bottom-color: var(--gray-200); }
        .cat-header h3 { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin: 0; display: flex; align-items: center; color: var(--navy); }
        .cat-header .cat-meta { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .cat-header .cat-total { background: var(--gray-100); color: var(--gray-600); padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; transition: all 0.25s; }
        .cat-header .cat-total.has-value { background: var(--gold); color: white; }
        .cat-header .cat-selected-count { background: var(--success); color: white; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; display: none; }
        .cat-header .cat-selected-count.visible { display: inline-block; animation: badgePop 0.3s ease; }
        @keyframes badgePop { 0% { transform: scale(0.7); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        .cat-header .arrow { font-size: 10px; transition: transform 0.3s; color: var(--gray-400); }
        .cat-header.open .arrow { transform: rotate(180deg); color: var(--navy); }
        .cat-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
        .cat-content.open { max-height: 3000px; }
        
        /* ===== MAIN CATEGORY GROUPS ===== */
        .main-group { margin-bottom: 12px; border-radius: 12px; overflow: hidden; border: 1px solid var(--gray-200); background: var(--white); }
        .main-group-header { background: var(--navy); color: var(--white); padding: 12px 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        .main-group-header:hover { background: var(--navy-light); }
        .main-group-header h2 { font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; margin: 0; display: flex; align-items: center; gap: 10px; }
        .main-group-header h2 .group-icon { font-size: 18px; }
        .main-group-header .group-meta { display: flex; align-items: center; gap: 10px; }
        .main-group-header .group-total { background: rgba(255,255,255,0.15); color: white; padding: 5px 14px; border-radius: 6px; font-size: 12px; font-weight: 700; transition: all 0.25s; }
        .main-group-header .group-total.has-value { background: var(--gold); }
        .main-group-header .group-arrow { font-size: 12px; transition: transform 0.3s; opacity: 0.7; }
        .main-group-header.open .group-arrow { transform: rotate(180deg); }
        .main-group-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease; }
        .main-group-content.open { max-height: 15000px; }
        .main-group-inner { padding: 8px 10px; }
        .main-group-inner .category { margin-bottom: 6px; }
        
        /* Main group color accents — subtle left border instead of background fills */
        .main-group-engine { border-left: 4px solid #0ea5e9; }
        .main-group-engine .main-group-inner { background: #f8fcfe; }
        .main-group-accessories { border-left: 4px solid #f59e0b; }
        .main-group-accessories .main-group-inner { background: #fffdf7; }
        .main-group-electronics { border-left: 4px solid #8b5cf6; }
        .main-group-electronics .main-group-inner { background: #faf8ff; }
        
        /* ===== FLAT CATEGORY (top-level like Propulsion) ===== */
        .flat-category { margin-bottom: 12px; border-radius: 12px; overflow: hidden; border: 1px solid var(--gray-200); }
        .flat-category .cat-header { background: var(--navy); color: white; padding: 12px 18px; }
        .flat-category .cat-header:hover { background: var(--navy-light); }
        .flat-category .cat-header h3 { font-size: 14px; font-weight: 700; letter-spacing: 0.8px; color: white; }
        .flat-category .cat-meta .cat-total { background: rgba(255,255,255,0.15); color: white; }
        .flat-category .cat-meta .cat-total.has-value { background: var(--gold); }
        .flat-category .arrow { color: rgba(255,255,255,0.6) !important; }
        .flat-category .cat-header.open .arrow { color: white !important; }
        .flat-category.engine-flat { border-left: 4px solid #0ea5e9; }
        .flat-category.engine-flat .cat-content { background: #f8fcfe; }
        .flat-category.accessories-flat .cat-content { background: #fffdf7; }
        .flat-category.electronics-flat .cat-content { background: #faf8ff; }
        
        /* ===== NESTED SUBGROUP ===== */
        .subgroup { margin-bottom: 6px; border-radius: 8px; overflow: hidden; border: 1px solid var(--gray-200); background: var(--white); }
        .subgroup-header { background: var(--gray-100); color: var(--navy); padding: 10px 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        .subgroup-header:hover { background: var(--gray-200); }
        .subgroup-header h4 { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; color: var(--navy); }
        .subgroup-header .subgroup-meta { display: flex; align-items: center; gap: 8px; }
        .subgroup-header .subgroup-total { background: var(--gray-200); color: var(--gray-600); padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; transition: all 0.25s; }
        .subgroup-header .subgroup-total.has-value { background: var(--gold); color: white; }
        .subgroup-header .subgroup-arrow { font-size: 10px; transition: transform 0.3s; color: var(--gray-400); }
        .subgroup-header.open .subgroup-arrow { transform: rotate(180deg); }
        .subgroup-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
        .subgroup-content.open { max-height: 5000px; }
        .subgroup-inner { padding: 6px 8px; }
        .subgroup-inner .category { margin-bottom: 4px; }
        
        .cat-inner { padding: 6px 8px; }
        
        /* Item Grid */
        .item-grid-header { display: grid; grid-template-columns: 2fr 70px 110px 100px 40px; gap: 10px; padding: 10px 12px; background: var(--gray-100); border-radius: 6px; margin-bottom: 10px; }
        .item-grid-header span { font-size: 10px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; }
        .item-grid-header .right { text-align: right; }
        
        .item-row { display: grid; grid-template-columns: 2fr 70px 110px 100px 40px; gap: 10px; padding: 12px; border-bottom: 1px solid var(--gray-200); align-items: center; transition: background 0.2s; }
        .item-row:hover { background: var(--gray-100); }
        .item-row:last-of-type { border-bottom: none; }
        .item-row select { width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 13px; background: var(--white); cursor: pointer; }
        .item-row select:focus { outline: none; border-color: var(--gold); }
        .item-row input[type="number"] { width: 100%; padding: 10px; border: 1px solid var(--gray-300); border-radius: 6px; text-align: center; font-size: 13px; font-weight: 500; }
        .item-row .price-input { text-align: right; font-weight: 600; color: var(--gray-700); }
        .item-row .extended { font-weight: 700; color: var(--success); text-align: right; font-size: 14px; }
        .item-row .tbd { color: var(--warning); font-style: italic; }
        .delete-btn { width: 36px; height: 36px; border: none; background: var(--danger); color: var(--white); border-radius: 6px; cursor: pointer; font-size: 18px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .delete-btn:hover { background: #c82333; transform: scale(1.05); }
        .add-btn { background: var(--success); color: var(--white); border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; margin-top: 12px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .add-btn:hover { background: #218838; transform: translateY(-1px); }
        
        .custom-input { width: 100%; padding: 10px; border: 2px dashed var(--gold); border-radius: 6px; font-size: 13px; background: #fef5f6; }
        .custom-input:focus { outline: none; border-style: solid; }
        
        /* Forms */
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full { grid-column: span 2; }
        .form-group label { font-size: 11px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { padding: 12px 14px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; font-family: inherit; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--gold); }
        
        /* Buttons */
        .btn { padding: 14px 28px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-primary { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: white; box-shadow: 0 4px 15px rgba(184,50,64,0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(184,50,64,0.4); }
        .btn-secondary { background: var(--gray-200); color: var(--gray-700); }
        .btn-secondary:hover { background: var(--gray-300); }
        .btn-success { background: linear-gradient(135deg, var(--success), #1e7e34); color: var(--white); }
        .btn-outline { background: linear-gradient(135deg, #4a5568, #718096); color: var(--white); border: none; }
        .btn-outline:hover { background: linear-gradient(135deg, #2d3748, #4a5568); color: var(--white); }
        .actions { display: flex; justify-content: space-between; margin-top: 25px; padding-top: 25px; border-top: 1px solid var(--gray-200); }
        
        /* Preview */
        .preview { background: var(--white); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; }
        .preview-header { background: var(--navy); color: var(--white); padding: 40px; text-align: center; }
        .preview-header h1 { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
        .preview-header p { color: white; font-size: 14px; letter-spacing: 2px; }
        .preview-body { padding: 40px; }
        .preview-meta { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin-bottom: 30px; padding-bottom: 30px; border-bottom: 2px solid var(--gray-200); }
        .preview-meta h4 { color: var(--navy); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .preview-meta p { font-size: 14px; color: var(--gray-700); line-height: 1.8; }
        .preview-meta-section { background: var(--gray-100); border-radius: 8px; padding: 20px; }
        .preview-meta-section h4 { color: var(--navy); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--gold); }
        .preview-meta-grid { display: grid; grid-template-columns: auto 1fr; gap: 8px 15px; font-size: 13px; }
        .preview-meta-grid .label { color: var(--gray-600); font-weight: 500; }
        .preview-meta-grid .value { color: var(--gray-800); }
        .preview-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .preview-table th { background: var(--navy); color: var(--white); padding: 14px; text-align: left; font-size: 12px; text-transform: uppercase; }
        .preview-table th:first-child { border-top-left-radius: 12px; }
        .preview-table th:last-child { border-top-right-radius: 12px; }
        .preview-table th:nth-child(2) { width: 80px; text-align: center; }
        .preview-table th:nth-child(3) { width: 120px; text-align: right; }
        .preview-table th:nth-child(4) { width: 120px; text-align: right; }
        .preview-table th.right { text-align: right; }
        .preview-table td { padding: 14px; border-bottom: 1px solid var(--gray-200); font-size: 14px; vertical-align: middle; }
        .preview-table td:nth-child(2) { text-align: center; }
        .preview-table td.right { text-align: right; }
        .preview-table tr:last-child td:first-child { border-bottom-left-radius: 12px; }
        .preview-table tr:last-child td:last-child { border-bottom-right-radius: 12px; }
        .preview-table tr:last-child td { border-bottom: none; }
        .preview-table tr.cat-boat { background: #1e3a5f; }
        .preview-table tr.cat-boat td { color: white; font-weight: 600; border-bottom: 2px solid var(--gold); font-size: 15px; }
        .preview-table tr.cat-engine { background: #e6f4f8; }
        .preview-table tr.cat-accessories { background: #fdf6e9; }
        .preview-table tr.cat-electronics { background: #f3eefa; }
        .preview-table tr.section-header { background: #64748b !important; }
        .preview-table tr.section-header td { color: white !important; font-weight: 500; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; padding: 4px 14px !important; border: none !important; border-bottom: none !important; background: #64748b !important; }
        .preview-totals { text-align: right; }
        .preview-totals div { padding: 8px 0; font-size: 15px; }
        .preview-totals .grand { font-size: 20px; font-weight: 700; color: var(--navy); border-top: 2px solid var(--navy); padding-top: 15px; margin-top: 10px; }
        .preview-notes { margin-top: 30px; padding: 20px; background: var(--gray-100); border-radius: 8px; border-left: 4px solid var(--gold); }
        .preview-notes h4 { color: var(--navy); font-size: 12px; text-transform: uppercase; margin-bottom: 10px; }
        .preview-notes p { font-size: 14px; color: var(--gray-700); white-space: pre-wrap; }

        /* Selected Items */
        .selected-items { max-height: 320px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.2) transparent; }
        .selected-items::-webkit-scrollbar { width: 4px; }
        .selected-items::-webkit-scrollbar-track { background: transparent; }
        .selected-items::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        .sel-item { display: flex; justify-content: space-between; align-items: center; padding: 7px 0; font-size: 12px; border-bottom: 1px solid rgba(255,255,255,0.06); gap: 8px; }
        .sel-item:last-child { border-bottom: none; }
        .sel-item .name { color: var(--gray-300); flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 1.3; }
        .sel-item .amt { color: var(--gold-light); font-weight: 600; white-space: nowrap; }
        .sel-item-boat { padding: 8px 10px; background: rgba(255,255,255,0.06); border-radius: 6px; margin-bottom: 8px; }
        .sel-item-boat .name { color: white; font-weight: 600; }

        /* Info banner */
        .info-banner { background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 1px solid #93c5fd; border-radius: 10px; padding: 12px 18px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .info-banner .icon { font-size: 20px; flex-shrink: 0; }
        .info-banner .text { font-size: 12px; color: #1e40af; line-height: 1.4; }
        .info-banner .text strong { display: block; margin-bottom: 2px; font-size: 13px; }

        /* ===== RADIO BUTTON GROUPS (Exclusive Categories) ===== */
        .radio-group { padding: 8px 10px; }
        .radio-group-label { font-size: 11px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .radio-group-label .exclusive-badge { background: var(--gold); color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; }
        .radio-option { display: flex; align-items: center; padding: 6px 12px; margin-bottom: 4px; background: var(--white); border: 2px solid var(--gray-200); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        .radio-option:hover { border-color: var(--navy-light); background: #f8fafc; transform: translateX(2px); }
        .radio-option.selected { border-color: var(--gold); background: linear-gradient(135deg, #fef7f8, #fdf0f2); box-shadow: 0 2px 8px rgba(184,50,64,0.1); }
        .radio-option input[type="radio"] { width: 16px; height: 16px; margin-right: 10px; accent-color: var(--gold); cursor: pointer; flex-shrink: 0; }
        .radio-option .option-details { flex: 1; min-width: 0; }
        .radio-option .option-name { font-size: 12px; font-weight: 500; color: var(--navy); line-height: 1.3; }
        .radio-option .option-price { font-size: 12px; font-weight: 700; color: var(--gold-dark); min-width: 70px; text-align: right; white-space: nowrap; }
        .radio-option .option-price.tbd { color: var(--warning); font-style: italic; }
        .radio-option.none-option { background: var(--gray-100); border-style: dashed; border-color: var(--gray-300); }
        .radio-option.none-option:hover { border-color: var(--gray-400); background: var(--white); }
        .radio-option.none-option .option-name { color: var(--gray-500); font-style: italic; font-weight: 400; }
        .radio-option.selected.none-option { border-color: var(--gray-400); background: var(--gray-100); box-shadow: none; }

        /* ===== CHECKBOX GROUPS (Multi-select Categories) ===== */
        .checkbox-group { padding: 8px 10px; }
        .checkbox-option { display: flex; align-items: center; padding: 6px 12px; margin-bottom: 4px; background: var(--white); border: 2px solid var(--gray-200); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        .checkbox-option:hover { border-color: var(--navy-light); background: #f8fafc; transform: translateX(2px); }
        .checkbox-option.selected { border-color: var(--gold); background: linear-gradient(135deg, #fef7f8, #fdf0f2); box-shadow: 0 2px 8px rgba(184,50,64,0.1); }
        .checkbox-option input[type="checkbox"] { width: 16px; height: 16px; margin-right: 10px; accent-color: var(--gold); cursor: pointer; flex-shrink: 0; }
        .checkbox-option .option-details { flex: 1; min-width: 0; }
        .checkbox-option .option-name { font-size: 12px; font-weight: 500; color: var(--navy); line-height: 1.3; }
        .checkbox-option .option-price { font-size: 12px; font-weight: 700; color: var(--gold-dark); min-width: 70px; text-align: right; white-space: nowrap; }
        .checkbox-option .option-price.tbd { color: var(--warning); font-style: italic; }
        
        /* ===== QTY STEPPER (compact to match option height) ===== */
        .qty-stepper { display: flex; align-items: center; gap: 0; margin: 0 10px; border: 1px solid var(--gray-300); border-radius: 5px; overflow: hidden; background: var(--white); flex-shrink: 0; height: 26px; }
        .qty-stepper button { width: 24px; height: 26px; border: none; background: var(--gray-100); color: var(--navy); font-size: 13px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; padding: 0; line-height: 1; }
        .qty-stepper button:hover { background: var(--gray-200); }
        .qty-stepper button:active { background: var(--gray-300); }
        .qty-stepper input { width: 32px; padding: 2px 1px; border: none; border-left: 1px solid var(--gray-200); border-right: 1px solid var(--gray-200); text-align: center; font-size: 12px; font-weight: 600; color: var(--navy); background: var(--white); height: 26px; }
        .qty-stepper input:focus { outline: none; background: #fef7f8; }
        /* (qty-control styles removed — replaced by qty-stepper) */
        .radio-option .option-extended { font-size: 12px; font-weight: 700; color: var(--success); min-width: 70px; text-align: right; white-space: nowrap; }
        .checkbox-option .option-extended { font-size: 12px; font-weight: 700; color: var(--success); min-width: 70px; text-align: right; white-space: nowrap; }
        .checkbox-option .option-extended .tbd { color: var(--warning); font-style: italic; font-weight: 500; }
        
        /* ===== TBD PRICE INPUT ===== */
        .tbd-price-input { width: 80px; padding: 4px 8px; border: 2px solid var(--warning); border-radius: 4px; font-size: 12px; font-weight: 600; text-align: right; background: #fffbeb; color: var(--navy-dark); }
        .tbd-price-input:focus { outline: none; border-color: var(--gold); background: #fff; }
        .tbd-price-input::placeholder { color: #b45309; font-style: italic; }
        .tbd-input-wrapper { display: flex; align-items: center; gap: 4px; }
        .tbd-input-wrapper span { color: var(--warning); font-weight: 600; }
        
        /* ===== CUSTOM ITEM INPUT ===== */
        .custom-item-row { display: flex; gap: 6px; padding: 8px 10px; background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border-top: 1px dashed #86efac; margin-top: 2px; border-radius: 0 0 8px 8px; align-items: center; }
        .custom-item-row input[type="text"] { flex: 1; padding: 8px 12px; border: 1px solid #86efac; border-radius: 6px; font-size: 13px; font-family: inherit; background: white; }
        .custom-item-row input[type="text"]:focus { outline: none; border-color: var(--success); box-shadow: 0 0 0 2px rgba(40,167,69,0.1); }
        .custom-item-row input[type="number"] { width: 70px; padding: 8px; border: 1px solid #86efac; border-radius: 6px; font-size: 13px; text-align: center; font-family: inherit; background: white; }
        .custom-item-row input[type="number"]:focus { outline: none; border-color: var(--success); }
        .custom-item-row .add-btn { background: var(--success); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; white-space: nowrap; transition: all 0.2s; font-family: inherit; }
        .custom-item-row .add-btn:hover { background: #15803d; transform: translateY(-1px); }
        .custom-item-row .price-input { width: 90px; }
        .custom-item-label { font-size: 11px; color: #16a34a; font-weight: 600; margin-right: 5px; white-space: nowrap; }
        
        /* ===== EXCLUSIVE BADGE ===== */
        .exclusive-badge { background: var(--gold) !important; color: white !important; font-size: 9px !important; padding: 2px 8px !important; border-radius: 4px !important; margin-left: 8px !important; font-weight: 700 !important; letter-spacing: 0.3px; }
        
        /* ===== OPTIONS COUNT ===== */
        .options-count { opacity: 0.5; font-weight: 400; font-size: 11px; margin-left: 8px; }
        
        /* ===== ITEM HIDDEN BY SEARCH ===== */
        .search-hidden { display: none !important; }
        .category.search-hidden-cat { display: none !important; }
        .main-group.search-hidden-group { display: none !important; }
        .subgroup.search-hidden-sub { display: none !important; }
        .search-no-results { padding: 40px 20px; text-align: center; color: var(--gray-500); font-size: 14px; display: none; }
        .search-no-results.visible { display: block; }
        .search-highlight { background: rgba(184,50,64,0.12); border-radius: 2px; padding: 0 1px; }

        /* Print Styles - Only print the quotation preview */
        @media print {
            /* Hide everything except the preview */
            body * { visibility: hidden; }
            .preview, .preview * { visibility: visible; }
            .preview { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%;
                margin: 0;
                padding: 20px;
                box-shadow: none;
            }
            
            /* Hide header, navigation, buttons, sidebar, login, dashboard */
            .header, .steps, .card-header, .actions, aside, .summary, #loginScreen, #dashboardScreen, .cloud-status, .progress-bar { display: none !important; }
            
            /* Ensure colors print */
            .preview-header { background: var(--navy) !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .preview-table th { background: var(--navy) !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .preview-table tr.cat-boat { background: var(--navy) !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .preview-table tr.cat-boat td { color: white !important; }
            .preview-table tr.cat-engine { background: #e6f4f8 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .preview-table tr.cat-accessories { background: #fdf6e9 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .preview-table tr.cat-electronics { background: #f3eefa !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .preview-table tr.section-header { background: #64748b !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .preview-table tr.section-header td { background: #64748b !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; color: white !important; padding: 4px 14px !important; border: none !important; font-weight: 500; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
            .preview-meta-section { background: #f3f4f6 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            
            /* Page settings */
            @page { margin: 1cm; size: A4; }
        }
    </style>
</head>
<body>
    <!-- Custom Confirmation Modal -->
    <div class="confirm-overlay" id="confirmOverlay">
        <div class="confirm-modal">
            <div class="confirm-icon">⚠️</div>
            <h3 id="confirmTitle">Reset Configuration?</h3>
            <p id="confirmMessage">This will clear all your current accessories and selections. This action cannot be undone.</p>
            <div class="confirm-actions">
                <button class="confirm-btn cancel" onclick="closeConfirm(false)">Cancel</button>
                <button class="confirm-btn danger" onclick="closeConfirm(true)">Yes, Reset</button>
            </div>
        </div>
    </div>
    <!-- ==================== LOGIN SCREEN ==================== -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-logo-container">
                <img src="https://asisboats.com/images/2021/09/asis-logo-aces-1.svg" class="login-logo" alt="ASIS Boats">
            </div>
            <div class="login-tagline">Quotation Management System</div>
            <div class="login-subtitle">Select your profile to sign in</div>
            <div class="avatar-grid" id="avatarRow">
                <div class="avatar-item" onclick="selectLoginUser('mario', this)" data-user="mario">
                    <div class="circle">MH</div>
                    <div class="aname">Mario</div>
                </div>
                <div class="avatar-item" onclick="selectLoginUser('soufiane', this)" data-user="soufiane">
                    <div class="circle">ST</div>
                    <div class="aname">Soufiane</div>
                </div>
                <div class="avatar-item" onclick="selectLoginUser('toji', this)" data-user="toji">
                    <div class="circle">TP</div>
                    <div class="aname">Toji</div>
                </div>
                <div class="avatar-item" onclick="selectLoginUser('pierre', this)" data-user="pierre">
                    <div class="circle">PN</div>
                    <div class="aname">Pierre</div>
                </div>
                <div class="avatar-item" onclick="selectLoginUser('rana', this)" data-user="rana">
                    <div class="circle">RN</div>
                    <div class="aname">Rana</div>
                </div>
                <div class="avatar-item" onclick="selectLoginUser('guest', this)" data-user="guest">
                    <div class="circle">G</div>
                    <div class="aname">Guest</div>
                </div>
            </div>
            <div class="pin-row">
                <input type="password" id="loginPin" placeholder="PIN" maxlength="4" onkeydown="if(event.key==='Enter')loginUser()">
                <button class="login-btn" onclick="loginUser()">Sign In →</button>
            </div>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>

    <!-- ==================== APP (hidden until login) ==================== -->
    <div id="appWrapper" style="display:none;">
    
    <!-- ==================== DASHBOARD ==================== -->
    <div id="dashboardScreen" class="dashboard-screen">
        <header class="header">
            <div class="header-inner">
                <div class="logo-area">
                    <img src="https://asisboats.com/images/2021/09/asis-logo-aces-1.svg" class="header-logo" alt="ASIS Boats">
                </div>
                <div class="header-title">Quotation Management System</div>
                <div class="header-right">
                    <div class="dash-user"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> <strong id="dashUserName"></strong></div>
                    <button class="logout-btn" onclick="logoutUser()" style="border-color:rgba(255,255,255,0.4);color:rgba(255,255,255,0.85);font-weight:500;">Sign Out</button>
                </div>
            </div>
        </header>
        <main class="main">
            <div class="dash-header">
                <h2 id="dashTitle">📋 My Quotations</h2>
                <div class="dash-header-actions">
                    <button class="login-btn" style="width:auto;padding:12px 24px;" onclick="startNewEditor()">✚ New Quotation</button>
                </div>
            </div>
            <div class="dash-stats" id="dashStats">
                <div class="dash-stat"><div class="label">Total Quotes</div><div class="value" id="statTotal">-</div></div>
                <div class="dash-stat"><div class="label">Drafts</div><div class="value" id="statDrafts">-</div></div>
                <div class="dash-stat"><div class="label">Sent</div><div class="value" id="statSent">-</div></div>
                <div class="dash-stat"><div class="label">Total Value (USD)</div><div class="value small" id="statValue">-</div></div>
            </div>
            <div class="dash-filters">
                <input type="text" id="dashSearch" placeholder="🔍 Search by quote #, customer, boat type..." oninput="renderDashboard()">
                <select id="dashSalesmanFilter" onchange="renderDashboard()" style="display:none;">
                    <option value="">All Salesmen</option>
                    <option value="mario">Mario Hoyek</option>
                    <option value="soufiane">Soufiane Tangi</option>
                    <option value="toji">Toji Paul</option>
                    <option value="guest">Guest</option>
                </select>
                <select id="dashStatusFilter" onchange="renderDashboard()">
                    <option value="">All Statuses</option>
                    <option value="draft">Draft</option>
                    <option value="sent">Sent</option>
                    <option value="accepted">Accepted</option>
                    <option value="expired">Expired</option>
                </select>
                <select id="dashAmountFilter" onchange="renderDashboard()">
                    <option value="">Any Amount</option>
                    <option value="0-50000">Under $50K</option>
                    <option value="50000-100000">$50K - $100K</option>
                    <option value="100000-500000">$100K - $500K</option>
                    <option value="500000-0">Over $500K</option>
                </select>
                <select id="dashDateFilter" onchange="renderDashboard()">
                    <option value="">Any Time</option>
                    <option value="7">Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">This Quarter</option>
                    <option value="365">This Year</option>
                </select>
            </div>
            <div class="dash-table-wrap">
                <table class="dash-table">
                    <thead>
                        <tr>
                            <th onclick="sortDashboard('quoteNumber')">Quote # <span class="sort-arrow">↕</span></th>
                            <th onclick="sortDashboard('customerCompany')">Customer <span class="sort-arrow">↕</span></th>
                            <th onclick="sortDashboard('boatType')">Boat <span class="sort-arrow">↕</span></th>
                            <th onclick="sortDashboard('totalAmountUSD')">Amount <span class="sort-arrow">↕</span></th>
                            <th onclick="sortDashboard('salesmanName')" id="thCreatedBy" style="display:none;">Created By <span class="sort-arrow">↕</span></th>
                            <th onclick="sortDashboard('status')">Status <span class="sort-arrow">↕</span></th>
                            <th onclick="sortDashboard('updatedAt')">Last Modified <span class="sort-arrow">↕</span></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dashTableBody">
                        <tr><td colspan="7" class="dash-loading">Loading quotations...</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- ==================== EDITOR (the original quotation builder) ==================== -->
    <div id="editorScreen" style="display:none;">
    <header class="header">
        <div class="header-inner">
            <div class="logo-area">
                <button id="editorBackBtn" class="logout-btn" onclick="backToDashboard()" style="border-color:rgba(255,255,255,0.3);color:rgba(255,255,255,0.8);display:inline-flex;align-items:center;gap:6px;padding:8px 14px;">
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none" style="flex-shrink:0;"><path d="M12 7H2m0 0l4.5-4.5M2 7l4.5 4.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <span class="back-label">Dashboard</span>
                </button>
                <div class="logo-divider"></div>
                <img src="https://asisboats.com/images/2021/09/asis-logo-aces-1.svg" class="header-logo" alt="ASIS Boats">
            </div>
            <div class="header-title">Quotation Management System</div>
            <div class="header-right">
                <div class="cloud-status" id="cloudStatus" onclick="saveQuotationToCloud()" title="Click to save now">
                    <span class="dot saved" id="cloudDot"></span>
                    <span id="cloudText">Saved</span>
                </div>
                <input type="text" class="quote-badge-input" id="quoteBadgeInput" value="ASIS-25-0001" 
                    oninput="syncQuoteNumber(this.value, 'header')" 
                    onclick="this.select()">
            </div>
        </div>
    </header>

    <nav class="progress-bar">
        <div class="progress-inner">
            <div class="step active" onclick="goTo(1)"><div class="step-num">1</div><div class="step-label">Boat Selection</div></div>
            <div class="step" onclick="goTo(2)"><div class="step-num">2</div><div class="step-label">Configuration</div></div>
            <div class="step" onclick="goTo(3)"><div class="step-num">3</div><div class="step-label">Information</div></div>
            <div class="step" onclick="goTo(4)"><div class="step-num">4</div><div class="step-label">Review</div></div>
        </div>
    </nav>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <main class="main">
        <!-- PAGE 1: BOAT SELECTION -->
        <div id="page1" class="page active">
            <div class="layout">
                <div>
                    <div class="card">
                        <div class="card-header"><h2>Select Boat Type</h2></div>
                        <div class="card-body">
                            <div class="boat-types" id="boatTypesGrid"></div>
                        </div>
                    </div>
                    <div class="card" id="sizesCard" style="display:none;">
                        <div class="card-header"><h2>Select Size</h2></div>
                        <div class="card-body">
                            <div class="boat-sizes" id="boatSizesGrid"></div>
                            <div style="text-align:center;padding:8px 0 0;font-size:11px;color:var(--gray-500);">Click a size to continue — prices shown in <span id="sizesCurrLabel">USD</span></div>
                        </div>
                    </div>
                </div>
                <aside>
                    <div class="summary">
                        <div class="summary-title">Quote Summary</div>
                        <div class="summary-row"><span class="lbl">Boat Type</span><span class="val" id="sumType">-</span></div>
                        <div class="summary-row"><span class="lbl">Size</span><span class="val" id="sumSize">-</span></div>
                        <div class="summary-row"><span class="lbl">Base Price</span><span class="val" id="sumBase">-</span></div>
                        <div class="summary-row"><span class="lbl">Options & Accessories</span><span class="val" id="sumOptions">$0</span></div>
                        <div class="summary-total"><span class="lbl">Total</span><span class="val" id="sumTotal">$0</span></div>
                        <div class="curr-btns">
                            <button class="curr-btn active" onclick="setCurrency('USD')">USD</button>
                            <button class="curr-btn" onclick="setCurrency('AED')">AED</button>
                            <button class="curr-btn" onclick="setCurrency('EUR')">EUR</button>
                        </div>
                        <div id="rateInfo1" class="rate-info"></div>
                    </div>
                    <!-- Continue Button -->
                    <button class="summary-next-btn" id="nextBtn1" onclick="goTo(2)" disabled>
                        Continue to Configuration →
                    </button>
                </aside>
            </div>
        </div>

        <!-- PAGE 2: CONFIGURATION -->
        <div id="page2" class="page">
            <div class="layout">
                <div>
                    <div style="display:flex;gap:10px;align-items:stretch;margin-bottom:12px;">
                        <div class="info-banner" style="flex:1;margin-bottom:0;">
                            <span class="icon">🛠️</span>
                            <div class="text">
                                <strong>Configure accessories for your selected boat</strong>
                                Options shown are specific to your boat type and size. Use the search to quickly find items.
                            </div>
                        </div>
                        <button class="btn btn-secondary" style="padding:8px 16px;font-size:11px;white-space:nowrap;" onclick="toggleAllCategories()" id="toggleAllBtn">
                            ▲ Collapse All
                        </button>
                    </div>
                    <div class="config-search-wrap">
                        <span class="search-icon">🔍</span>
                        <input type="text" id="configSearchInput" placeholder="Search accessories... (e.g. T-Top, GPS, Mercury)" oninput="handleConfigSearch(this.value)">
                        <button class="clear-search" id="clearSearchBtn" onclick="clearConfigSearch()">✕</button>
                    </div>
                    <div class="card" style="border:none;box-shadow:none;background:transparent;">
                        <div class="card-header" style="border-radius:10px;margin-bottom:12px;">
                            <h2>Configure Your Boat</h2>
                            <span style="color:white;font-size:12px;font-weight:600;" id="selectedBoatLabel">-</span>
                        </div>
                        <div class="card-body" style="padding:0;background:transparent;">
                            <div id="categoriesContainer"></div>
                            <div class="search-no-results" id="searchNoResults">
                                <div style="font-size:32px;margin-bottom:10px;">🔍</div>
                                <div style="font-weight:600;margin-bottom:4px;">No matching accessories found</div>
                                <div style="font-size:12px;">Try different keywords or clear the search</div>
                            </div>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-secondary" onclick="goTo(1)">← Back</button>
                    </div>
                </div>
                <aside>
                    <div class="summary">
                        <div class="summary-title">Selected Items</div>
                        <div class="selected-items" id="selectedItemsList"></div>
                        <div id="sidebarBreakdown" style="border-top:1px solid rgba(255,255,255,0.08);margin-top:8px;padding-top:8px;display:none;">
                            <div style="display:flex;justify-content:space-between;font-size:11px;padding:3px 0;"><span style="color:#7dd3fc;">⚙️ Engine</span><span style="color:#7dd3fc;font-weight:600;" id="sideEngine">$0</span></div>
                            <div style="display:flex;justify-content:space-between;font-size:11px;padding:3px 0;"><span style="color:#fcd34d;">🛠️ Accessories</span><span style="color:#fcd34d;font-weight:600;" id="sideAccessories">$0</span></div>
                            <div style="display:flex;justify-content:space-between;font-size:11px;padding:3px 0;"><span style="color:#c4b5fd;">📡 Electronics</span><span style="color:#c4b5fd;font-weight:600;" id="sideElectronics">$0</span></div>
                        </div>
                        <div class="summary-total"><span class="lbl">Total</span><span class="val" id="sumTotal2">$0</span></div>
                        <div class="curr-btns">
                            <button class="curr-btn active" onclick="setCurrency('USD')">USD</button>
                            <button class="curr-btn" onclick="setCurrency('AED')">AED</button>
                            <button class="curr-btn" onclick="setCurrency('EUR')">EUR</button>
                        </div>
                        <div id="rateInfo2" class="rate-info"></div>
                    </div>
                    <button class="summary-next-btn" onclick="goTo(3)">
                        Continue to Information →
                    </button>
                </aside>
            </div>
        </div>

        <!-- PAGE 3: INFORMATION -->
        <div id="page3" class="page">
            <div class="layout">
                <div>
                    <div class="card">
                        <div class="card-header"><h2>Quote Information</h2></div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group" style="grid-column: span 2;"><label>Quotation Title <span style="color:var(--gold);font-weight:700;">*</span></label><input type="text" id="quoteTitle" placeholder="e.g., 12m Aluminum RIB Boats" autocomplete="off"></div>
                                <div class="form-group"><label>Quote Number <span style="color:var(--gold);font-weight:700;">*</span></label><input type="text" id="quoteNum" value="ASIS-25-0001" oninput="syncQuoteNumber(this.value, 'step3')" autocomplete="off"></div>
                                <div class="form-group"><label>Boat Quantity</label><input type="number" id="boatQty" value="1" min="1" max="100" onchange="updateTotals()"></div>
                                <div class="form-group"><label>Date <span style="color:var(--gold);font-weight:700;">*</span></label><input type="date" id="quoteDate"></div>
                                <div class="form-group"><label>Validity</label><select id="validity"><option selected>30 Days</option><option>90 Days</option></select></div>
                                <div class="form-group"><label>Salesman</label>
                                    <select id="salesman" onchange="toggleCustomSalesman()">
                                        <!-- Populated dynamically by populateSalesmanDropdown() -->
                                    </select>
                                </div>
                                <div id="customSalesmanFields" style="display:none;grid-column:span 2;">
                                    <div class="form-grid" style="margin-bottom:0;">
                                        <div class="form-group"><label>Salesman Name</label><input type="text" id="customSalesmanName" placeholder="Full name"></div>
                                        <div class="form-group"><label>Email</label><input type="email" id="customSalesmanEmail" placeholder="email@company.com"></div>
                                        <div class="form-group"><label>Phone</label><input type="tel" id="customSalesmanPhone" placeholder="+971 XX XXX XXXX"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h2>Customer Information</h2></div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group"><label>Company / Organization <span style="color:var(--gold);font-weight:700;">*</span></label><input type="text" id="custCompany" placeholder="Company name"></div>
                                <div class="form-group"><label>Contact Person</label><input type="text" id="custName" placeholder="Full name"></div>
                                <div class="form-group"><label>Email</label><input type="email" id="custEmail" placeholder="email@company.com"></div>
                                <div class="form-group"><label>Phone</label><input type="tel" id="custPhone" placeholder="+971 XX XXX XXXX"></div>
                                <div class="form-group"><label>Tender Number <span style="font-weight:400;color:var(--gray-500);">(Optional)</span></label><input type="text" id="tenderNum" placeholder="Tender/RFQ number"></div>
                                <div class="form-group"><label>Address / Country</label><textarea id="custAddr" rows="2" placeholder="Address or country"></textarea></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h2>Terms & Conditions</h2></div>
                        <div class="card-body">
                            <div class="form-grid">
                                <div class="form-group"><label>Payment Terms</label><select id="payTerms"><option>50% Deposit, 50% on Delivery</option><option>30% / 70%</option><option>100% on Order</option></select></div>
                                <div class="form-group"><label>Delivery Terms</label><input type="text" id="deliveryTerms" value="Ex Factory" placeholder="Ex Factory, FOB, CIF, etc."></div>
                                <div class="form-group">
                                    <label>Delivery Timeline</label>
                                    <select id="deliverySelect" onchange="toggleDeliveryInput()">
                                        <option value="TBD" selected>TBD</option>
                                        <option value="60-90 Days">60-90 Days</option>
                                        <option value="90-120 Days">90-120 Days</option>
                                        <option value="custom">Custom...</option>
                                    </select>
                                    <input type="text" id="deliveryCustom" placeholder="Enter custom timeline" style="display:none;margin-top:8px;">
                                </div>
                                <div class="form-group"><label>Discount %</label><input type="number" id="discount" value="0" min="0" max="100" onchange="updateTotals()"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h2>PDF Options</h2></div>
                        <div class="card-body" style="padding:16px 22px;">
                            <div style="display:flex;flex-direction:column;gap:10px;">
                                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-weight:normal;font-size:13px;color:var(--gray-700);">
                                    <input type="checkbox" id="showCategoryTotals" style="width:16px;height:16px;min-width:16px;cursor:pointer;accent-color:var(--gold);flex-shrink:0;" onchange="togglePdfOption('category')">
                                    Show category totals on quotation page (Engine, Accessories, Electronics)
                                </label>
                                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-weight:normal;font-size:13px;color:var(--gray-700);">
                                    <input type="checkbox" id="showAllPrices" style="width:16px;height:16px;min-width:16px;cursor:pointer;accent-color:var(--gold);flex-shrink:0;" onchange="togglePdfOption('all')">
                                    Show all individual prices (on quotation and annex pages)
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h2>Notes</h2></div>
                        <div class="card-body">
                            <div class="form-group full">
                                <textarea id="quoteNotes" rows="3" placeholder="Additional notes, special requirements, or comments..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-secondary" onclick="goTo(2)">← Back to Configuration</button>
                    </div>
                </div>
                <aside>
                    <div class="summary">
                        <div class="summary-title">Order Summary</div>
                        <div class="summary-row"><span class="lbl">Subtotal</span><span class="val" id="sumSub3">$0</span></div>
                        <div class="summary-row"><span class="lbl">Discount</span><span class="val" id="sumDisc3">-$0</span></div>
                        <div class="summary-total"><span class="lbl">Grand Total</span><span class="val" id="sumTotal3">$0</span></div>
                    </div>
                    <button class="summary-next-btn" onclick="goTo(4)">
                        Preview Quotation →
                    </button>
                </aside>
            </div>
        </div>

        <!-- PAGE 4: REVIEW & EXPORT -->
        <div id="page4" class="page">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
                <div style="display:flex;align-items:center;gap:12px;">
                    <button class="btn btn-secondary" onclick="goTo(3)" style="padding:10px 18px;font-size:12px;">← Edit</button>
                    <h2 style="font-size:16px;font-weight:700;color:var(--navy);margin:0;">Quotation Preview</h2>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <button class="btn" style="background:linear-gradient(135deg,#c41230,#a00f28);color:white;border:none;padding:10px 20px;font-size:12px;" onclick="downloadPDF()">📄 Download PDF</button>
                    <button class="btn btn-outline" style="padding:10px 20px;font-size:12px;" onclick="downloadCSV()">📊 Export Excel</button>
                    <button class="btn btn-outline" style="padding:10px 20px;font-size:12px;" onclick="window.print()">🖨️ Print</button>
                </div>
            </div>
            <div class="preview" id="previewArea">
                <div class="preview-header">
                    <h1>ASIS BOATS LLC</h1>
                    <p>PROFESSIONAL QUOTATION</p>
                    <p id="prevQuoteTitle" style="font-size:18px;margin-top:10px;color:var(--white);font-weight:600;"></p>
                </div>
                <div class="preview-body">
                    <div class="preview-meta">
                        <div class="preview-meta-section">
                            <h4>Quotation Details</h4>
                            <div class="preview-meta-grid" id="prevQuoteInfo"></div>
                        </div>
                        <div class="preview-meta-section">
                            <h4>Customer Information</h4>
                            <div class="preview-meta-grid" id="prevCustInfo"></div>
                        </div>
                    </div>
                    <table class="preview-table">
                        <thead><tr><th>Description</th><th>Qty</th><th class="right">Unit Price</th><th class="right">Total</th></tr></thead>
                        <tbody id="prevItems"></tbody>
                    </table>
                    <div class="preview-totals" id="prevTotals"></div>
                    <div class="preview-notes" id="prevNotes" style="display:none;"><h4>Notes</h4><p id="prevNotesText"></p></div>
                </div>
            </div>
        </div>
    </main>

    </div><!-- /editorScreen -->

    <!-- Professional Footer -->
    <footer class="app-footer">
        <div class="app-footer-inner">
            <img src="assets/images/asis_arrow.png" class="footer-arrow" alt="">
            <div class="footer-text">© 2025 ASIS Boats L.L.C. — Jebel Ali Industrial Area 2, Dubai, UAE &nbsp;|&nbsp; Tel: +971 4 880 4441 &nbsp;|&nbsp; <a href="https://www.asisboats.com" target="_blank">www.asisboats.com</a></div>
        </div>
    </footer>

    </div><!-- /appWrapper -->

<script>
// ==================== FIREBASE CONFIG ====================
// 🔧 SETUP: Replace with your Firebase project config
// Go to: https://console.firebase.google.com → Create Project → Web App → Copy Config
const FIREBASE_CONFIG = {
    apiKey: "AIzaSyCtniLIRkuclNber8sc97tiEyx700_ZyD4",
    authDomain: "asis-quotation-system.firebaseapp.com",
    projectId: "asis-quotation-system",
    storageBucket: "asis-quotation-system.firebasestorage.app",
    messagingSenderId: "668383205730",
    appId: "1:668383205730:web:6a1598a642bcefc6bdb43b"
};

// ==================== FIREBASE INIT ====================
let db = null;
let firebaseReady = false;
let currentUser = null; // { id: 'mario', name: 'Mario Hoyek', ... }
let currentDocId = null; // Firestore document ID of currently editing quote
let allQuotations = []; // Cached list for dashboard
let dashSortField = 'updatedAt';
let dashSortDir = 'desc';
let autosaveTimer = null;
let isSaving = false;
let hasUnsavedChanges = false;
let useLocalFallback = false;

// PIN codes for each user
const SALESMAN_PINS = { mario: '4827', soufiane: '9051', toji: '1364', pierre: '1966', rana: '1996', guest: '9876' };

// User roles: 'salesman' auto-selects themselves, 'admin' sees all quotes, 'guest' can only create
const USER_ROLES = { mario: 'salesman', soufiane: 'salesman', toji: 'salesman', pierre: 'admin', rana: 'admin', guest: 'guest' };

// All users info (extends SALESMEN for non-salesman users)
const ALL_USERS = {
    mario: { name: "Mario Hoyek", email: "marioh@asisboats.com", phone: "+971 50 462 9258" },
    soufiane: { name: "Soufiane Tangi", email: "soufianet@asisboats.com", phone: "+971 50 551 2985" },
    toji: { name: "Toji Paul", email: "tojip@asisboats.com", phone: "+971 54 791 3337" },
    pierre: { name: "Pierre Nawfal", email: "", phone: "" },
    rana: { name: "Rana Nawfal", email: "", phone: "" },
    guest: { name: "Guest", email: "", phone: "" }
};

function initFirebase() {
    try {
        if (FIREBASE_CONFIG.apiKey === 'YOUR_API_KEY') {
            console.warn('Firebase not configured — using localStorage fallback');
            useLocalFallback = true;
            return;
        }
        firebase.initializeApp(FIREBASE_CONFIG);
        db = firebase.firestore();
        // Enable offline persistence (ignore errors - some browsers don't support it)
        try {
            db.enablePersistence({ synchronizeTabs: true }).catch(() => {});
        } catch(e) {}
        firebaseReady = true;
        console.log('Firebase initialized successfully');
    } catch (e) {
        console.error('Firebase init failed:', e);
        useLocalFallback = true;
    }
}
initFirebase();

// ==================== AUTH ====================
let selectedLoginUser = null;

// ==================== CUSTOM CONFIRMATION MODAL ====================
let confirmResolve = null;

function showConfirm(title, message) {
    return new Promise(resolve => {
        confirmResolve = resolve;
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        document.getElementById('confirmOverlay').classList.add('active');
    });
}

function closeConfirm(result) {
    document.getElementById('confirmOverlay').classList.remove('active');
    if (confirmResolve) {
        confirmResolve(result);
        confirmResolve = null;
    }
}

function selectLoginUser(userId, el) {
    selectedLoginUser = userId;
    document.querySelectorAll('#avatarRow .avatar-item').forEach(a => a.classList.remove('selected'));
    el.classList.add('selected');
    document.getElementById('loginPin').focus();
}

function loginUser() {
    const pin = document.getElementById('loginPin').value;
    const errorEl = document.getElementById('loginError');
    
    if (!selectedLoginUser) {
        errorEl.textContent = 'Please select your profile';
        errorEl.style.display = 'block';
        return;
    }
    if (pin !== SALESMAN_PINS[selectedLoginUser]) {
        errorEl.textContent = 'Incorrect PIN';
        errorEl.style.display = 'block';
        return;
    }
    
    errorEl.style.display = 'none';
    currentUser = { id: selectedLoginUser, role: USER_ROLES[selectedLoginUser], ...ALL_USERS[selectedLoginUser] };
    localStorage.setItem('asis_user', JSON.stringify(currentUser));
    
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appWrapper').classList.add('visible');
    showDashboard();
}

function logoutUser() {
    if (hasUnsavedChanges && !confirm('You have unsaved changes. Sign out anyway?')) return;
    currentUser = null;
    currentDocId = null;
    selectedLoginUser = null;
    localStorage.removeItem('asis_user');
    document.getElementById('appWrapper').classList.remove('visible');
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('loginPin').value = '';
    document.getElementById('loginError').style.display = 'none';
    document.querySelectorAll('#avatarRow .avatar-item').forEach(a => a.classList.remove('selected'));
}

function checkAutoLogin() {
    const saved = localStorage.getItem('asis_user');
    if (saved) {
        try {
            currentUser = JSON.parse(saved);
            // Validate it's still a valid salesman
            if (ALL_USERS[currentUser.id]) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appWrapper').classList.add('visible');
                showDashboard();
                return;
            }
        } catch(e) {}
    }
    // Show login
    document.getElementById('loginScreen').style.display = 'flex';
}

// ==================== DASHBOARD ====================
function showDashboard() {
    document.getElementById('dashboardScreen').style.display = 'block';
    document.getElementById('dashboardScreen').classList.add('active');
    document.getElementById('editorScreen').style.display = 'none';
    document.getElementById('dashUserName').textContent = currentUser.name;
    document.getElementById('dashTitle').textContent = currentUser.role === 'admin' ? '📋 All Quotations' : '📋 My Quotations';
    // Show salesman filter only for admins
    const salesmanFilter = document.getElementById('dashSalesmanFilter');
    if (salesmanFilter) salesmanFilter.style.display = currentUser.role === 'admin' ? '' : 'none';
    currentDocId = null;
    hasUnsavedChanges = false;
    loadAllQuotations();
}

function backToDashboard() {
    if (hasUnsavedChanges) {
        // Auto-save before leaving
        saveQuotationToCloud().then(() => {
            showDashboard();
        }).catch(() => {
            if (confirm('Could not save. Return to dashboard anyway?')) showDashboard();
        });
    } else {
        showDashboard();
    }
}

async function loadAllQuotations() {
    if (useLocalFallback) {
        loadFromLocalStorage();
        return;
    }
    
    try {
        let snapshot;
        if (currentUser.role === 'admin') {
            // Admins see ALL quotations from everyone
            snapshot = await db.collection('quotations').get();
        } else {
            // Salesmen and guests see only their own
            snapshot = await db.collection('quotations')
                .where('salesmanId', '==', currentUser.id)
                .get();
        }
        
        allQuotations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        // Sort by updatedAt descending (newest first)
        allQuotations.sort((a, b) => {
            const aTime = a.updatedAt?.toDate ? a.updatedAt.toDate() : new Date(a.updatedAt || 0);
            const bTime = b.updatedAt?.toDate ? b.updatedAt.toDate() : new Date(b.updatedAt || 0);
            return bTime - aTime;
        });
        renderDashboard();
    } catch(e) {
        console.error('Error loading quotations:', e);
        showToast('Cloud load failed — using local backup', 'warning', 3000);
        loadFromLocalStorage();
    }
}

function loadFromLocalStorage() {
    const stored = localStorage.getItem('asis_quotations_' + currentUser.id);
    allQuotations = stored ? JSON.parse(stored) : [];
    renderDashboard();
}

function saveToLocalStorage() {
    if (currentUser) {
        const forStorage = allQuotations.map(q => ({...q}));
        localStorage.setItem('asis_quotations_' + currentUser.id, JSON.stringify(forStorage));
    }
}

function renderDashboard() {
    const isAdmin = currentUser.role === 'admin';
    const colSpan = isAdmin ? 8 : 7;
    
    // Show/hide Created By column
    const thCreatedBy = document.getElementById('thCreatedBy');
    if (thCreatedBy) thCreatedBy.style.display = isAdmin ? '' : 'none';
    
    let filtered = [...allQuotations];
    
    // Apply search filter
    const search = (document.getElementById('dashSearch')?.value || '').toLowerCase().trim();
    if (search) {
        filtered = filtered.filter(q => 
            (q.quoteNumber || '').toLowerCase().includes(search) ||
            (q.customerCompany || '').toLowerCase().includes(search) ||
            (q.customerName || '').toLowerCase().includes(search) ||
            (q.title || '').toLowerCase().includes(search) ||
            (q.boatType || '').toLowerCase().includes(search) ||
            (q.boatSize || '').toLowerCase().includes(search) ||
            (isAdmin && (q.salesmanName || '').toLowerCase().includes(search))
        );
    }
    
    // Status filter
    const statusFilter = document.getElementById('dashStatusFilter')?.value;
    if (statusFilter) filtered = filtered.filter(q => q.status === statusFilter);
    
    // Salesman filter (admin only)
    const salesmanFilter = document.getElementById('dashSalesmanFilter')?.value;
    if (salesmanFilter) filtered = filtered.filter(q => (q.salesmanId || '') === salesmanFilter);
    
    // Amount filter
    const amountFilter = document.getElementById('dashAmountFilter')?.value;
    if (amountFilter) {
        const [min, max] = amountFilter.split('-').map(Number);
        filtered = filtered.filter(q => {
            const amt = q.totalAmountUSD || 0;
            if (max === 0) return amt >= min; // "Over X"
            return amt >= min && amt <= max;
        });
    }
    
    // Date filter
    const dateFilter = document.getElementById('dashDateFilter')?.value;
    if (dateFilter) {
        const days = parseInt(dateFilter);
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        filtered = filtered.filter(q => {
            const d = q.updatedAt?.toDate ? q.updatedAt.toDate() : new Date(q.updatedAt);
            return d >= cutoff;
        });
    }
    
    // Sort
    filtered.sort((a, b) => {
        let aVal = a[dashSortField], bVal = b[dashSortField];
        // Handle timestamps
        if (dashSortField === 'updatedAt' || dashSortField === 'createdAt') {
            aVal = aVal?.toDate ? aVal.toDate() : new Date(aVal || 0);
            bVal = bVal?.toDate ? bVal.toDate() : new Date(bVal || 0);
        }
        if (dashSortField === 'totalAmountUSD') {
            aVal = aVal || 0; bVal = bVal || 0;
        }
        if (aVal < bVal) return dashSortDir === 'asc' ? -1 : 1;
        if (aVal > bVal) return dashSortDir === 'asc' ? 1 : -1;
        return 0;
    });
    
    // Update stats
    document.getElementById('statTotal').textContent = allQuotations.length;
    document.getElementById('statDrafts').textContent = allQuotations.filter(q => q.status === 'draft').length;
    document.getElementById('statSent').textContent = allQuotations.filter(q => q.status === 'sent').length;
    const totalVal = allQuotations.reduce((s, q) => s + (q.totalAmountUSD || 0), 0);
    document.getElementById('statValue').textContent = '$' + totalVal.toLocaleString('en-US', {maximumFractionDigits:0});
    
    // Render table
    const tbody = document.getElementById('dashTableBody');
    if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${colSpan}" class="dash-empty">
            <h3>${allQuotations.length === 0 ? 'No quotations yet' : 'No matching results'}</h3>
            <p>${allQuotations.length === 0 ? 'Click "New Quotation" to create your first quote' : 'Try adjusting your filters'}</p>
        </td></tr>`;
        return;
    }
    
    tbody.innerHTML = filtered.map(q => {
        const date = q.updatedAt?.toDate ? q.updatedAt.toDate() : new Date(q.updatedAt || Date.now());
        const dateStr = date.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
        const timeStr = date.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit' });
        const amt = q.totalAmountUSD ? '$' + q.totalAmountUSD.toLocaleString('en-US', {maximumFractionDigits:0}) : '-';
        const boatLabel = q.boatSize ? `${q.boatSize} ${(q.boatType || '').charAt(0).toUpperCase() + (q.boatType || '').slice(1)}` : '-';
        const createdByCol = isAdmin ? `<td>${q.salesmanName || '<span style="color:var(--gray-400)">-</span>'}</td>` : '';
        
        return `<tr ondblclick="loadQuotation('${q.id}')">
            <td><strong>${q.quoteNumber || 'Untitled'}</strong></td>
            <td>${q.customerCompany || '<span style="color:var(--gray-400)">No customer</span>'}</td>
            <td>${boatLabel}</td>
            <td style="font-weight:600;">${amt}</td>
            ${createdByCol}
            <td><span class="status-badge status-${q.status || 'draft'}">${q.status || 'draft'}</span></td>
            <td>${dateStr}<br><span style="color:var(--gray-400);font-size:11px;">${timeStr}</span></td>
            <td class="dash-actions" onclick="event.stopPropagation()">
                <button onclick="loadQuotation('${q.id}')" title="Edit">✏️</button>
                <button onclick="duplicateQuotation('${q.id}')" title="Duplicate">📋</button>
                <select class="status-select" onchange="updateQuoteStatus('${q.id}', this.value)" title="Change status">
                    <option value="draft" ${q.status==='draft'?'selected':''}>Draft</option>
                    <option value="sent" ${q.status==='sent'?'selected':''}>Sent</option>
                    <option value="accepted" ${q.status==='accepted'?'selected':''}>Accepted</option>
                    <option value="expired" ${q.status==='expired'?'selected':''}>Expired</option>
                </select>
                <button class="danger" onclick="deleteQuotation('${q.id}')" title="Delete">🗑️</button>
            </td>
        </tr>`;
    }).join('');
}

function sortDashboard(field) {
    if (dashSortField === field) {
        dashSortDir = dashSortDir === 'asc' ? 'desc' : 'asc';
    } else {
        dashSortField = field;
        dashSortDir = field === 'updatedAt' ? 'desc' : 'asc';
    }
    renderDashboard();
}

// ==================== CLOUD SAVE / LOAD ====================
function serializeQuotation() {
    const size = getSelectedSize();
    const boatQty = parseInt(document.getElementById('boatQty')?.value) || 1;
    
    // Calculate total in USD (always, for querying)
    const basePerBoat = state.boatType && state.sizeIdx !== null ? BOATS[state.boatType].sizes[state.sizeIdx].price : 0;
    let optionsPerBoat = 0;
    Object.values(state.items).forEach(catItems => {
        Object.values(catItems).forEach(item => {
            if (item.price && item.qty && !item.isTBD) optionsPerBoat += item.price * item.qty;
        });
    });
    const subtotal = (basePerBoat + optionsPerBoat) * boatQty;
    const discountPct = parseFloat(document.getElementById('discount')?.value) || 0;
    const totalUSD = subtotal * (1 - discountPct / 100);
    
    return {
        // Queryable top-level fields
        quoteNumber: document.getElementById('quoteNum')?.value || '',
        title: document.getElementById('quoteTitle')?.value || '',
        salesmanId: currentUser.id,
        salesmanName: currentUser.name,
        status: currentDocId ? (allQuotations.find(q => q.id === currentDocId)?.status || 'draft') : 'draft',
        totalAmountUSD: Math.round(totalUSD),
        currency: state.currency,
        boatType: state.boatType || '',
        boatSize: size || '',
        customerCompany: document.getElementById('custCompany')?.value || '',
        customerName: document.getElementById('custName')?.value || '',
        createdAt: currentDocId ? (allQuotations.find(q => q.id === currentDocId)?.createdAt || new Date()) : new Date(),
        updatedAt: new Date(),
        
        // Full state blob for restoring the editor
        fullState: JSON.stringify({
            state: state,
            itemCounter: itemCounter,
            form: {
                quoteTitle: document.getElementById('quoteTitle')?.value || '',
                quoteNum: document.getElementById('quoteNum')?.value || 'ASIS-25-0001',
                boatQty: document.getElementById('boatQty')?.value || '1',
                quoteDate: document.getElementById('quoteDate')?.value || '',
                validity: document.getElementById('validity')?.value || '30 Days',
                salesman: document.getElementById('salesman')?.value || '',
                custCompany: document.getElementById('custCompany')?.value || '',
                custName: document.getElementById('custName')?.value || '',
                custEmail: document.getElementById('custEmail')?.value || '',
                custPhone: document.getElementById('custPhone')?.value || '',
                tenderNum: document.getElementById('tenderNum')?.value || '',
                custAddr: document.getElementById('custAddr')?.value || '',
                payTerms: document.getElementById('payTerms')?.value || '',
                deliveryTerms: document.getElementById('deliveryTerms')?.value || '',
                deliverySelect: document.getElementById('deliverySelect')?.value || 'TBD',
                deliveryCustom: document.getElementById('deliveryCustom')?.value || '',
                discount: document.getElementById('discount')?.value || '0',
                quoteNotes: document.getElementById('quoteNotes')?.value || '',
                showCategoryTotals: document.getElementById('showCategoryTotals')?.checked || false,
                showAllPrices: document.getElementById('showAllPrices')?.checked || false,
                customSalesmanName: document.getElementById('customSalesmanName')?.value || '',
                customSalesmanEmail: document.getElementById('customSalesmanEmail')?.value || '',
                customSalesmanPhone: document.getElementById('customSalesmanPhone')?.value || '',
            }
        })
    };
}

function deserializeQuotation(data) {
    const full = JSON.parse(data.fullState);
    
    // Restore core state
    state.boatType = full.state.boatType;
    state.sizeIdx = full.state.sizeIdx;
    state.currency = full.state.currency;
    state.items = full.state.items || {};
    state.allExpanded = full.state.allExpanded !== undefined ? full.state.allExpanded : true;
    itemCounter = full.itemCounter || 0;
    
    // Restore form fields
    const f = full.form;
    document.getElementById('quoteTitle').value = f.quoteTitle || '';
    document.getElementById('quoteNum').value = f.quoteNum || 'ASIS-25-0001';
    document.getElementById('quoteBadgeInput').value = f.quoteNum || 'ASIS-25-0001';
    document.getElementById('boatQty').value = f.boatQty || '1';
    document.getElementById('quoteDate').value = f.quoteDate || new Date().toISOString().split('T')[0];
    document.getElementById('validity').value = f.validity || '30 Days';
    populateSalesmanDropdown();
    document.getElementById('salesman').value = f.salesman || '';
    document.getElementById('custCompany').value = f.custCompany || '';
    document.getElementById('custName').value = f.custName || '';
    document.getElementById('custEmail').value = f.custEmail || '';
    document.getElementById('custPhone').value = f.custPhone || '';
    document.getElementById('tenderNum').value = f.tenderNum || '';
    document.getElementById('custAddr').value = f.custAddr || '';
    document.getElementById('payTerms').value = f.payTerms || '50% Deposit, 50% on Delivery';
    document.getElementById('deliveryTerms').value = f.deliveryTerms || 'Ex Factory';
    document.getElementById('deliverySelect').value = f.deliverySelect || 'TBD';
    document.getElementById('discount').value = f.discount || '0';
    document.getElementById('quoteNotes').value = f.quoteNotes || '';
    document.getElementById('showCategoryTotals').checked = f.showCategoryTotals || false;
    document.getElementById('showAllPrices').checked = f.showAllPrices || false;
    document.getElementById('customSalesmanName').value = f.customSalesmanName || '';
    document.getElementById('customSalesmanEmail').value = f.customSalesmanEmail || '';
    document.getElementById('customSalesmanPhone').value = f.customSalesmanPhone || '';
    
    // Handle custom salesman visibility
    const customFields = document.getElementById('customSalesmanFields');
    if (f.salesman === 'custom') {
        customFields.style.display = 'block';
    } else {
        customFields.style.display = 'none';
    }
    
    // Handle custom delivery
    const dc = document.getElementById('deliveryCustom');
    if (f.deliverySelect === 'custom') {
        dc.style.display = 'block';
        dc.value = f.deliveryCustom || '';
    } else {
        dc.style.display = 'none';
    }
    
    // Restore currency buttons
    document.querySelectorAll('.curr-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.curr-btn').forEach(b => {
        if (b.textContent === state.currency) b.classList.add('active');
    });
    
    // Rebuild UI
    renderBoatTypes();
    if (state.boatType) {
        document.getElementById('sizesCard').style.display = 'block';
        renderBoatSizes();
        document.getElementById('nextBtn1').disabled = !(state.boatType && state.sizeIdx !== null);
    }
    updateTotals();
}

async function saveQuotationToCloud(silent = false) {
    if (isSaving) return;
    isSaving = true;
    updateCloudStatus('saving');
    
    const data = serializeQuotation();
    
    try {
        if (useLocalFallback) {
            // localStorage fallback
            if (!currentDocId) {
                currentDocId = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
                data.id = currentDocId;
                data.createdAt = new Date().toISOString();
                data.updatedAt = new Date().toISOString();
                allQuotations.unshift(data);
            } else {
                data.id = currentDocId;
                data.updatedAt = new Date().toISOString();
                const idx = allQuotations.findIndex(q => q.id === currentDocId);
                if (idx >= 0) allQuotations[idx] = data;
                else allQuotations.unshift(data);
            }
            saveToLocalStorage();
        } else {
            // Firestore
            if (currentDocId) {
                data.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                await db.collection('quotations').doc(currentDocId).set(data, { merge: true });
            } else {
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                data.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                const docRef = await db.collection('quotations').add(data);
                currentDocId = docRef.id;
            }
        }
        
        hasUnsavedChanges = false;
        updateCloudStatus('saved');
        if (!silent) showToast('Quotation saved', 'success', 2000);
    } catch(e) {
        console.error('Save failed:', e);
        updateCloudStatus('error');
        // Try localStorage backup
        try {
            localStorage.setItem('asis_backup_' + (currentDocId || 'new'), JSON.stringify(data));
        } catch(e2) {}
        if (!silent) showToast('Save failed — backed up locally', 'warning', 3000);
    } finally {
        isSaving = false;
    }
}

async function loadQuotation(docId) {
    let data;
    
    if (useLocalFallback) {
        data = allQuotations.find(q => q.id === docId);
    } else {
        try {
            const doc = await db.collection('quotations').doc(docId).get();
            if (!doc.exists) { showToast('Quotation not found', 'error'); return; }
            data = { id: doc.id, ...doc.data() };
        } catch(e) {
            console.error('Load failed:', e);
            showToast('Failed to load quotation', 'error');
            return;
        }
    }
    
    if (!data || !data.fullState) {
        showToast('Quotation data is corrupted', 'error');
        return;
    }
    
    currentDocId = docId;
    showEditor();
    deserializeQuotation(data);
    hasUnsavedChanges = false;
    updateCloudStatus('saved');
    goTo(2); // Go to Step 2 (Configuration) to prevent accidental reset in Step 1
    showToast('Quotation loaded: ' + (data.quoteNumber || docId), 'info', 2500);
}

async function duplicateQuotation(docId) {
    const source = allQuotations.find(q => q.id === docId);
    if (!source) return;
    
    const newData = { ...source };
    delete newData.id;
    newData.quoteNumber = (source.quoteNumber || 'ASIS') + '-COPY';
    newData.status = 'draft';
    newData.title = (source.title || '') + ' (Copy)';
    
    // Update the fullState too
    const fullState = JSON.parse(newData.fullState);
    fullState.form.quoteNum = newData.quoteNumber;
    fullState.form.quoteTitle = newData.title;
    newData.fullState = JSON.stringify(fullState);
    
    try {
        if (useLocalFallback) {
            newData.id = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
            newData.createdAt = new Date().toISOString();
            newData.updatedAt = new Date().toISOString();
            allQuotations.unshift(newData);
            saveToLocalStorage();
        } else {
            newData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            newData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
            await db.collection('quotations').add(newData);
            await loadAllQuotations();
        }
        renderDashboard();
        showToast('Quotation duplicated', 'success', 2000);
    } catch(e) {
        showToast('Failed to duplicate', 'error');
    }
}

async function deleteQuotation(docId) {
    if (!confirm('Delete this quotation permanently?')) return;
    
    try {
        if (useLocalFallback) {
            allQuotations = allQuotations.filter(q => q.id !== docId);
            saveToLocalStorage();
        } else {
            await db.collection('quotations').doc(docId).delete();
            allQuotations = allQuotations.filter(q => q.id !== docId);
        }
        renderDashboard();
        showToast('Quotation deleted', 'success', 2000);
    } catch(e) {
        showToast('Failed to delete', 'error');
    }
}

async function updateQuoteStatus(docId, newStatus) {
    try {
        if (useLocalFallback) {
            const q = allQuotations.find(q => q.id === docId);
            if (q) { q.status = newStatus; q.updatedAt = new Date().toISOString(); }
            saveToLocalStorage();
        } else {
            await db.collection('quotations').doc(docId).update({ 
                status: newStatus, 
                updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
            });
            const q = allQuotations.find(q => q.id === docId);
            if (q) q.status = newStatus;
        }
        renderDashboard();
    } catch(e) {
        showToast('Failed to update status', 'error');
    }
}

// ==================== CLOUD STATUS UI ====================
function updateCloudStatus(status) {
    const dot = document.getElementById('cloudDot');
    const text = document.getElementById('cloudText');
    if (!dot || !text) return;
    
    dot.className = 'dot ' + status;
    const labels = { saved: 'Saved ☁️', saving: 'Saving...', error: 'Save failed', offline: 'Offline' };
    text.textContent = labels[status] || status;
}

// ==================== AUTOSAVE ====================
function triggerAutosave() {
    // Don't autosave if there's no meaningful content yet
    if (!state.boatType && !document.getElementById('custCompany')?.value) return;
    
    hasUnsavedChanges = true;
    updateCloudStatus('saving');
    
    if (autosaveTimer) clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(() => {
        if (currentUser && document.getElementById('editorScreen').style.display !== 'none') {
            saveQuotationToCloud(true); // silent save
        }
    }, 3000); // Save 3 seconds after last change
}

// ==================== EDITOR NAVIGATION ====================
function showEditor() {
    document.getElementById('dashboardScreen').style.display = 'none';
    document.getElementById('dashboardScreen').classList.remove('active');
    document.getElementById('editorScreen').style.display = 'block';
}

function startNewEditor() {
    currentDocId = null;
    hasUnsavedChanges = false;
    showEditor();
    
    // Reset everything
    state.boatType = null;
    state.sizeIdx = null;
    state.items = {};
    state.currency = 'USD';
    itemCounter = 0;
    
    document.getElementById('quoteTitle').value = '';
    document.getElementById('quoteNum').value = 'ASIS-25-0001';
    document.getElementById('quoteBadgeInput').value = 'ASIS-25-0001';
    document.getElementById('boatQty').value = '1';
    document.getElementById('quoteDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('discount').value = '0';
    document.getElementById('custCompany').value = '';
    document.getElementById('custName').value = '';
    document.getElementById('custEmail').value = '';
    document.getElementById('custPhone').value = '';
    document.getElementById('tenderNum').value = '';
    document.getElementById('custAddr').value = '';
    document.getElementById('quoteNotes').value = '';
    // Populate salesman dropdown based on role
    populateSalesmanDropdown();
    document.getElementById('customSalesmanFields').style.display = 'none';
    document.getElementById('customSalesmanName').value = '';
    document.getElementById('customSalesmanEmail').value = '';
    document.getElementById('customSalesmanPhone').value = '';
    document.getElementById('deliveryTerms').value = 'Ex Factory';
    document.getElementById('deliverySelect').value = 'TBD';
    const dc = document.getElementById('deliveryCustom');
    if (dc) { dc.style.display = 'none'; dc.value = ''; }
    document.getElementById('showCategoryTotals').checked = false;
    document.getElementById('showAllPrices').checked = false;
    document.getElementById('validity').value = '30 Days';
    document.getElementById('payTerms').value = '50% Deposit, 50% on Delivery';
    
    // Reset currency
    document.querySelectorAll('.curr-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.curr-btn').forEach(b => { if (b.textContent === 'USD') b.classList.add('active'); });
    
    renderBoatTypes();
    document.getElementById('sizesCard').style.display = 'none';
    document.getElementById('nextBtn1').disabled = true;
    updateTotals();
    goTo(1);
    updateCloudStatus('saved');
}

// ==================== DATA FROM EXCEL ====================
const BOATS = {
    aluminum: {
        name: 'Aluminium Boats', 
        desc: 'Professional-grade aluminum hull RHIBs', 
        icon: '🚤',
        sizes: [
            {size:'6.5M', price:103090, fuel:'150L', pax:8},
            {size:'7.6M', price:120030, fuel:'450L', pax:10},
            {size:'8.5M', price:149800, fuel:'600L', pax:12},
            {size:'9.5M', price:180765, fuel:'600L', pax:14},
            {size:'11.5M', price:246770, fuel:'1200L', pax:18},
            {size:'13M', price:289475, fuel:'1100L', pax:20}
        ]
    },
    fiberglass: {
        name: 'Fiberglass Boats (GRP)', 
        desc: 'Versatile GRP construction RHIBs', 
        icon: '⛵',
        sizes: [
            {size:'4.1M', price:22900, fuel:'N/A', pax:4},
            {size:'5.1M', price:33560, fuel:'90L', pax:6},
            {size:'5.5M', price:35000, fuel:'90L', pax:6},
            {size:'6.5M', price:53040, fuel:'225L', pax:8},
            {size:'7.2M', price:56850, fuel:'225L', pax:10},
            {size:'8.0M', price:66560, fuel:'225L', pax:12},
            {size:'8.5M', price:83200, fuel:'225L', pax:14},
            {size:'9.5M', price:130080, fuel:'2x350L', pax:16},
            {size:'12M', price:160960, fuel:'2x300L', pax:20}
        ]
    },
    inflatable: {
        name: 'Inflatable Boats (HDIB)', 
        desc: 'Heavy Duty Inflatable Boats', 
        icon: '🛟',
        sizes: [
            {size:'2.8M', price:8300, fuel:'N/A', pax:3},
            {size:'3.2M', price:9800, fuel:'N/A', pax:4},
            {size:'3.5M', price:10800, fuel:'N/A', pax:5},
            {size:'4.2M', price:12600, fuel:'N/A', pax:6},
            {size:'4.8M', price:15700, fuel:'N/A', pax:7},
            {size:'5.1M', price:16900, fuel:'N/A', pax:8}
        ]
    }
};

// Accessories by boat type - from Excel price list
// Each item has prices object keyed by size, with values: number, "X" (unavailable), "TBD", or "Incl."
// Define which categories are EXCLUSIVE (radio buttons - only one selection allowed)
const EXCLUSIVE_CATEGORIES = [
    "Propulsion / Engine",
    "Cabin / T-Top",
    "Leaning Posts",
    "A-Frame",
    "Life Jackets",
    "Trailers",
    "GPS",
    "Radar",
    "VHF",
    "FLIR / Thermal"
];

// Categories that are exclusive but need quantity input
const EXCLUSIVE_WITH_QTY = ["Life Jackets"];

// Items that are mutually exclusive within their category (can be deselected)
const ANCHOR_ITEMS = [
    "Aluminium Anchor with S.S Chain",
    "Aluminium Anchor with Rope 30m",
    "Windless Clipper with S.S Chain & Anchor"
];

// Console/Cabin/T-Top constraint classification
// Instead of matching long item names, each item carries a 'tag' property: 'console', 'ttop', or 'cabin'
// The tag is set inline in the ACCESSORIES data below.
// Helper to classify an item by its tag
function getItemConstraintTag(boatType, category, itemIdx) {
    const item = ACCESSORIES[boatType]?.[category]?.[itemIdx];
    return item?.tag || null;
}

// Get constraint tag from a state item (handles custom items too)
function getStateItemTag(category, stateItem) {
    if (!stateItem || stateItem.itemIdx === -1) return null;
    if (stateItem.isCustom) return null; // custom items have no constraint
    return ACCESSORIES[state.boatType]?.[category]?.[stateItem.itemIdx]?.tag || null;
}

const ACCESSORIES = {
    aluminum: {
        "Propulsion / Engine": [
            {name: "Single Mercury F150Hp EXLPT (incl. controls, steering, gauges)", prices: {"6.5M":18620,"7.6M":"X","8.5M":"X","9.5M":"X","11.5M":"X","13M":"X"}},
            {name: "Twin Mercury F150Hp XLPT/CXLPT (incl. controls, steering, gauges)", prices: {"6.5M":"X","7.6M":34255,"8.5M":"X","9.5M":"X","11.5M":"X","13M":"X"}},
            {name: "Twin Mercury Verado F300 V8 XL/CXL (DTS, Vessel View 502)", prices: {"6.5M":"X","7.6M":"X","8.5M":68975,"9.5M":68975,"11.5M":68975,"13M":"X"}},
            {name: "Twin Mercury F400 V10 XL/CXL (DTS, Vessel View 502)", prices: {"6.5M":"X","7.6M":"X","8.5M":"X","9.5M":103120,"11.5M":103120,"13M":103120}},
            {name: "Triple Mercury Verado F300 V8 XL/CXL (DTS, Vessel View 702)", prices: {"6.5M":"X","7.6M":"X","8.5M":"X","9.5M":"X","11.5M":"X","13M":114950}},
            {name: "Triple Mercury F400 V10 XL/CXL (DTS, Vessel View 502)", prices: {"6.5M":"X","7.6M":"X","8.5M":"X","9.5M":"X","11.5M":"X","13M":166180}}
        ],
        "General": [
            {name: "Boat Painting", prices: {"6.5M":17000,"7.6M":20000,"8.5M":22000,"9.5M":25500,"11.5M":30000,"13M":32000}},
            {name: "Custom Color Hypalon", prices: {"6.5M":2500,"7.6M":3000,"8.5M":3500,"9.5M":4000,"11.5M":4500,"13M":5000}},
            {name: "Double Layer Hypalon", prices: {"6.5M":15340,"7.6M":17500,"8.5M":20000,"9.5M":22420,"11.5M":27000,"13M":28320}},
            {name: "Hypalon Strip Between Fender", prices: {"6.5M":5000,"7.6M":6000,"8.5M":6880,"9.5M":7700,"11.5M":9300,"13M":9720}},
            {name: "Hypalon Branding And Numbering", prices: {"6.5M":700,"7.6M":800,"8.5M":900,"9.5M":1000,"11.5M":1100,"13M":1100}},
            {name: "Extra Handle", prices: {"6.5M":250,"7.6M":250,"8.5M":250,"9.5M":250,"11.5M":250,"13M":250}},
            {name: "Diver-Notch", prices: {"6.5M":9800,"7.6M":9800,"8.5M":9800,"9.5M":9800,"11.5M":9800,"13M":9800}},
            {name: "Notch Filling Inserts", prices: {"6.5M":2500,"7.6M":2500,"8.5M":2500,"9.5M":2500,"11.5M":3500,"13M":3500}},
            {name: "Bow Step with 2 Stainless Steel Cleats", prices: {"6.5M":545,"7.6M":545,"8.5M":545,"9.5M":545,"11.5M":545,"13M":545}},
            {name: "Aluminium Anchor with S.S Chain", prices: {"6.5M":1075,"7.6M":1075,"8.5M":1075,"9.5M":1075,"11.5M":1075,"13M":1075}},
            {name: "Aluminium Anchor with Rope 30m", prices: {"6.5M":390,"7.6M":390,"8.5M":390,"9.5M":390,"11.5M":390,"13M":390}},
            {name: "Windless Clipper with S.S Chain & Anchor", prices: {"6.5M":5360,"7.6M":5360,"8.5M":5360,"9.5M":5360,"11.5M":5360,"13M":5360}},
            {name: "Boat Cover", prices: {"6.5M":2500,"7.6M":4000,"8.5M":4500,"9.5M":5000,"11.5M":5500,"13M":5500}}
        ],
        "Console": [
            {name: "Aluminium Console with Windscreen and Grab Rail", tag: "console", prices: {"6.5M":10115,"7.6M":10115,"8.5M":10500,"9.5M":11200,"11.5M":12000,"13M":12000}}
        ],
        "Cabin / T-Top": [
            {name: "Aluminum Cabin with Cuddy and Toilet", tag: "cabin", prices: {"6.5M":"X","7.6M":"X","8.5M":"X","9.5M":79570,"11.5M":79570,"13M":79570}},
            {name: "Aluminum Cabin for 4 Pax", tag: "cabin", prices: {"6.5M":"X","7.6M":"X","8.5M":"X","9.5M":"TBD","11.5M":"TBD","13M":"TBD"}},
            {name: "Aluminum Wheel-house", tag: "cabin", prices: {"6.5M":19115,"7.6M":19115,"8.5M":21000,"9.5M":21000,"11.5M":24000,"13M":24000}},
            {name: "Aluminium T-Top with Hard Top 1 (2.7m)", tag: "ttop", prices: {"6.5M":12560,"7.6M":12560,"8.5M":12560,"9.5M":12560,"11.5M":12560,"13M":12560}},
            {name: "Aluminium T-Top with Hard Top 2 (3.8m)", tag: "ttop", prices: {"6.5M":14920,"7.6M":14920,"8.5M":14920,"9.5M":14920,"11.5M":14920,"13M":14920}},
            {name: "Aluminium T-Top with Hard Top 3 (4.4m)", tag: "ttop", prices: {"6.5M":"X","7.6M":"X","8.5M":"X","9.5M":"X","11.5M":32000,"13M":32000}}
        ],
        "Leaning Posts": [
            {name: "Aluminium Leaning Post Single", prices: {"6.5M":2765,"7.6M":2765,"8.5M":2765,"9.5M":2765,"11.5M":2765,"13M":2765}},
            {name: "Aluminium Leaning Post with Back Rest Single", prices: {"6.5M":3310,"7.6M":3310,"8.5M":3310,"9.5M":3310,"11.5M":3310,"13M":3310}},
            {name: "Aluminium Leaning Post Double", prices: {"6.5M":3400,"7.6M":3400,"8.5M":3400,"9.5M":3400,"11.5M":3400,"13M":3400}},
            {name: "Aluminium Leaning Post with Back Rest Double", prices: {"6.5M":4000,"7.6M":4000,"8.5M":4000,"9.5M":4000,"11.5M":4000,"13M":4000}}
        ],
        "Jockey & Grab Rail": [
            {name: "Grab Rail for Front Seat", prices: {"6.5M":650,"7.6M":650,"8.5M":650,"9.5M":650,"11.5M":650,"13M":650}},
            {name: "Single Aluminium Jockey Seat with Grab Rail", prices: {"6.5M":1270,"7.6M":1270,"8.5M":1270,"9.5M":1270,"11.5M":1270,"13M":1270}},
            {name: "Double Aluminium Jockey Seat with Grab Rail", prices: {"6.5M":2535,"7.6M":2535,"8.5M":2535,"9.5M":2535,"11.5M":2535,"13M":2535}}
        ],
        "Suspension Seats": [
            {name: "Ullman BISCAYA Jockey Suspension Seat", prices: {"6.5M":5500,"7.6M":5500,"8.5M":5500,"9.5M":5500,"11.5M":5500,"13M":5500}},
            {name: "Ullman Patrol Jockey Suspension Seat", prices: {"6.5M":6250,"7.6M":6250,"8.5M":6250,"9.5M":6250,"11.5M":6250,"13M":6250}},
            {name: "Echelon Midback Jockey Suspension Seat", prices: {"6.5M":16300,"7.6M":16300,"8.5M":16300,"9.5M":16300,"11.5M":16300,"13M":16300}}
        ],
        "A-Frame": [
            {name: "Aluminium A Frame", prices: {"6.5M":2885,"7.6M":2885,"8.5M":2885,"9.5M":2885,"11.5M":3260,"13M":3260}},
            {name: "Aluminium A Frame With Self-righting System", prices: {"6.5M":9730,"7.6M":9730,"8.5M":9730,"9.5M":9730,"11.5M":10140,"13M":10140}},
            {name: "Aluminium A Frame with Ladder", prices: {"6.5M":4300,"7.6M":4300,"8.5M":4300,"9.5M":4300,"11.5M":4675,"13M":4675}}
        ],
        "Other Frames & Structure": [
            {name: "Aluminium Tube Ladder", prices: {"6.5M":2500,"7.6M":2500,"8.5M":2500,"9.5M":2500,"11.5M":2500,"13M":2500}},
            {name: "Swim Platform at Transom for Inboard Engine", prices: {"6.5M":1285,"7.6M":1285,"8.5M":1285,"9.5M":1285,"11.5M":1285,"13M":1285}},
            {name: "Aluminium Bow Tow Post", prices: {"6.5M":2230,"7.6M":2230,"8.5M":2230,"9.5M":2230,"11.5M":2230,"13M":2230}},
            {name: "Aluminium Aft Tow Post", prices: {"6.5M":2230,"7.6M":2230,"8.5M":2230,"9.5M":2230,"11.5M":2230,"13M":2230}},
            {name: "Aluminium Bollard", prices: {"6.5M":835,"7.6M":835,"8.5M":835,"9.5M":835,"11.5M":835,"13M":835}},
            {name: "Bow HD Tow Post w/Weapons Mount Flange", prices: {"6.5M":7000,"7.6M":7000,"8.5M":7000,"9.5M":7000,"11.5M":7000,"13M":7000}},
            {name: "Aft HD Tow Post w/Weapons Mount Flange", prices: {"6.5M":7000,"7.6M":7000,"8.5M":7000,"9.5M":7000,"11.5M":7000,"13M":7000}}
        ],
        "Life Jackets": [
            {name: "Life Jacket SOLAS Foam with Flashlight 170N", prices: {"6.5M":85,"7.6M":85,"8.5M":85,"9.5M":85,"11.5M":85,"13M":85}},
            {name: "Life Jacket Manual Inflatable 170N", prices: {"6.5M":120,"7.6M":120,"8.5M":120,"9.5M":120,"11.5M":120,"13M":120}}
        ],
        "Other Safety": [
            {name: "Distress Signal Kit for Coastal Navigation", prices: {"6.5M":200,"7.6M":200,"8.5M":200,"9.5M":200,"11.5M":200,"13M":200}},
            {name: "2x Fire Extinguisher (2Kg) IAW COLREGS", prices: {"6.5M":300,"7.6M":300,"8.5M":300,"9.5M":300,"11.5M":300,"13M":300}},
            {name: "2x 20\" USCG Approved Ring Buoy IAW COLREGS", prices: {"6.5M":160,"7.6M":160,"8.5M":160,"9.5M":160,"11.5M":160,"13M":160}},
            {name: "2x Mooring Rope 12mm 20m", prices: {"6.5M":300,"7.6M":300,"8.5M":300,"9.5M":300,"11.5M":300,"13M":300}},
            {name: "2x Gunwale Mounted Boat Hook", prices: {"6.5M":150,"7.6M":150,"8.5M":150,"9.5M":150,"11.5M":150,"13M":150}},
            {name: "Forward Deck Mounted Boarding Team Hand Railing", prices: {"6.5M":5200,"7.6M":5200,"8.5M":5200,"9.5M":5200,"11.5M":5200,"13M":5200}},
            {name: "Single Hoisting Lifting System", prices: {"6.5M":19500,"7.6M":19500,"8.5M":19500,"9.5M":19500,"11.5M":19500,"13M":19500}},
            {name: "Fire Extinguisher Compartment", prices: {"6.5M":310,"7.6M":310,"8.5M":310,"9.5M":310,"11.5M":310,"13M":310}},
            {name: "Anti-fouling Hull Bottom Paint", prices: {"6.5M":2575,"7.6M":3140,"8.5M":3460,"9.5M":3750,"11.5M":4275,"13M":4500}},
            {name: "Life Ring", prices: {"6.5M":110,"7.6M":110,"8.5M":110,"9.5M":110,"11.5M":110,"13M":110}},
            {name: "Dive Bottle Rack (6 Bottles)", prices: {"6.5M":3250,"7.6M":3250,"8.5M":3250,"9.5M":3250,"11.5M":3250,"13M":3250}}
        ],
        "Protection & Guards": [
            {name: "Aluminium Bow Guard with Pushing Knee", prices: {"6.5M":8110,"7.6M":8110,"8.5M":8110,"9.5M":8110,"11.5M":8110,"13M":8110}},
            {name: "PE Filled Foam - Pushing Knee", prices: {"6.5M":4400,"7.6M":4400,"8.5M":4400,"9.5M":4400,"11.5M":4400,"13M":4400}},
            {name: "HD Aluminium Engine Guard", prices: {"6.5M":2800,"7.6M":2800,"8.5M":2800,"9.5M":2800,"11.5M":2800,"13M":2800}},
            {name: "Propeller Guard", prices: {"6.5M":1680,"7.6M":1680,"8.5M":1680,"9.5M":1680,"11.5M":1680,"13M":1680}},
            {name: "Wooden Pallet with Shrink-Wrap Packaging", prices: {"6.5M":1430,"7.6M":1430,"8.5M":1430,"9.5M":1430,"11.5M":1430,"13M":1430}}
        ],
        "Trailers": [
            {name: "Galvanized Steel Single Axis Trailer (Without Brakes)", prices: {"6.5M":5000,"7.6M":6000,"8.5M":"X","9.5M":"X","11.5M":"X","13M":"X"}},
            {name: "Galvanized Steel Double Trailer (Without Brakes)", prices: {"6.5M":"X","7.6M":"X","8.5M":7000,"9.5M":8000,"11.5M":"X","13M":"X"}},
            {name: "Galvanized Steel Triple Trailer (Without Brakes)", prices: {"6.5M":"X","7.6M":"X","8.5M":"X","9.5M":"X","11.5M":10000,"13M":10000}}
        ],
        "GPS": [
            {name: "GARMIN GPSMAP 923 XSV 9\" MFD with Sonar", prices: {"6.5M":2270,"7.6M":2270,"8.5M":2270,"9.5M":2270,"11.5M":2270,"13M":2270}},
            {name: "GARMIN GPSMAP 8410 XSV 10\" MFD with Sonar", prices: {"6.5M":4400,"7.6M":4400,"8.5M":4400,"9.5M":4400,"11.5M":4400,"13M":4400}},
            {name: "GARMIN GPSMAP 8410 10\" MFD W/O Sonar", prices: {"6.5M":3500,"7.6M":3500,"8.5M":3500,"9.5M":3500,"11.5M":3500,"13M":3500}}
        ],
        "Radar": [
            {name: "GARMIN GMR 18HD+ 18NM Radar Scanner", prices: {"6.5M":2200,"7.6M":2200,"8.5M":2200,"9.5M":2200,"11.5M":2200,"13M":2200}},
            {name: "GARMIN GMR Fantom 18x Dome Radar", prices: {"6.5M":2600,"7.6M":2600,"8.5M":2600,"9.5M":2600,"11.5M":2600,"13M":2600}}
        ],
        "VHF": [
            {name: "Garmin 115i VHF Radio with Antenna", prices: {"6.5M":750,"7.6M":750,"8.5M":750,"9.5M":750,"11.5M":750,"13M":750}},
            {name: "Garmin 215i AIS VHF Radio with Antenna", prices: {"6.5M":1200,"7.6M":1200,"8.5M":1200,"9.5M":1200,"11.5M":1200,"13M":1200}}
        ],
        "Other Communication": [
            {name: "Whelen Siren/PA System IAW COLREGS", prices: {"6.5M":1100,"7.6M":1100,"8.5M":1100,"9.5M":1100,"11.5M":1100,"13M":1100}},
            {name: "Signal Horn 12VDC IAW COLREGS", prices: {"6.5M":250,"7.6M":250,"8.5M":250,"9.5M":250,"11.5M":250,"13M":250}}
        ],
        "FLIR / Thermal": [
            {name: "FLIR M232 Thermal Camera (320x240, 9Hz)", prices: {"6.5M":6500,"7.6M":6500,"8.5M":6500,"9.5M":6500,"11.5M":6500,"13M":6500}},
            {name: "FLIR M364C Gyro Stabilized Thermal IP Camera", prices: {"6.5M":27000,"7.6M":27000,"8.5M":27000,"9.5M":27000,"11.5M":27000,"13M":27000}}
        ],
        "Lighting & Electrical": [
            {name: "STL K-FORCE LED Law Enforcement Light Bar", prices: {"6.5M":1500,"7.6M":1500,"8.5M":1500,"9.5M":1500,"11.5M":1500,"13M":1500}},
            {name: "Remote Search Light ACR RCL 95 w/Joystick", prices: {"6.5M":1050,"7.6M":1050,"8.5M":1050,"9.5M":1050,"11.5M":1050,"13M":1050}},
            {name: "LED Flood Lights / Scene-Lights (4 pieces)", prices: {"6.5M":800,"7.6M":800,"8.5M":800,"9.5M":800,"11.5M":800,"13M":800}},
            {name: "Deck Light LED Tri-Color Lighting", prices: {"6.5M":1060,"7.6M":1060,"8.5M":1400,"9.5M":1400,"11.5M":1775,"13M":1775}},
            {name: "12 VDC Air-Compressor Tube Inflation System", prices: {"6.5M":400,"7.6M":400,"8.5M":400,"9.5M":400,"11.5M":400,"13M":400}},
            {name: "3-Bank Onboard Battery Charging System 40A", prices: {"6.5M":750,"7.6M":750,"8.5M":750,"9.5M":750,"11.5M":750,"13M":750}},
            {name: "BLUE SEA Accessory Receptacle 12VDC", prices: {"6.5M":75,"7.6M":75,"8.5M":75,"9.5M":75,"11.5M":75,"13M":75}},
            {name: "BLUE SEA 12VDC Dual USB Charging Outlets", prices: {"6.5M":100,"7.6M":100,"8.5M":100,"9.5M":100,"11.5M":100,"13M":100}},
            {name: "Plastimo Flush Mount Offshore Compass 95", prices: {"6.5M":380,"7.6M":380,"8.5M":380,"9.5M":380,"11.5M":380,"13M":380}}
        ]
    },
    fiberglass: {
        "Propulsion / Engine": [
            {name: "Single Mercury F150Hp EXLPT (incl. controls, steering, gauges)", prices: {"4.1M":18620,"5.1M":"X","5.5M":"X","6.5M":"X","7.2M":"X","8.0M":"X","8.5M":"X","9.5M":"X","12M":"X"}},
            {name: "Twin Mercury F150Hp XLPT/CXLPT (incl. controls, steering, gauges)", prices: {"4.1M":"X","5.1M":34255,"5.5M":"X","6.5M":"X","7.2M":"X","8.0M":"X","8.5M":"X","9.5M":"X","12M":"X"}},
            {name: "Twin Mercury Verado F300 V8 XL/CXL (DTS, Vessel View 502)", prices: {"4.1M":"X","5.1M":"X","5.5M":68975,"6.5M":68975,"7.2M":68975,"8.0M":"X","8.5M":"X","9.5M":"X","12M":"X"}},
            {name: "Twin Mercury F400 V10 XL/CXL (DTS, Vessel View 502)", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":103120,"7.2M":103120,"8.0M":103120,"8.5M":103120,"9.5M":103120,"12M":103120}},
            {name: "Triple Mercury Verado F300 V8 XL/CXL (DTS, Vessel View 702)", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":"X","7.2M":"X","8.0M":114950,"8.5M":114950,"9.5M":114950,"12M":114950}},
            {name: "Triple Mercury F400 V10 XL/CXL (DTS, Vessel View 502)", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":"X","7.2M":"X","8.0M":166180,"8.5M":166180,"9.5M":166180,"12M":166180}}
        ],
        "General": [
            {name: "Hybrid Foam-Filled Tube-Set", prices: {"4.1M":9880,"5.1M":12010,"5.5M":12955,"6.5M":15310,"7.2M":16960,"8.0M":18840,"8.5M":20608,"9.5M":22375,"12M":29300}},
            {name: "Custom Color Hypalon", prices: {"4.1M":2500,"5.1M":3000,"5.5M":3500,"6.5M":4000,"7.2M":4500,"8.0M":5000,"8.5M":5000,"9.5M":5000,"12M":5000}},
            {name: "Double Layer Hypalon", prices: {"4.1M":15340,"5.1M":17500,"5.5M":20000,"6.5M":22420,"7.2M":27000,"8.0M":28320,"8.5M":28320,"9.5M":28320,"12M":28320}},
            {name: "Hypalon Strip Between Fender", prices: {"4.1M":2000,"5.1M":2200,"5.5M":2400,"6.5M":2600,"7.2M":2800,"8.0M":3000,"8.5M":3100,"9.5M":3300,"12M":3500}},
            {name: "Hypalon Non-Slip Step-Tread", prices: {"4.1M":1500,"5.1M":1700,"5.5M":2200,"6.5M":2500,"7.2M":2800,"8.0M":3000,"8.5M":3100,"9.5M":3200,"12M":3300}},
            {name: "Hypalon Branding And Numbering", prices: {"4.1M":700,"5.1M":700,"5.5M":700,"6.5M":700,"7.2M":700,"8.0M":700,"8.5M":700,"9.5M":700,"12M":700}},
            {name: "Extra Handle", prices: {"4.1M":50,"5.1M":50,"5.5M":50,"6.5M":50,"7.2M":50,"8.0M":50,"8.5M":50,"9.5M":50,"12M":50}},
            {name: "Diver-Notch", prices: {"4.1M":3200,"5.1M":3200,"5.5M":3200,"6.5M":3200,"7.2M":3200,"8.0M":3200,"8.5M":3200,"9.5M":3200,"12M":3200}},
            {name: "Notch Filling Inserts", prices: {"4.1M":2500,"5.1M":2500,"5.5M":2500,"6.5M":2500,"7.2M":3500,"8.0M":3500,"8.5M":3500,"9.5M":3500,"12M":3500}},
            {name: "Bow Step with 2 Stainless Steel Cleats", prices: {"4.1M":545,"5.1M":545,"5.5M":545,"6.5M":545,"7.2M":545,"8.0M":545,"8.5M":545,"9.5M":545,"12M":545}},
            {name: "Aluminium Anchor with S.S Chain", prices: {"4.1M":1075,"5.1M":1075,"5.5M":1075,"6.5M":1075,"7.2M":1075,"8.0M":1075,"8.5M":1075,"9.5M":1075,"12M":1075}},
            {name: "Aluminium Anchor with Rope 30m", prices: {"4.1M":390,"5.1M":390,"5.5M":390,"6.5M":390,"7.2M":390,"8.0M":390,"8.5M":390,"9.5M":390,"12M":390}},
            {name: "Windless Clipper with S.S Chain & Anchor", prices: {"4.1M":5360,"5.1M":5360,"5.5M":5360,"6.5M":5360,"7.2M":5360,"8.0M":5360,"8.5M":5360,"9.5M":5360,"12M":5360}},
            {name: "Boat Cover", prices: {"4.1M":2500,"5.1M":4000,"5.5M":4500,"6.5M":5000,"7.2M":5500,"8.0M":5500,"8.5M":5500,"9.5M":5500,"12M":5500}}
        ],
        "Console": [
            {name: "Single Futura Console with Forward Seat", tag: "console", prices: {"4.1M":"X","5.1M":4610,"5.5M":4610,"6.5M":4610,"7.2M":4610,"8.0M":4610,"8.5M":4610,"9.5M":4610,"12M":4610}},
            {name: "Single Futura Console without Forward Seat", tag: "console", prices: {"4.1M":"X","5.1M":3647,"5.5M":3647,"6.5M":3647,"7.2M":3647,"8.0M":3647,"8.5M":3647,"9.5M":3647,"12M":3647}},
            {name: "Double Futura Console with Forward Seat - Low Rail", tag: "console", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":6380,"7.2M":6380,"8.0M":6380,"8.5M":6380,"9.5M":6380,"12M":6380}},
            {name: "Double Futura Console with Forward Seat - High Rail", tag: "console", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":8390,"7.2M":8390,"8.0M":8390,"8.5M":8390,"9.5M":8390,"12M":8390}},
            {name: "Double Futura Console without Forward Seat - Low Rail", tag: "console", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":4950,"7.2M":4950,"8.0M":4950,"8.5M":4950,"9.5M":4950,"12M":4950}},
            {name: "Double Futura Console without Forward Seat - High Rail", tag: "console", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":6960,"7.2M":6960,"8.0M":6960,"8.5M":6960,"9.5M":6960,"12M":6960}},
            {name: "Aluminium Console with Windscreen and Grab Rail", tag: "console", prices: {"4.1M":10115,"5.1M":10115,"5.5M":10500,"6.5M":11200,"7.2M":12000,"8.0M":12000,"8.5M":12000,"9.5M":12800,"12M":12800}},
            {name: "Double Ballistic Console", tag: "console", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":5840,"7.2M":5840,"8.0M":5840,"8.5M":5840,"9.5M":5840,"12M":5840}},
            {name: "Double Console with Toilet", tag: "console", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":"X","7.2M":"X","8.0M":23570,"8.5M":23570,"9.5M":23570,"12M":23570}},
            {name: "Beachlander Console", tag: "console", prices: {"4.1M":"X","5.1M":2590,"5.5M":2590,"6.5M":2590,"7.2M":2590,"8.0M":2590,"8.5M":2590,"9.5M":2590,"12M":2590}},
            {name: "Jockey Seat Console", tag: "console", prices: {"4.1M":3480,"5.1M":3480,"5.5M":3480,"6.5M":3480,"7.2M":3480,"8.0M":3480,"8.5M":3480,"9.5M":3480,"12M":3480}},
            {name: "Mamba Console", tag: "console", prices: {"4.1M":"X","5.1M":3290,"5.5M":3290,"6.5M":"X","7.2M":"X","8.0M":"X","8.5M":"X","9.5M":"X","12M":"X"}}
        ],
        "Cabin / T-Top": [
            {name: "Aluminum Cabin for 4 PAX", tag: "cabin", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":"TBD","7.2M":"TBD","8.0M":"TBD","8.5M":"TBD","9.5M":"TBD","12M":"TBD"}},
            {name: "Aluminum Cabin with Cuddy and Toilet", tag: "cabin", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":"X","7.2M":"X","8.0M":"X","8.5M":"X","9.5M":79570,"12M":79570}},
            {name: "Aluminum Wheel-house", tag: "cabin", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":"X","7.2M":"X","8.0M":19200,"8.5M":19200,"9.5M":19200,"12M":19200}},
            {name: "Standard HD T-Top", tag: "ttop", prices: {"4.1M":"X","5.1M":8300,"5.5M":8300,"6.5M":8300,"7.2M":8300,"8.0M":8300,"8.5M":8300,"9.5M":8300,"12M":8300}},
            {name: "S.S. HD T-Top", tag: "ttop", prices: {"4.1M":"X","5.1M":13250,"5.5M":13250,"6.5M":13250,"7.2M":13250,"8.0M":13250,"8.5M":13250,"9.5M":13250,"12M":13250}},
            {name: "Aluminium T-Top with Hard Top 1 (2.7m)", tag: "ttop", prices: {"4.1M":12560,"5.1M":12560,"5.5M":12560,"6.5M":12560,"7.2M":12560,"8.0M":12560,"8.5M":12560,"9.5M":12560,"12M":12560}},
            {name: "Aluminium T-Top with Hard Top 2 (3.8m)", tag: "ttop", prices: {"4.1M":14920,"5.1M":14920,"5.5M":14920,"6.5M":14920,"7.2M":14920,"8.0M":14920,"8.5M":14920,"9.5M":14920,"12M":14920}},
            {name: "Aluminium T-Top with Hard Top 3 (4.4m)", tag: "ttop", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":"X","7.2M":26100,"8.0M":26100,"8.5M":26100,"9.5M":26100,"12M":26100}},
            {name: "Aluminium Foldable T-Top", tag: "ttop", prices: {"4.1M":"X","5.1M":10615,"5.5M":10615,"6.5M":10615,"7.2M":10615,"8.0M":10615,"8.5M":10615,"9.5M":10615,"12M":10615}},
            {name: "Extended Canopy to A-Frame", prices: {"4.1M":"X","5.1M":655,"5.5M":655,"6.5M":655,"7.2M":655,"8.0M":655,"8.5M":655,"9.5M":655,"12M":655}}
        ],
        "Leaning Posts": [
            {name: "Leaning Post Single", prices: {"4.1M":"X","5.1M":2765,"5.5M":2765,"6.5M":2765,"7.2M":2765,"8.0M":2765,"8.5M":2765,"9.5M":2765,"12M":2765}},
            {name: "Leaning Post with Back Rest Single", prices: {"4.1M":"X","5.1M":3310,"5.5M":3310,"6.5M":3310,"7.2M":3310,"8.0M":3310,"8.5M":3310,"9.5M":3310,"12M":3310}},
            {name: "Leaning Post Double", prices: {"4.1M":"X","5.1M":3400,"5.5M":3400,"6.5M":3400,"7.2M":3400,"8.0M":3400,"8.5M":3400,"9.5M":3400,"12M":3400}},
            {name: "Leaning Post With Back Rest Double", prices: {"4.1M":"X","5.1M":4000,"5.5M":4000,"6.5M":4000,"7.2M":4000,"8.0M":4000,"8.5M":4000,"9.5M":4000,"12M":4000}},
            {name: "Fiber Glass Leaning Post with Back Rest - Single", prices: {"4.1M":"X","5.1M":"X","5.5M":9000,"6.5M":9000,"7.2M":9000,"8.0M":9000,"8.5M":9000,"9.5M":9000,"12M":9000}}
        ],
        "Jockey & Straddle": [
            {name: "Grab Rail for Front Seat", prices: {"4.1M":650,"5.1M":650,"5.5M":650,"6.5M":650,"7.2M":650,"8.0M":650,"8.5M":650,"9.5M":650,"12M":650}},
            {name: "Straddle Seat with Handle", prices: {"4.1M":1980,"5.1M":1980,"5.5M":1980,"6.5M":1980,"7.2M":1980,"8.0M":1980,"8.5M":1980,"9.5M":1980,"12M":1980}},
            {name: "Single GRP Jockey Seat with Back Rail", prices: {"4.1M":1700,"5.1M":1700,"5.5M":1700,"6.5M":1700,"7.2M":1700,"8.0M":1700,"8.5M":1700,"9.5M":1700,"12M":1700}},
            {name: "Double GRP Jockey Seat with Back Rail", prices: {"4.1M":3400,"5.1M":3400,"5.5M":3400,"6.5M":3400,"7.2M":3400,"8.0M":3400,"8.5M":3400,"9.5M":3400,"12M":3400}}
        ],
        "Bench Seats": [
            {name: "Painted Aluminum Bench Seat 1 PAX with Storage", prices: {"4.1M":4420,"5.1M":4420,"5.5M":4420,"6.5M":4420,"7.2M":4420,"8.0M":4420,"8.5M":4420,"9.5M":4420,"12M":4420}},
            {name: "S.S. Bench Seat 1 PAX with Storage", prices: {"4.1M":5530,"5.1M":5530,"5.5M":5530,"6.5M":5530,"7.2M":5530,"8.0M":5530,"8.5M":5530,"9.5M":5530,"12M":5530}},
            {name: "Painted Aluminum Bench Seat 2 PAX with Storage", prices: {"4.1M":5150,"5.1M":5150,"5.5M":5150,"6.5M":5150,"7.2M":5150,"8.0M":5150,"8.5M":5150,"9.5M":5150,"12M":5150}},
            {name: "S.S. Bench Seat 2 PAX with Storage", prices: {"4.1M":6240,"5.1M":6240,"5.5M":6240,"6.5M":6240,"7.2M":6240,"8.0M":6240,"8.5M":6240,"9.5M":6240,"12M":6240}},
            {name: "Painted Aluminum Bench Seat 3 PAX with Storage", prices: {"4.1M":6570,"5.1M":6570,"5.5M":6570,"6.5M":6570,"7.2M":6570,"8.0M":6570,"8.5M":6570,"9.5M":6570,"12M":6570}},
            {name: "S.S. Bench Seat 3 PAX with Storage", prices: {"4.1M":7890,"5.1M":7890,"5.5M":7890,"6.5M":7890,"7.2M":7890,"8.0M":7890,"8.5M":7890,"9.5M":7890,"12M":7890}},
            {name: "Painted Aluminum Bench Seat 4 PAX with Storage", prices: {"4.1M":8360,"5.1M":8360,"5.5M":8360,"6.5M":8360,"7.2M":8360,"8.0M":8360,"8.5M":8360,"9.5M":8360,"12M":8360}},
            {name: "S.S. Bench Seat 4 PAX with Storage", prices: {"4.1M":8350,"5.1M":8350,"5.5M":8350,"6.5M":8350,"7.2M":8350,"8.0M":8350,"8.5M":8350,"9.5M":8350,"12M":8350}}
        ],
        "Suspension Seats": [
            {name: "Ullman BISCAYA Jockey Suspension Seat", prices: {"4.1M":5500,"5.1M":5500,"5.5M":5500,"6.5M":5500,"7.2M":5500,"8.0M":5500,"8.5M":5500,"9.5M":5500,"12M":5500}},
            {name: "Ullman Patrol Jockey Suspension Seat", prices: {"4.1M":6250,"5.1M":6250,"5.5M":6250,"6.5M":6250,"7.2M":6250,"8.0M":6250,"8.5M":6250,"9.5M":6250,"12M":6250}},
            {name: "Echelon Midback Jockey Suspension Seat", prices: {"4.1M":16300,"5.1M":16300,"5.5M":16300,"6.5M":16300,"7.2M":16300,"8.0M":16300,"8.5M":16300,"9.5M":16300,"12M":16300}}
        ],
        "A-Frame": [
            {name: "Aluminium A Frame", prices: {"4.1M":2885,"5.1M":2885,"5.5M":2885,"6.5M":2885,"7.2M":3260,"8.0M":3260,"8.5M":3400,"9.5M":3400,"12M":3600}},
            {name: "Aluminium A Frame With Self-righting System", prices: {"4.1M":9730,"5.1M":9730,"5.5M":9730,"6.5M":9730,"7.2M":10140,"8.0M":10140,"8.5M":10500,"9.5M":10500,"12M":10800}},
            {name: "Aluminium A Frame with Swim Platform and Ladder", prices: {"4.1M":4300,"5.1M":4300,"5.5M":4300,"6.5M":4300,"7.2M":4675,"8.0M":4675,"8.5M":4800,"9.5M":4800,"12M":5000}}
        ],
        "Other Frames & Structure": [
            {name: "Aluminium Tube Ladder", prices: {"4.1M":2500,"5.1M":2500,"5.5M":2500,"6.5M":2500,"7.2M":2500,"8.0M":2500,"8.5M":2500,"9.5M":2500,"12M":2500}},
            {name: "Swim Platform at Transom for Inboard Engine", prices: {"4.1M":1285,"5.1M":1285,"5.5M":1285,"6.5M":1285,"7.2M":1285,"8.0M":1285,"8.5M":1285,"9.5M":1285,"12M":1285}},
            {name: "Bow Tow Post", prices: {"4.1M":2230,"5.1M":2230,"5.5M":2230,"6.5M":2230,"7.2M":2230,"8.0M":2230,"8.5M":2230,"9.5M":2230,"12M":2230}},
            {name: "Aft Tow Post", prices: {"4.1M":2230,"5.1M":2230,"5.5M":2230,"6.5M":2230,"7.2M":2230,"8.0M":2230,"8.5M":2230,"9.5M":2230,"12M":2230}},
            {name: "Bollard", prices: {"4.1M":835,"5.1M":835,"5.5M":835,"6.5M":835,"7.2M":835,"8.0M":835,"8.5M":835,"9.5M":835,"12M":835}},
            {name: "Bow HD Tow Post w/Weapons Mount Flange", prices: {"4.1M":7000,"5.1M":7000,"5.5M":7000,"6.5M":7000,"7.2M":7000,"8.0M":7000,"8.5M":7000,"9.5M":7000,"12M":7000}},
            {name: "Aft HD Tow Post w/Weapons Mount Flange", prices: {"4.1M":7000,"5.1M":7000,"5.5M":7000,"6.5M":7000,"7.2M":7000,"8.0M":7000,"8.5M":7000,"9.5M":7000,"12M":7000}}
        ],
        "Life Jackets": [
            {name: "Life Jacket SOLAS Foam with Flashlight 170N", prices: {"4.1M":85,"5.1M":85,"5.5M":85,"6.5M":85,"7.2M":85,"8.0M":85,"8.5M":85,"9.5M":85,"12M":85}},
            {name: "Life Jacket Manual Inflatable 170N", prices: {"4.1M":120,"5.1M":120,"5.5M":120,"6.5M":120,"7.2M":120,"8.0M":120,"8.5M":120,"9.5M":120,"12M":120}}
        ],
        "Other Safety": [
            {name: "Distress Signal Kit for Coastal Navigation", prices: {"4.1M":200,"5.1M":200,"5.5M":200,"6.5M":200,"7.2M":200,"8.0M":200,"8.5M":200,"9.5M":200,"12M":200}},
            {name: "2x Fire Extinguisher (2Kg) IAW COLREGS", prices: {"4.1M":300,"5.1M":300,"5.5M":300,"6.5M":300,"7.2M":300,"8.0M":300,"8.5M":300,"9.5M":300,"12M":300}},
            {name: "2x 20\" USCG Approved Ring Buoy IAW COLREGS", prices: {"4.1M":160,"5.1M":160,"5.5M":160,"6.5M":160,"7.2M":160,"8.0M":160,"8.5M":160,"9.5M":160,"12M":160}},
            {name: "2x Mooring Rope 12mm 20m", prices: {"4.1M":300,"5.1M":300,"5.5M":300,"6.5M":300,"7.2M":300,"8.0M":300,"8.5M":300,"9.5M":300,"12M":300}},
            {name: "2x Gunwale Mounted Boat Hook", prices: {"4.1M":150,"5.1M":150,"5.5M":150,"6.5M":150,"7.2M":150,"8.0M":150,"8.5M":150,"9.5M":150,"12M":150}},
            {name: "Single Hoisting Lifting System", prices: {"4.1M":15000,"5.1M":15000,"5.5M":15000,"6.5M":15000,"7.2M":19500,"8.0M":19500,"8.5M":19500,"9.5M":19500,"12M":19500}},
            {name: "Anti-fouling Hull Bottom Paint", prices: {"4.1M":2575,"5.1M":3140,"5.5M":3460,"6.5M":3750,"7.2M":4275,"8.0M":4500,"8.5M":4500,"9.5M":4500,"12M":4500}},
            {name: "Life Ring", prices: {"4.1M":110,"5.1M":110,"5.5M":110,"6.5M":110,"7.2M":110,"8.0M":110,"8.5M":110,"9.5M":110,"12M":110}},
            {name: "Dive Bottle Rack (6 Bottles)", prices: {"4.1M":3250,"5.1M":3250,"5.5M":3250,"6.5M":3250,"7.2M":3250,"8.0M":3250,"8.5M":3250,"9.5M":3250,"12M":3250}}
        ],
        "Protection & Guards": [
            {name: "Aluminium Bow Guard with Pushing Knee", prices: {"4.1M":8110,"5.1M":8110,"5.5M":8110,"6.5M":8110,"7.2M":8110,"8.0M":8110,"8.5M":8110,"9.5M":8110,"12M":8110}},
            {name: "Foam Filled Pushing Knee", prices: {"4.1M":4400,"5.1M":4400,"5.5M":4400,"6.5M":4400,"7.2M":4400,"8.0M":4400,"8.5M":4400,"9.5M":4400,"12M":4400}},
            {name: "Keel Guard", prices: {"4.1M":1430,"5.1M":1430,"5.5M":1430,"6.5M":1430,"7.2M":1430,"8.0M":1430,"8.5M":1430,"9.5M":1430,"12M":1430}},
            {name: "Full Length Keel Guard (Bow Eyes to Transom)", prices: {"4.1M":2600,"5.1M":2600,"5.5M":3000,"6.5M":3000,"7.2M":3500,"8.0M":3500,"8.5M":3500,"9.5M":3500,"12M":3500}},
            {name: "HD Aluminium Engine Guard", prices: {"4.1M":3360,"5.1M":3360,"5.5M":3360,"6.5M":3360,"7.2M":3360,"8.0M":3360,"8.5M":3360,"9.5M":3360,"12M":3360}},
            {name: "Propeller Guard", prices: {"4.1M":1680,"5.1M":1680,"5.5M":1680,"6.5M":1680,"7.2M":1680,"8.0M":1680,"8.5M":1680,"9.5M":1680,"12M":1680}},
            {name: "Wooden Pallet with Shrink-Wrap Packaging", prices: {"4.1M":1430,"5.1M":1430,"5.5M":1430,"6.5M":1430,"7.2M":1430,"8.0M":1430,"8.5M":1430,"9.5M":1430,"12M":1430}}
        ],
        "Trailers": [
            {name: "Galvanized Steel Single Axis Trailer (Without Brakes)", prices: {"4.1M":5000,"5.1M":5500,"5.5M":6000,"6.5M":"X","7.2M":"X","8.0M":"X","8.5M":"X","9.5M":"X","12M":"X"}},
            {name: "Galvanized Steel Double Trailer (Without Brakes)", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":7000,"7.2M":7000,"8.0M":8000,"8.5M":8000,"9.5M":8000,"12M":"X"}},
            {name: "Galvanized Steel Triple Trailer (Without Brakes)", prices: {"4.1M":"X","5.1M":"X","5.5M":"X","6.5M":"X","7.2M":"X","8.0M":"X","8.5M":"X","9.5M":"X","12M":10000}}
        ],
        "GPS": [
            {name: "GARMIN GPSMAP 923 XSV 9\" MFD with Sonar", prices: {"4.1M":2270,"5.1M":2270,"5.5M":2270,"6.5M":2270,"7.2M":2270,"8.0M":2270,"8.5M":2270,"9.5M":2270,"12M":2270}},
            {name: "GARMIN GPSMAP 8410 XSV 10\" MFD with Sonar", prices: {"4.1M":4400,"5.1M":4400,"5.5M":4400,"6.5M":4400,"7.2M":4400,"8.0M":4400,"8.5M":4400,"9.5M":4400,"12M":4400}},
            {name: "GARMIN GPSMAP 8410 10\" MFD W/O Sonar", prices: {"4.1M":3500,"5.1M":3500,"5.5M":3500,"6.5M":3500,"7.2M":3500,"8.0M":3500,"8.5M":3500,"9.5M":3500,"12M":3500}}
        ],
        "Radar": [
            {name: "GARMIN GMR 18HD+ 18NM Radar Scanner", prices: {"4.1M":2200,"5.1M":2200,"5.5M":2200,"6.5M":2200,"7.2M":2200,"8.0M":2200,"8.5M":2200,"9.5M":2200,"12M":2200}},
            {name: "GARMIN GMR Fantom 18x Dome Radar", prices: {"4.1M":2600,"5.1M":2600,"5.5M":2600,"6.5M":2600,"7.2M":2600,"8.0M":2600,"8.5M":2600,"9.5M":2600,"12M":2600}}
        ],
        "VHF": [
            {name: "Garmin 115i VHF Radio with Antenna", prices: {"4.1M":750,"5.1M":750,"5.5M":750,"6.5M":750,"7.2M":750,"8.0M":750,"8.5M":750,"9.5M":750,"12M":750}},
            {name: "Garmin 215i AIS VHF Radio with Antenna", prices: {"4.1M":1200,"5.1M":1200,"5.5M":1200,"6.5M":1200,"7.2M":1200,"8.0M":1200,"8.5M":1200,"9.5M":1200,"12M":1200}}
        ],
        "Other Communication": [
            {name: "Whelen Siren/PA System IAW COLREGS", prices: {"4.1M":1100,"5.1M":1100,"5.5M":1100,"6.5M":1100,"7.2M":1100,"8.0M":1100,"8.5M":1100,"9.5M":1100,"12M":1100}},
            {name: "Signal Horn 12VDC IAW COLREGS", prices: {"4.1M":250,"5.1M":250,"5.5M":250,"6.5M":250,"7.2M":250,"8.0M":250,"8.5M":250,"9.5M":250,"12M":250}}
        ],
        "FLIR / Thermal": [
            {name: "FLIR M232 Thermal Camera (320x240, 9Hz)", prices: {"4.1M":6500,"5.1M":6500,"5.5M":6500,"6.5M":6500,"7.2M":6500,"8.0M":6500,"8.5M":6500,"9.5M":6500,"12M":6500}},
            {name: "FLIR M364C Gyro Stabilized Thermal IP Camera", prices: {"4.1M":27000,"5.1M":27000,"5.5M":27000,"6.5M":27000,"7.2M":27000,"8.0M":27000,"8.5M":27000,"9.5M":27000,"12M":27000}}
        ],
        "Lighting & Electrical": [
            {name: "STL K-FORCE LED Law Enforcement Light Bar", prices: {"4.1M":1500,"5.1M":1500,"5.5M":1500,"6.5M":1500,"7.2M":1500,"8.0M":1500,"8.5M":1500,"9.5M":1500,"12M":1500}},
            {name: "Remote Search Light ACR RCL 95 w/Joystick", prices: {"4.1M":1050,"5.1M":1050,"5.5M":1050,"6.5M":1050,"7.2M":1050,"8.0M":1050,"8.5M":1050,"9.5M":1050,"12M":1050}},
            {name: "LED Flood Lights / Scene-Lights (4 pieces)", prices: {"4.1M":800,"5.1M":800,"5.5M":800,"6.5M":800,"7.2M":800,"8.0M":800,"8.5M":800,"9.5M":800,"12M":800}},
            {name: "Deck Light LED Tri-Color Lighting", prices: {"4.1M":1060,"5.1M":1060,"5.5M":1400,"6.5M":1400,"7.2M":1775,"8.0M":1775,"8.5M":1775,"9.5M":1775,"12M":1775}},
            {name: "12 VDC Air-Compressor Tube Inflation System", prices: {"4.1M":400,"5.1M":400,"5.5M":400,"6.5M":400,"7.2M":400,"8.0M":400,"8.5M":400,"9.5M":400,"12M":400}},
            {name: "3-Bank Onboard Battery Charging System 40A", prices: {"4.1M":750,"5.1M":750,"5.5M":750,"6.5M":750,"7.2M":750,"8.0M":750,"8.5M":750,"9.5M":750,"12M":750}},
            {name: "BLUE SEA Accessory Receptacle 12VDC", prices: {"4.1M":75,"5.1M":75,"5.5M":75,"6.5M":75,"7.2M":75,"8.0M":75,"8.5M":75,"9.5M":75,"12M":75}},
            {name: "BLUE SEA 12VDC Dual USB Charging Outlets", prices: {"4.1M":100,"5.1M":100,"5.5M":100,"6.5M":100,"7.2M":100,"8.0M":100,"8.5M":100,"9.5M":100,"12M":100}},
            {name: "Plastimo Flush Mount Offshore Compass 95", prices: {"4.1M":380,"5.1M":380,"5.5M":380,"6.5M":380,"7.2M":380,"8.0M":380,"8.5M":380,"9.5M":380,"12M":380}}
        ]
    },
    inflatable: {
        "Engine": [],
        "Optional Accessories": [
            {name: "Custom Color Hypalon", prices: {"2.8M":"TBD","3.2M":"TBD","3.5M":"TBD","4.2M":"TBD","4.8M":"TBD","5.1M":"TBD"}},
            {name: "Extra Bench Seat", prices: {"2.8M":650,"3.2M":700,"3.5M":730,"4.2M":990,"4.8M":990,"5.1M":990}},
            {name: "Extra Hypalon D-ring Patch", prices: {"2.8M":50,"3.2M":50,"3.5M":50,"4.2M":50,"4.8M":50,"5.1M":50}},
            {name: "Hypalon Pilot Handles", prices: {"2.8M":50,"3.2M":50,"3.5M":50,"4.2M":50,"4.8M":50,"5.1M":50}},
            {name: "Moulded Rubber Handles", prices: {"2.8M":250,"3.2M":250,"3.5M":250,"4.2M":250,"4.8M":250,"5.1M":250}}
        ]
    }
};

// Category groupings - maps subcategories to main groups
// flat: true means show category directly without group wrapper
const CATEGORY_GROUPS = {
    aluminum: [
        {
            name: "Propulsion / Engine",
            icon: "⚙️",
            flat: true,
            categories: ["Propulsion / Engine"]
        },
        {
            name: "ASIS Accessories",
            icon: "🛠️",
            categories: ["General", "Console", "Cabin / T-Top", "A-Frame", "Other Frames & Structure", "Protection & Guards"],
            subgroups: [
                {
                    name: "Seating",
                    categories: ["Leaning Posts", "Jockey & Grab Rail", "Suspension Seats"]
                },
                {
                    name: "Safety Equipment",
                    categories: ["Life Jackets", "Other Safety"]
                }
            ],
            postCategories: ["Trailers"]
        },
        {
            name: "Electronics & Communication",
            icon: "📡",
            categories: ["GPS", "Radar", "VHF", "Other Communication", "FLIR / Thermal", "Lighting & Electrical"]
        }
    ],
    fiberglass: [
        {
            name: "Propulsion / Engine",
            icon: "⚙️",
            flat: true,
            categories: ["Propulsion / Engine"]
        },
        {
            name: "ASIS Accessories",
            icon: "🛠️",
            categories: ["General", "Console", "Cabin / T-Top", "A-Frame", "Other Frames & Structure", "Protection & Guards"],
            subgroups: [
                {
                    name: "Seating",
                    categories: ["Leaning Posts", "Jockey & Straddle", "Bench Seats", "Suspension Seats"]
                },
                {
                    name: "Safety Equipment",
                    categories: ["Life Jackets", "Other Safety"]
                }
            ],
            postCategories: ["Trailers"]
        },
        {
            name: "Electronics & Communication",
            icon: "📡",
            categories: ["GPS", "Radar", "VHF", "Other Communication", "FLIR / Thermal", "Lighting & Electrical"]
        }
    ],
    inflatable: [
        {
            name: "Propulsion / Engine",
            icon: "⚙️",
            flat: true,
            categories: ["Engine"],
            customOnly: true
        },
        {
            name: "ASIS Accessories",
            icon: "🛠️",
            flat: true,
            categories: ["Optional Accessories"]
        }
    ]
};

// Currency rates - AED fixed, EUR fetched from API
let RATES = {USD: 1, AED: 3.6725, EUR: 0.92}; // AED fixed, EUR fallback
let ratesLoaded = false;

// Update rate info display
function updateRateInfo() {
    const infoText = `1 USD = 3.6725 AED (fixed) | ${RATES.EUR.toFixed(4)} EUR ${ratesLoaded ? '(live)' : '(fallback)'}`;
    
    const rateInfo1 = document.getElementById('rateInfo1');
    const rateInfo2 = document.getElementById('rateInfo2');
    if (rateInfo1) rateInfo1.innerHTML = ratesLoaded ? `🟢 ${infoText}` : `🟡 ${infoText}`;
    if (rateInfo2) rateInfo2.innerHTML = ratesLoaded ? `🟢 ${infoText}` : `🟡 ${infoText}`;
}

// Fetch live EUR exchange rate on page load
async function fetchExchangeRates() {
    try {
        const response = await fetch('https://api.frankfurter.app/latest?from=USD&to=EUR');
        const data = await response.json();
        RATES.EUR = data.rates.EUR;
        ratesLoaded = true;
        console.log('Live EUR rate loaded:', RATES.EUR);
        updateRateInfo();
        updateTotals();
    } catch (error) {
        console.warn('Could not fetch live EUR rate, using fallback:', error);
        updateRateInfo();
    }
}

// Call on page load
fetchExchangeRates();

// Salesman contact information
const SALESMEN = {
    mario: {
        name: "Mario Hoyek",
        email: "marioh@asisboats.com",
        phone: "+971 50 462 9258"
    },
    soufiane: {
        name: "Soufiane Tangi",
        email: "soufianet@asisboats.com",
        phone: "+971 50 551 2985"
    },
    toji: {
        name: "Toji Paul",
        email: "tojip@asisboats.com",
        phone: "+971 54 791 3337"
    }
};

// ==================== STATE ====================
let state = {
    boatType: null,
    sizeIdx: null,
    currency: 'USD',
    items: {},
    allExpanded: true
};

let itemCounter = 0;

// ==================== INIT ====================
function init() {
    document.getElementById('quoteDate').value = new Date().toISOString().split('T')[0];
    renderBoatTypes();
    updateRateInfo();
    checkAutoLogin();
}

// Toggle custom delivery input
function toggleDeliveryInput() {
    const select = document.getElementById('deliverySelect');
    const customInput = document.getElementById('deliveryCustom');
    if (select.value === 'custom') {
        customInput.style.display = 'block';
        customInput.focus();
    } else {
        customInput.style.display = 'none';
        customInput.value = '';
    }
}

// Toggle custom salesman fields
// Populate salesman dropdown based on logged-in user's role
function populateSalesmanDropdown() {
    const select = document.getElementById('salesman');
    const salesmenList = [
        { id: 'mario', name: 'Mario Hoyek' },
        { id: 'soufiane', name: 'Soufiane Tangi' },
        { id: 'toji', name: 'Toji Paul' }
    ];
    
    let html = '';
    
    if (currentUser && currentUser.role === 'salesman') {
        // Salesmen: their name is default, can switch to other 2 salesmen only
        salesmenList.forEach(s => {
            const selected = s.id === currentUser.id ? ' selected' : '';
            html += `<option value="${s.id}"${selected}>${s.name}</option>`;
        });
    } else {
        // Non-salesmen (admin/guest): blank default + all salesmen + custom
        html += '<option value="">-- No Salesman --</option>';
        salesmenList.forEach(s => {
            html += `<option value="${s.id}">${s.name}</option>`;
        });
        html += '<option value="custom">✏️ Custom...</option>';
    }
    
    select.innerHTML = html;
}

function toggleCustomSalesman() {
    const select = document.getElementById('salesman');
    const customFields = document.getElementById('customSalesmanFields');
    if (select.value === 'custom') {
        customFields.style.display = 'block';
    } else {
        customFields.style.display = 'none';
    }
}

// Get salesman info for PDF/preview — returns {name, email, phone} or null if empty
function getSalesmanInfo() {
    const salesmanKey = document.getElementById('salesman')?.value;
    if (!salesmanKey || salesmanKey === '') return null;
    if (salesmanKey === 'custom') {
        const name = document.getElementById('customSalesmanName')?.value || '';
        const email = document.getElementById('customSalesmanEmail')?.value || '';
        const phone = document.getElementById('customSalesmanPhone')?.value || '';
        if (!name && !email && !phone) return null;
        return { name, email, phone };
    }
    return SALESMEN[salesmanKey] || null;
}

// Get delivery timeline value
function getDeliveryTimeline() {
    const select = document.getElementById('deliverySelect');
    if (select.value === 'custom') {
        return document.getElementById('deliveryCustom').value || 'TBD';
    }
    return select.value;
}

// Toggle PDF price display options (mutually exclusive)
function togglePdfOption(option) {
    const categoryCheckbox = document.getElementById('showCategoryTotals');
    const allPricesCheckbox = document.getElementById('showAllPrices');
    
    if (option === 'category' && categoryCheckbox.checked) {
        allPricesCheckbox.checked = false;
    } else if (option === 'all' && allPricesCheckbox.checked) {
        categoryCheckbox.checked = false;
    }
}

// Sync quote number between header and step 3
function syncQuoteNumber(value, source) {
    if (source === 'header') {
        document.getElementById('quoteNum').value = value;
    } else {
        document.getElementById('quoteBadgeInput').value = value;
    }
}

// ==================== UTILITIES ====================
function fmt(n) { return n.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0}); }
function fmtPrice(n) {
    const converted = n * RATES[state.currency];
    const symbol = state.currency === 'EUR' ? '€' : state.currency === 'AED' ? 'AED ' : '$';
    return symbol + fmt(converted);
}
function getSelectedSize() {
    if (state.boatType && state.sizeIdx !== null) {
        return BOATS[state.boatType].sizes[state.sizeIdx].size;
    }
    return null;
}

// Toast notification system (replaces browser alert())
function showToast(message, type = 'error', duration = 4000) {
    const container = document.getElementById('toastContainer');
    const icons = { error: '⚠️', warning: '💡', success: '✅', info: 'ℹ️' };
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `<span class="toast-icon">${icons[type] || icons.info}</span><span class="toast-msg">${message}</span><button class="toast-close" onclick="this.parentElement.classList.add('hiding');setTimeout(()=>this.parentElement.remove(),350)">✕</button>`;
    container.appendChild(toast);
    requestAnimationFrame(() => requestAnimationFrame(() => toast.classList.add('show')));
    setTimeout(() => {
        if (toast.parentElement) {
            toast.classList.add('hiding');
            setTimeout(() => toast.remove(), 350);
        }
    }, duration);
}

// Start a new quotation (save current and go to dashboard)
function startNewQuote() {
    if (hasUnsavedChanges) {
        saveQuotationToCloud(true).then(() => startNewEditor());
    } else {
        startNewEditor();
    }
}

// ==================== BOAT SELECTION ====================
function renderBoatTypes() {
    const grid = document.getElementById('boatTypesGrid');
    grid.innerHTML = '';
    Object.entries(BOATS).forEach(([key, boat]) => {
        const minPrice = Math.min(...boat.sizes.map(s => s.price));
        grid.innerHTML += `
            <div class="boat-type ${state.boatType === key ? 'selected' : ''}" onclick="selectBoatType('${key}')">
                <div class="boat-type-icon">${boat.icon}</div>
                <h3>${boat.name}</h3>
                <p>${boat.desc}</p>
                <div class="boat-type-stats">
                    <div class="stat"><div class="stat-val">${boat.sizes.length}</div><div class="stat-label">Sizes</div></div>
                    <div class="stat"><div class="stat-val">$${fmt(minPrice)}</div><div class="stat-label">From</div></div>
                </div>
            </div>`;
    });
}

function renderBoatSizes() {
    const grid = document.getElementById('boatSizesGrid');
    const boat = BOATS[state.boatType];
    grid.innerHTML = '';
    boat.sizes.forEach((s, i) => {
        grid.innerHTML += `
            <div class="boat-size ${state.sizeIdx === i ? 'selected' : ''}" onclick="selectBoatSize(${i})">
                <div class="size">${s.size}</div>
                <div class="price">${fmtPrice(s.price)}</div>
                <div class="specs">Fuel: ${s.fuel} | ${s.pax} PAX</div>
            </div>`;
    });
}

function hasExistingSelections() {
    if (!state.items || Object.keys(state.items).length === 0) return false;
    // Check if any category has actual selections (not just empty radio "None")
    return Object.values(state.items).some(catItems => {
        return Object.entries(catItems).some(([key, item]) => {
            if (key === 'radio') return item.itemIdx !== -1;
            return item.qty > 0;
        });
    });
}

async function selectBoatType(type) {
    // Check if this would reset existing selections (even clicking same type)
    if (state.boatType !== null && hasExistingSelections()) {
        const ok = await showConfirm('Reset Configuration?', 'This will clear all your current accessories and configuration. This cannot be undone.');
        if (!ok) return;
    }
    
    // Always reset items when clicking on a boat type
    state.items = {};
    document.getElementById('quoteTitle').value = '';
    state.sizeIdx = null;
    
    state.boatType = type;
    
    renderBoatTypes();
    document.getElementById('sizesCard').style.display = 'block';
    renderBoatSizes();
    document.getElementById('nextBtn1').disabled = true;
    updateTotals();
}

async function selectBoatSize(idx) {
    // Check if selecting any size would reset existing selections
    if (state.sizeIdx !== null && hasExistingSelections()) {
        const ok = await showConfirm('Reset Configuration?', 'This will clear all your current accessories and configuration. This cannot be undone.');
        if (!ok) return;
    }
    
    state.sizeIdx = idx;
    
    // Always reset items when clicking on a boat size
    state.items = {};
    document.getElementById('quoteTitle').value = '';
    
    renderBoatSizes();
    document.getElementById('nextBtn1').disabled = false;
    updateTotals();
    
    // Auto-advance to step 2
    setTimeout(() => goTo(2), 300);
}

// ==================== CATEGORIES ====================
// Check if a category is exclusive (radio buttons)
function isExclusiveCategory(cat) {
    return EXCLUSIVE_CATEGORIES.includes(cat);
}

// Helper function to build category HTML
function buildCategoryHtml(cat, accessories, selectedSize, isFlat, group) {
    const items = accessories[cat];
    const isCustomOnly = group && group.customOnly;
    
    // For custom-only categories (like HDIB Engine), show even if no items
    if (!items && !isCustomOnly) return { html: '', hasItems: false };
    
    // Filter items available for this size, keeping track of original index
    const availableItems = items ? items.map((item, originalIdx) => ({...item, originalIdx}))
        .filter(item => {
            const price = item.prices[selectedSize];
            return price !== 'X' && price !== undefined;
        }) : [];
    
    // For regular categories, require at least one item (unless customOnly)
    if (availableItems.length === 0 && !isCustomOnly) return { html: '', hasItems: false };
    
    const catId = cat.replace(/[^a-zA-Z0-9]/g, '');
    const isExclusive = isExclusiveCategory(cat);
    
    // For flat groups, use the group name as header
    let displayName = cat;
    if (isFlat && group) {
        displayName = group.name;
    }
    
    // Determine flat color class
    let flatColorClass = '';
    if (isFlat && group) {
        if (group.name.toLowerCase().includes('engine') || group.name.toLowerCase().includes('propulsion')) {
            flatColorClass = 'engine-flat';
        } else if (group.name.toLowerCase().includes('accessories') || group.name.toLowerCase().includes('asis')) {
            flatColorClass = 'accessories-flat';
        } else if (group.name.toLowerCase().includes('electronic') || group.name.toLowerCase().includes('communication')) {
            flatColorClass = 'electronics-flat';
        }
    }
    
    const categoryClass = isFlat ? `category flat-category ${flatColorClass}` : 'category';
    
    // Build content based on category type
    let innerContent;
    if (isCustomOnly) {
        // Custom-only category (like HDIB Engine) - only show custom input
        innerContent = buildCustomOnlyContent(cat, catId);
    } else if (isExclusive) {
        // Build radio button group
        innerContent = buildRadioGroupContent(cat, catId, availableItems, selectedSize);
    } else {
        // Build checkbox group
        innerContent = buildCheckboxGroupContent(cat, catId, availableItems, selectedSize);
    }
    
    const exclusiveBadge = isExclusive ? '<span class="exclusive-badge">SELECT ONE</span>' : '';
    
    const html = `
        <div class="${categoryClass}" data-category="${cat}">
            <div class="cat-header" onclick="toggleCategory('${catId}')">
                <h3>${isFlat && group ? `<span style="margin-right:8px;font-size:18px;">${group.icon}</span>` : ''}${displayName} ${exclusiveBadge}<span class="options-count">(${availableItems.length})</span></h3>
                <div class="cat-meta">
                    <span class="cat-selected-count" id="catSelCount-${catId}">0 selected</span>
                    <span class="cat-total" id="catTotal-${catId}">$0</span>
                    <span class="arrow">▼</span>
                </div>
            </div>
            <div class="cat-content" id="content-${catId}">
                <div class="cat-inner">
                    ${innerContent}
                </div>
            </div>
        </div>`;
    
    return { html, hasItems: true, cat, isExclusive };
}

// Build radio button content for exclusive categories
function buildRadioGroupContent(cat, catId, availableItems, selectedSize) {
    const hasQty = EXCLUSIVE_WITH_QTY.includes(cat);
    let html = `<div class="radio-group" id="radio-${catId}">`;
    
    // Create nice "None" text based on category name
    let noneText = "No " + cat;
    if (cat === "Propulsion / Engine") noneText = "No Engine Selected";
    else if (cat === "Cabin / T-Top") noneText = "No Cabin or T-Top";
    else if (cat === "Leaning Posts") noneText = "No Leaning Post";
    else if (cat === "A-Frame") noneText = "No A-Frame";
    else if (cat === "Life Jackets") noneText = "No Life Jackets";
    else if (cat === "Trailers") noneText = "No Trailer";
    else if (cat === "GPS") noneText = "No GPS System";
    else if (cat === "Radar") noneText = "No Radar";
    else if (cat === "VHF") noneText = "No VHF Radio";
    else if (cat === "FLIR / Thermal") noneText = "No Thermal Camera";
    
    // Add "None" option first (default selected)
    html += `
        <label class="radio-option none-option selected" onclick="selectRadioOption('${cat}', -1, this, event)">
            <input type="radio" name="radio-${catId}" value="-1" checked>
            <div class="option-details">
                <div class="option-name">${noneText}</div>
            </div>
            ${hasQty ? '<div class="qty-stepper" style="visibility:hidden;"><button type="button" tabindex="-1">−</button><input type="number" value="0" disabled><button type="button" tabindex="-1">+</button></div>' : ''}
            <div class="option-price"></div>
            ${hasQty ? '<div class="option-extended"></div>' : ''}
        </label>`;
    
    // Add actual items
    availableItems.forEach((item) => {
        const price = item.prices[selectedSize];
        let priceDisplay;
        let priceClass = 'option-price';
        
        if (price === 'TBD') {
            // Show editable TBD input
            priceDisplay = `<div class="tbd-input-wrapper">
                <span>$</span>
                <input type="number" class="tbd-price-input" id="tbd-radio-${catId}-${item.originalIdx}" 
                    placeholder="TBD" min="0" step="100" 
                    onclick="event.stopPropagation()" 
                    onchange="updateTBDPrice('${cat}', ${item.originalIdx}, this.value, 'radio')">
            </div>`;
            priceClass = '';
        } else if (price === 'Incl.') {
            priceDisplay = 'Included';
        } else {
            priceDisplay = '$' + fmt(price);
        }
        
        if (hasQty) {
            // Radio with quantity stepper
            html += `
                <label class="radio-option" id="radio-opt-${catId}-${item.originalIdx}" data-item-name="${item.name.toLowerCase()}" onclick="selectRadioOptionWithQty('${cat}', ${item.originalIdx}, this)">
                    <input type="radio" name="radio-${catId}" value="${item.originalIdx}">
                    <div class="option-details">
                        <div class="option-name">${item.name}</div>
                    </div>
                    <div class="qty-stepper">
                        <button type="button" onclick="event.stopPropagation();stepQty('${cat}',${item.originalIdx},-1,'radio')" tabindex="-1">−</button>
                        <input type="number" value="0" min="0" max="99" id="qty-radio-${catId}-${item.originalIdx}" 
                            onchange="updateRadioQty('${cat}', ${item.originalIdx})" onclick="event.stopPropagation()">
                        <button type="button" onclick="event.stopPropagation();stepQty('${cat}',${item.originalIdx},1,'radio')" tabindex="-1">+</button>
                    </div>
                    <div class="${priceClass}">${priceDisplay}</div>
                    <div class="option-extended" id="ext-radio-${catId}-${item.originalIdx}">$0</div>
                </label>`;
        } else {
            // Standard radio without quantity
            html += `
                <label class="radio-option" id="radio-opt-${catId}-${item.originalIdx}" data-item-name="${item.name.toLowerCase()}" onclick="selectRadioOption('${cat}', ${item.originalIdx}, this, event)">
                    <input type="radio" name="radio-${catId}" value="${item.originalIdx}">
                    <div class="option-details">
                        <div class="option-name">${item.name}</div>
                    </div>
                    <div class="${priceClass}">${priceDisplay}</div>
                </label>`;
        }
    });
    
    // Add custom item input row
    html += `
        <div class="custom-item-row">
            <span class="custom-item-label">+ Add Custom:</span>
            <input type="text" placeholder="Item name" id="custom-name-${catId}">
            ${hasQty ? '<input type="number" style="width:50px;" placeholder="Qty" min="1" value="1" id="custom-qty-' + catId + '">' : ''}
            <input type="number" class="price-input" placeholder="Price" min="0" step="100" id="custom-price-${catId}">
            <button class="add-btn" onclick="addCustomItem('${cat}', '${catId}', 'radio')">Add</button>
        </div>`;
    
    html += '</div>';
    return html;
}

// Build checkbox content for non-exclusive categories
function buildCheckboxGroupContent(cat, catId, availableItems, selectedSize) {
    let html = `<div class="checkbox-group" id="checkbox-${catId}">`;
    
    // Add all items as checkboxes
    availableItems.forEach((item) => {
        const price = item.prices[selectedSize];
        const idx = item.originalIdx;
        let priceDisplay;
        let priceClass = 'option-price';
        
        if (price === 'TBD') {
            // Show editable TBD input
            priceDisplay = `<div class="tbd-input-wrapper">
                <span>$</span>
                <input type="number" class="tbd-price-input" id="tbd-chk-${catId}-${idx}" 
                    placeholder="TBD" min="0" step="100" 
                    onclick="event.stopPropagation()" 
                    onchange="updateTBDPrice('${cat}', ${idx}, this.value, 'checkbox')">
            </div>`;
            priceClass = '';
        } else if (price === 'Incl.') {
            priceDisplay = 'Included';
        } else {
            priceDisplay = '$' + fmt(price);
        }
        
        html += `
            <label class="checkbox-option" id="chk-${catId}-${idx}" data-item-name="${item.name.toLowerCase()}">
                <input type="checkbox" name="checkbox-${catId}" value="${idx}" onchange="toggleCheckboxOption('${cat}', ${idx}, this)">
                <div class="option-details">
                    <div class="option-name">${item.name}</div>
                </div>
                <div class="qty-stepper">
                    <button type="button" onclick="event.stopPropagation();stepQty('${cat}',${idx},-1,'chk')" tabindex="-1">−</button>
                    <input type="number" value="0" min="0" max="99" id="qty-${catId}-${idx}" onchange="updateCheckboxQty('${cat}', ${idx})" onclick="event.stopPropagation()">
                    <button type="button" onclick="event.stopPropagation();stepQty('${cat}',${idx},1,'chk')" tabindex="-1">+</button>
                </div>
                <div class="${priceClass}" id="price-${catId}-${idx}">${priceDisplay}</div>
                <div class="option-extended" id="ext-${catId}-${idx}">$0</div>
            </label>`;
    });
    
    // Add custom item input row
    html += `
        <div class="custom-item-row">
            <span class="custom-item-label">+ Add Custom:</span>
            <input type="text" placeholder="Item name" id="custom-name-${catId}">
            <input type="number" style="width:50px;" placeholder="Qty" min="1" value="1" id="custom-qty-${catId}">
            <input type="number" class="price-input" placeholder="Price" min="0" step="100" id="custom-price-${catId}">
            <button class="add-btn" onclick="addCustomItem('${cat}', '${catId}', 'checkbox')">Add</button>
        </div>`;
    
    html += '</div>';
    return html;
}

// Build custom-only content for categories like HDIB Engine (no predefined items)
function buildCustomOnlyContent(cat, catId) {
    let html = `<div class="custom-only-group" id="custom-${catId}">`;
    
    html += `
        <div style="padding:15px;background:var(--gray-100);border-radius:8px;margin-bottom:10px;">
            <p style="color:var(--gray-600);font-size:13px;margin-bottom:15px;">
                No predefined engine options available. Add a custom engine below:
            </p>
            <div class="custom-item-row" style="margin:0;">
                <span class="custom-item-label">+ Add Engine:</span>
                <input type="text" placeholder="Engine name/model" id="custom-name-${catId}" style="flex:2;">
                <input type="number" class="price-input" placeholder="Price" min="0" step="100" id="custom-price-${catId}">
                <button class="add-btn" onclick="addCustomItem('${cat}', '${catId}', 'radio')">Add</button>
            </div>
        </div>`;
    
    // Container for added custom items
    html += `<div id="custom-items-${catId}"></div>`;
    
    html += '</div>';
    return html;
}

// Handle radio button selection
function selectRadioOption(category, itemIdx, element, event) {
    // Prevent double execution from label/radio click interaction
    if (event) {
        event.stopPropagation();
    }
    
    const catId = category.replace(/[^a-zA-Z0-9]/g, '');
    const radioGroup = document.getElementById('radio-' + catId);
    
    // Store previously selected option before changing
    const previouslySelected = radioGroup.querySelector('.radio-option.selected');
    
    // Get item name if not "None"
    let itemName = 'None';
    if (itemIdx !== -1) {
        const item = ACCESSORIES[state.boatType][category][itemIdx];
        itemName = item.name;
        
        // Check Console/Cabin/T-Top constraints
        const constraintError = validateConsoleCabinTTop(category, itemIdx, true);
        if (constraintError) {
            showToast(constraintError, 'warning');
            // Keep the previous selection visually
            if (event) event.preventDefault();
            return false;
        }
    }
    
    // Remove selected class from all options
    radioGroup.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
    
    // Add selected class to clicked option
    element.classList.add('selected');
    
    // Check the radio input
    element.querySelector('input[type="radio"]').checked = true;
    
    // Update state
    if (!state.items[category]) state.items[category] = {};
    
    // Clear previous selections in this category
    state.items[category] = {};
    
    if (itemIdx === -1) {
        // "None" selected - no item
        state.items[category]['radio'] = {itemIdx: -1, qty: 0, price: 0, name: 'None', isCustom: false, isTBD: false};
    } else {
        const selectedSize = getSelectedSize();
        const item = ACCESSORIES[state.boatType][category][itemIdx];
        const price = item.prices[selectedSize];
        
        // Handle various price types: number, 'TBD', 'Incl.', undefined
        let numericPrice = 0;
        let isTBD = false;
        if (typeof price === 'number' && !isNaN(price)) {
            numericPrice = price;
        } else if (price === 'TBD') {
            isTBD = true;
            // Check if there's a TBD input with a value
            const tbdInput = document.getElementById(`tbd-radio-${catId}-${itemIdx}`);
            if (tbdInput && tbdInput.value) {
                numericPrice = parseFloat(tbdInput.value) || 0;
                isTBD = (numericPrice === 0);
            }
        }
        // 'Incl.' and undefined both result in price = 0
        
        state.items[category]['radio'] = {
            itemIdx: itemIdx,
            qty: 1,
            price: numericPrice,
            name: item.name,
            isCustom: false,
            isTBD: isTBD
        };
    }
    
    updateCategoryTotal(category);
    updateTotals();
}

// Handle radio button selection with quantity (for Life Jackets etc)
function selectRadioOptionWithQty(category, itemIdx, element) {
    const catId = category.replace(/[^a-zA-Z0-9]/g, '');
    const radioGroup = document.getElementById('radio-' + catId);
    
    // Remove selected class from all options and reset their qty
    radioGroup.querySelectorAll('.radio-option').forEach(opt => {
        if (opt !== element) {
            opt.classList.remove('selected');
            const qtyInput = opt.querySelector('.qty-stepper input[type="number"]');
            if (qtyInput) qtyInput.value = 0;
            const extDiv = opt.querySelector('.option-extended');
            if (extDiv) extDiv.textContent = '$0';
        }
    });
    
    // Add selected class to clicked option
    element.classList.add('selected');
    
    // Check the radio input
    element.querySelector('input[type="radio"]').checked = true;
    
    // Set qty to 1 if it was 0
    const qtyInput = document.getElementById(`qty-radio-${catId}-${itemIdx}`);
    if (qtyInput && parseInt(qtyInput.value) === 0) {
        qtyInput.value = 1;
    }
    
    const qty = parseInt(qtyInput?.value) || 1;
    
    // Update state
    if (!state.items[category]) state.items[category] = {};
    state.items[category] = {}; // Clear previous
    
    const selectedSize = getSelectedSize();
    const item = ACCESSORIES[state.boatType][category][itemIdx];
    const price = item.prices[selectedSize];
    
    let numericPrice = 0;
    let isTBD = false;
    if (typeof price === 'number' && !isNaN(price)) {
        numericPrice = price;
    } else if (price === 'TBD') {
        isTBD = true;
        const tbdInput = document.getElementById(`tbd-radio-${catId}-${itemIdx}`);
        if (tbdInput && tbdInput.value) {
            numericPrice = parseFloat(tbdInput.value) || 0;
            isTBD = (numericPrice === 0);
        }
    }
    
    state.items[category]['radio'] = {
        itemIdx: itemIdx,
        qty: qty,
        price: numericPrice,
        name: item.name,
        isCustom: false,
        isTBD: isTBD
    };
    
    // Update extended price
    const extDiv = document.getElementById(`ext-radio-${catId}-${itemIdx}`);
    if (extDiv) {
        if (isTBD) {
            extDiv.innerHTML = '<span class="tbd">TBD</span>';
        } else {
            extDiv.textContent = '$' + fmt(numericPrice * qty);
        }
    }
    
    updateCategoryTotal(category);
    updateTotals();
}

// Update quantity for radio options with qty (Life Jackets etc)
function updateRadioQty(category, itemIdx) {
    const catId = category.replace(/[^a-zA-Z0-9]/g, '');
    const qtyInput = document.getElementById(`qty-radio-${catId}-${itemIdx}`);
    const label = document.getElementById(`radio-opt-${catId}-${itemIdx}`);
    const radioGroup = document.getElementById('radio-' + catId);
    const qty = parseInt(qtyInput.value) || 0;
    
    if (qty > 0) {
        // Auto-select this option
        radioGroup.querySelectorAll('.radio-option').forEach(opt => {
            if (opt !== label) {
                opt.classList.remove('selected');
                const otherQty = opt.querySelector('.qty-stepper input[type="number"]');
                if (otherQty) otherQty.value = 0;
                const otherExt = opt.querySelector('.option-extended');
                if (otherExt) otherExt.textContent = '$0';
            }
        });
        
        label.classList.add('selected');
        label.querySelector('input[type="radio"]').checked = true;
        
        const selectedSize = getSelectedSize();
        const item = ACCESSORIES[state.boatType][category][itemIdx];
        const price = item.prices[selectedSize];
        
        let numericPrice = 0;
        let isTBD = false;
        if (typeof price === 'number' && !isNaN(price)) {
            numericPrice = price;
        } else if (price === 'TBD') {
            isTBD = true;
        }
        
        if (!state.items[category]) state.items[category] = {};
        state.items[category] = {};
        state.items[category]['radio'] = {
            itemIdx: itemIdx,
            qty: qty,
            price: numericPrice,
            name: item.name,
            isCustom: false,
            isTBD: isTBD
        };
        
        // Update extended price
        const extDiv = document.getElementById(`ext-radio-${catId}-${itemIdx}`);
        if (extDiv) {
            if (isTBD) {
                extDiv.innerHTML = '<span class="tbd">TBD</span>';
            } else {
                extDiv.textContent = '$' + fmt(numericPrice * qty);
            }
        }
    } else {
        // Qty is 0, deselect
        label.classList.remove('selected');
        const extDiv = document.getElementById(`ext-radio-${catId}-${itemIdx}`);
        if (extDiv) extDiv.textContent = '$0';
        
        // Select "None"
        const noneOption = radioGroup.querySelector('.none-option');
        if (noneOption) {
            noneOption.classList.add('selected');
            noneOption.querySelector('input[type="radio"]').checked = true;
        }
        
        if (!state.items[category]) state.items[category] = {};
        state.items[category] = {};
        state.items[category]['radio'] = {itemIdx: -1, qty: 0, price: 0, name: 'None', isCustom: false, isTBD: false};
    }
    
    updateCategoryTotal(category);
    updateTotals();
}

// Handle checkbox toggle
function toggleCheckboxOption(category, itemIdx, checkbox) {
    const catId = category.replace(/[^a-zA-Z0-9]/g, '');
    const label = document.getElementById(`chk-${catId}-${itemIdx}`);
    const qtyInput = document.getElementById(`qty-${catId}-${itemIdx}`);
    const extDiv = document.getElementById(`ext-${catId}-${itemIdx}`);
    
    if (!state.items[category]) state.items[category] = {};
    
    const selectedSize = getSelectedSize();
    const item = ACCESSORIES[state.boatType][category][itemIdx];
    
    // Check if this is an anchor item (mutually exclusive with deselect capability)
    const isAnchorItem = ANCHOR_ITEMS.includes(item.name);
    
    if (checkbox.checked) {
        // If it's an anchor item, deselect other anchor items first
        if (isAnchorItem) {
            deselectOtherAnchorItems(category, itemIdx, catId);
        }
        
        // Check Console/Cabin/T-Top constraints
        const constraintError = validateConsoleCabinTTop(category, itemIdx, true);
        if (constraintError) {
            showToast(constraintError, 'warning');
            checkbox.checked = false;
            return;
        }
        
        label.classList.add('selected');
        // Set qty to 1 when checked
        qtyInput.value = 1;
        
        const price = item.prices[selectedSize];
        
        // Handle various price types
        let numericPrice = 0;
        let isTBD = false;
        if (typeof price === 'number' && !isNaN(price)) {
            numericPrice = price;
        } else if (price === 'TBD') {
            isTBD = true;
            // Check if there's a TBD input with a value
            const tbdInput = document.getElementById(`tbd-chk-${catId}-${itemIdx}`);
            if (tbdInput && tbdInput.value) {
                numericPrice = parseFloat(tbdInput.value) || 0;
                isTBD = (numericPrice === 0);
            }
        }
        
        state.items[category][itemIdx] = {
            itemIdx: itemIdx,
            qty: 1,
            price: numericPrice,
            name: item.name,
            isCustom: false,
            isTBD: isTBD
        };
        
        // Update extended price
        if (isTBD) {
            extDiv.innerHTML = '<span class="tbd">TBD</span>';
        } else if (price === 'Incl.') {
            extDiv.textContent = 'Incl.';
        } else {
            extDiv.textContent = '$' + fmt(numericPrice);
        }
    } else {
        label.classList.remove('selected');
        qtyInput.value = 0;
        delete state.items[category][itemIdx];
        extDiv.textContent = '$0';
    }
    
    updateCategoryTotal(category);
    updateTotals();
}

// Deselect other anchor items when one is selected
function deselectOtherAnchorItems(category, selectedIdx, catId) {
    const accessories = ACCESSORIES[state.boatType][category];
    if (!accessories) return;
    
    accessories.forEach((item, idx) => {
        if (idx !== selectedIdx && ANCHOR_ITEMS.includes(item.name)) {
            const chkLabel = document.getElementById(`chk-${catId}-${idx}`);
            if (chkLabel) {
                const chk = chkLabel.querySelector('input[type="checkbox"]');
                if (chk && chk.checked) {
                    chk.checked = false;
                    chkLabel.classList.remove('selected');
                    const qtyInput = document.getElementById(`qty-${catId}-${idx}`);
                    if (qtyInput) qtyInput.value = 0;
                    const extDiv = document.getElementById(`ext-${catId}-${idx}`);
                    if (extDiv) extDiv.textContent = '$0';
                    delete state.items[category][idx];
                }
            }
        }
    });
}

// Validate Console/Cabin/T-Top constraints
function validateConsoleCabinTTop(category, itemIdx, isSelecting) {
    // Only applies to Cabin / T-Top and Console categories
    if (category !== 'Cabin / T-Top' && category !== 'Console') return null;
    if (!isSelecting || itemIdx === -1) return null;
    
    // Get the tag of the item being selected
    const selectingTag = getItemConstraintTag(state.boatType, category, itemIdx);
    if (!selectingTag) return null; // Items without tags have no constraints
    
    // Scan current state for what's already selected
    let hasConsole = false, hasTTop = false, hasCabin = false;
    
    const scanCategory = (cat) => {
        const items = state.items[cat];
        if (!items) return;
        Object.values(items).forEach(item => {
            if (!item || item.itemIdx === -1 || !item.qty || item.qty <= 0) return;
            const tag = getStateItemTag(cat, item);
            if (tag === 'console') hasConsole = true;
            if (tag === 'ttop') hasTTop = true;
            if (tag === 'cabin') hasCabin = true;
        });
    };
    
    scanCategory('Cabin / T-Top');
    scanCategory('Console');
    
    // Constraint rules:
    // 1. T-Top requires Console
    if (selectingTag === 'ttop' && !hasConsole) {
        return "T-Top requires a Console. Please select a Console first.";
    }
    // 2. Cabin and Console are mutually exclusive
    if (selectingTag === 'cabin' && hasConsole) {
        return "Cabin cannot be selected with Console. Please deselect Console first.";
    }
    if (selectingTag === 'console' && hasCabin) {
        return "Console cannot be selected with Cabin. Please deselect Cabin first.";
    }
    // 3. Cabin and T-Top are mutually exclusive
    if (selectingTag === 'cabin' && hasTTop) {
        return "Cabin cannot be selected with T-Top. Please deselect T-Top first.";
    }
    if (selectingTag === 'ttop' && hasCabin) {
        return "T-Top cannot be selected with Cabin. Please deselect Cabin first.";
    }
    
    return null;
}

// Update checkbox quantity
function updateCheckboxQty(category, itemIdx) {
    const catId = category.replace(/[^a-zA-Z0-9]/g, '');
    const qtyInput = document.getElementById(`qty-${catId}-${itemIdx}`);
    const checkbox = document.querySelector(`#chk-${catId}-${itemIdx} input[type="checkbox"]`);
    const label = document.getElementById(`chk-${catId}-${itemIdx}`);
    const extDiv = document.getElementById(`ext-${catId}-${itemIdx}`);
    
    const qty = parseInt(qtyInput.value) || 0;
    
    if (!state.items[category]) state.items[category] = {};
    
    if (qty > 0) {
        // Auto-check if qty > 0
        checkbox.checked = true;
        label.classList.add('selected');
        
        const selectedSize = getSelectedSize();
        const item = ACCESSORIES[state.boatType][category][itemIdx];
        const price = item.prices[selectedSize];
        
        // Handle various price types
        let numericPrice = 0;
        let isTBD = false;
        if (typeof price === 'number' && !isNaN(price)) {
            numericPrice = price;
        } else if (price === 'TBD') {
            isTBD = true;
            // Check if there's a TBD input with a value
            const tbdInput = document.getElementById(`tbd-chk-${catId}-${itemIdx}`);
            if (tbdInput && tbdInput.value) {
                numericPrice = parseFloat(tbdInput.value) || 0;
                isTBD = (numericPrice === 0);
            }
        }
        
        state.items[category][itemIdx] = {
            itemIdx: itemIdx,
            qty: qty,
            price: numericPrice,
            name: item.name,
            isCustom: false,
            isTBD: isTBD
        };
        
        // Update extended price
        if (isTBD) {
            extDiv.innerHTML = '<span class="tbd">TBD</span>';
        } else if (price === 'Incl.') {
            extDiv.textContent = 'Incl.';
        } else {
            extDiv.textContent = '$' + fmt(numericPrice * qty);
        }
    } else {
        // Auto-uncheck if qty = 0
        checkbox.checked = false;
        label.classList.remove('selected');
        delete state.items[category][itemIdx];
        extDiv.textContent = '$0';
    }
    
    updateCategoryTotal(category);
    updateTotals();
}

// Update TBD price when user enters a value
function updateTBDPrice(category, itemIdx, value, type) {
    const price = parseFloat(value) || 0;
    const catId = category.replace(/[^a-zA-Z0-9]/g, '');
    
    if (!state.items[category]) state.items[category] = {};
    
    if (type === 'radio') {
        // For radio buttons, update the 'radio' entry
        if (state.items[category]['radio'] && state.items[category]['radio'].itemIdx === itemIdx) {
            state.items[category]['radio'].price = price;
            state.items[category]['radio'].isTBD = (price === 0);
        }
    } else {
        // For checkboxes, update the specific item entry
        if (state.items[category][itemIdx]) {
            state.items[category][itemIdx].price = price;
            state.items[category][itemIdx].isTBD = (price === 0);
            
            // Update extended price display
            const extDiv = document.getElementById(`ext-${catId}-${itemIdx}`);
            const qty = state.items[category][itemIdx].qty || 1;
            if (price > 0) {
                extDiv.textContent = '$' + fmt(price * qty);
            } else {
                extDiv.innerHTML = '<span class="tbd">TBD</span>';
            }
        }
    }
    
    updateCategoryTotal(category);
    updateTotals();
}

// Add custom item to a category
function addCustomItem(category, catId, type) {
    const nameInput = document.getElementById(`custom-name-${catId}`);
    const priceInput = document.getElementById(`custom-price-${catId}`);
    const qtyInput = document.getElementById(`custom-qty-${catId}`);
    
    const name = nameInput.value.trim();
    const price = parseFloat(priceInput.value) || 0;
    const qty = qtyInput ? parseInt(qtyInput.value) || 1 : 1;
    
    if (!name) {
        showToast('Please enter an item name', 'warning');
        nameInput.focus();
        return;
    }
    
    if (!state.items[category]) state.items[category] = {};
    
    // Generate unique custom item ID
    itemCounter++;
    const customId = `custom_${itemCounter}`;
    
    if (type === 'radio') {
        // For radio (exclusive) categories, replace current selection
        state.items[category] = {};
        state.items[category]['radio'] = {
            itemIdx: customId,
            qty: 1,
            price: price,
            name: name,
            isCustom: true,
            isTBD: false
        };
        
        // Add visual indicator - create a custom selected option
        const radioGroup = document.getElementById(`radio-${catId}`);
        
        // Remove selected class from all options
        radioGroup.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
        
        // Add custom item display at the top (after None)
        const existingCustom = radioGroup.querySelector('.custom-added-item');
        if (existingCustom) existingCustom.remove();
        
        const customLabel = document.createElement('label');
        customLabel.className = 'radio-option selected custom-added-item';
        customLabel.innerHTML = `
            <input type="radio" name="radio-${catId}" value="${customId}" checked>
            <div class="option-details">
                <div class="option-name">✨ ${name}</div>
            </div>
            <div class="option-price" style="color:var(--success);">$${fmt(price)}</div>
        `;
        customLabel.onclick = function() {
            radioGroup.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
            customLabel.classList.add('selected');
            state.items[category]['radio'] = {
                itemIdx: customId,
                qty: 1,
                price: price,
                name: name,
                isCustom: true,
                isTBD: false
            };
            updateCategoryTotal(category);
            updateTotals();
        };
        
        // Insert after "None" option
        const noneOption = radioGroup.querySelector('.none-option');
        if (noneOption) {
            noneOption.after(customLabel);
        } else {
            radioGroup.insertBefore(customLabel, radioGroup.firstChild);
        }
        
    } else {
        // For checkbox (multi-select) categories, add to the list
        state.items[category][customId] = {
            itemIdx: customId,
            qty: qty,
            price: price,
            name: name,
            isCustom: true,
            isTBD: false
        };
        
        // Add visual indicator
        const checkboxGroup = document.getElementById(`checkbox-${catId}`);
        
        const customLabel = document.createElement('label');
        customLabel.className = 'checkbox-option selected custom-added-item';
        customLabel.id = `chk-${catId}-${customId}`;
        customLabel.innerHTML = `
            <input type="checkbox" checked>
            <div class="option-details">
                <div class="option-name">✨ ${name}</div>
            </div>
            <div class="qty-stepper">
                <button type="button" onclick="event.stopPropagation();updateCustomQty('${category}', '${customId}', Math.max(0,parseInt(this.nextElementSibling.value)||0)-1+'');this.nextElementSibling.value=Math.max(0,parseInt(this.nextElementSibling.value)||0)" tabindex="-1">−</button>
                <input type="number" value="${qty}" min="0" max="99" onchange="updateCustomQty('${category}', '${customId}', this.value)" onclick="event.stopPropagation()">
                <button type="button" onclick="event.stopPropagation();updateCustomQty('${category}', '${customId}', Math.min(99,parseInt(this.previousElementSibling.value)||0)+1+'');this.previousElementSibling.value=Math.min(99,parseInt(this.previousElementSibling.value)||0)" tabindex="-1">+</button>
            </div>
            <div class="option-price" style="color:var(--success);">$${fmt(price)}</div>
            <div class="option-extended" style="color:var(--success);">$${fmt(price * qty)}</div>
        `;
        
        // Insert before the custom-item-row
        const customRow = checkboxGroup.querySelector('.custom-item-row');
        if (customRow) {
            checkboxGroup.insertBefore(customLabel, customRow);
        } else {
            checkboxGroup.appendChild(customLabel);
        }
        
        // Add click handler to toggle
        customLabel.querySelector('input[type="checkbox"]').onchange = function() {
            if (this.checked) {
                customLabel.classList.add('selected');
                state.items[category][customId] = {
                    itemIdx: customId,
                    qty: parseInt(customLabel.querySelector('input[type="number"]').value) || 1,
                    price: price,
                    name: name,
                    isCustom: true,
                    isTBD: false
                };
            } else {
                customLabel.classList.remove('selected');
                delete state.items[category][customId];
            }
            updateCategoryTotal(category);
            updateTotals();
        };
    }
    
    // Clear inputs
    nameInput.value = '';
    priceInput.value = '';
    if (qtyInput) qtyInput.value = '1';
    
    updateCategoryTotal(category);
    updateTotals();
}

// Update custom item quantity
function updateCustomQty(category, customId, value) {
    const qty = parseInt(value) || 0;
    
    if (qty > 0 && state.items[category] && state.items[category][customId]) {
        state.items[category][customId].qty = qty;
        
        // Update extended display
        const catId = category.replace(/[^a-zA-Z0-9]/g, '');
        const label = document.getElementById(`chk-${catId}-${customId}`);
        if (label) {
            const price = state.items[category][customId].price;
            const extDiv = label.querySelector('.option-extended');
            if (extDiv) {
                extDiv.textContent = '$' + fmt(price * qty);
            }
        }
    } else if (qty === 0 && state.items[category]) {
        delete state.items[category][customId];
        // Uncheck the checkbox
        const catId = category.replace(/[^a-zA-Z0-9]/g, '');
        const label = document.getElementById(`chk-${catId}-${customId}`);
        if (label) {
            label.classList.remove('selected');
            const checkbox = label.querySelector('input[type="checkbox"]');
            if (checkbox) checkbox.checked = false;
        }
    }
    
    updateCategoryTotal(category);
    updateTotals();
}

function buildCategories() {
    const container = document.getElementById('categoriesContainer');
    container.innerHTML = '';
    
    if (!state.boatType) return;
    
    const accessories = ACCESSORIES[state.boatType];
    const groups = CATEGORY_GROUPS[state.boatType];
    const selectedSize = getSelectedSize();
    
    document.getElementById('selectedBoatLabel').textContent = 
        `${BOATS[state.boatType].name} - ${selectedSize}`;
    
    // Track exclusive categories to initialize with "None"
    const exclusiveCategories = [];
    
    // Build each main group
    groups.forEach((group, groupIdx) => {
        let groupHtml = '';
        let groupHasItems = false;
        
        // Build regular categories within this group
        if (group.categories) {
            group.categories.forEach(cat => {
                const result = buildCategoryHtml(cat, accessories, selectedSize, group.flat, group);
                if (result.hasItems) {
                    groupHasItems = true;
                    if (result.isExclusive) {
                        exclusiveCategories.push(result.cat);
                    }
                    if (group.flat) {
                        container.innerHTML += result.html;
                    } else {
                        groupHtml += result.html;
                    }
                }
            });
        }
        
        // Build subgroups (e.g., Seating containing Leaning Posts, Jockey, etc.)
        if (group.subgroups) {
            group.subgroups.forEach((subgroup, subgroupIdx) => {
                let subgroupHtml = '';
                let subgroupHasItems = false;
                
                subgroup.categories.forEach(cat => {
                    const result = buildCategoryHtml(cat, accessories, selectedSize, false, null);
                    if (result.hasItems) {
                        subgroupHasItems = true;
                        groupHasItems = true;
                        if (result.isExclusive) {
                            exclusiveCategories.push(result.cat);
                        }
                        subgroupHtml += result.html;
                    }
                });
                
                if (subgroupHasItems) {
                    const subgroupId = `subgroup-${groupIdx}-${subgroupIdx}`;
                    groupHtml += `
                        <div class="subgroup">
                            <div class="subgroup-header" onclick="toggleSubgroup('${subgroupId}')">
                                <h4>${subgroup.name}</h4>
                                <div class="subgroup-meta">
                                    <span class="subgroup-total" id="subgroupTotal-${subgroupId}">$0</span>
                                    <span class="subgroup-arrow">▼</span>
                                </div>
                            </div>
                            <div class="subgroup-content" id="${subgroupId}">
                                <div class="subgroup-inner">
                                    ${subgroupHtml}
                                </div>
                            </div>
                        </div>`;
                }
            });
        }
        
        // Build postCategories (rendered after subgroups, e.g. Trailers at end)
        if (group.postCategories) {
            group.postCategories.forEach(cat => {
                const result = buildCategoryHtml(cat, accessories, selectedSize, group.flat, group);
                if (result.hasItems) {
                    groupHasItems = true;
                    if (result.isExclusive) {
                        exclusiveCategories.push(result.cat);
                    }
                    if (group.flat) {
                        container.innerHTML += result.html;
                    } else {
                        groupHtml += result.html;
                    }
                }
            });
        }
        
        if (!groupHasItems) return;
        
        // Determine color class based on group name
        let colorClass = '';
        if (group.name.toLowerCase().includes('engine') || group.name.toLowerCase().includes('propulsion')) {
            colorClass = 'main-group-engine';
        } else if (group.name.toLowerCase().includes('accessories') || group.name.toLowerCase().includes('asis')) {
            colorClass = 'main-group-accessories';
        } else if (group.name.toLowerCase().includes('electronic') || group.name.toLowerCase().includes('communication')) {
            colorClass = 'main-group-electronics';
        }
        
        // For non-flat groups, wrap in main group container
        if (!group.flat && groupHtml) {
            const groupId = 'group-' + groupIdx;
            container.innerHTML += `
                <div class="main-group ${colorClass}">
                    <div class="main-group-header" onclick="toggleMainGroup('${groupId}')">
                        <h2><span class="group-icon">${group.icon}</span> ${group.name}</h2>
                        <div class="group-meta">
                            <span class="group-total" id="groupTotal-${groupIdx}">$0</span>
                            <span class="group-arrow">▼</span>
                        </div>
                    </div>
                    <div class="main-group-content" id="${groupId}">
                        <div class="main-group-inner">
                            ${groupHtml}
                        </div>
                    </div>
                </div>`;
        }
    });
    
    // Initialize exclusive categories with "None" selected ONLY if not already set
    exclusiveCategories.forEach(cat => {
        if (!state.items[cat] || !state.items[cat]['radio']) {
            if (!state.items[cat]) state.items[cat] = {};
            state.items[cat]['radio'] = {itemIdx: -1, qty: 0, price: 0, name: 'None', isCustom: false, isTBD: false};
        }
        // Update total to reflect current selection
        updateCategoryTotal(cat);
    });
    
    // Restore visual selections from state.items
    restoreSelections();
}

// Restore visual selections from state.items after rebuilding categories
function restoreSelections() {
    Object.entries(state.items).forEach(([category, items]) => {
        const catId = category.replace(/[^a-zA-Z0-9]/g, '');
        
        Object.entries(items).forEach(([key, item]) => {
            if (key === 'radio' && item.itemIdx !== -1) {
                if (item.isCustom) {
                    // Restore custom radio item
                    const radioGroup = document.getElementById('radio-' + catId);
                    if (radioGroup) {
                        radioGroup.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
                        const noneRadio = radioGroup.querySelector('.none-option input[type="radio"]');
                        if (noneRadio) noneRadio.checked = false;
                        
                        const customLabel = document.createElement('label');
                        customLabel.className = 'radio-option selected custom-added-item';
                        customLabel.innerHTML = `
                            <input type="radio" name="radio-${catId}" value="${item.itemIdx}" checked>
                            <div class="option-details"><div class="option-name">✨ ${item.name}</div></div>
                            <div class="option-price" style="color:var(--success);">$${fmt(item.price)}</div>
                        `;
                        const noneOption = radioGroup.querySelector('.none-option');
                        if (noneOption) noneOption.after(customLabel);
                    }
                } else {
                    // Regular radio option - restore selection
                    const radioGroup = document.getElementById('radio-' + catId);
                    if (radioGroup) {
                        radioGroup.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
                        const noneRadio = radioGroup.querySelector('.none-option input[type="radio"]');
                        if (noneRadio) noneRadio.checked = false;
                    }
                    
                    const radioOpt = document.getElementById(`radio-opt-${catId}-${item.itemIdx}`);
                    if (radioOpt) {
                        radioOpt.classList.add('selected');
                        const radioInput = radioOpt.querySelector('input[type="radio"]');
                        if (radioInput) radioInput.checked = true;
                        
                        // Restore qty if applicable
                        const qtyInput = document.getElementById(`qty-radio-${catId}-${item.itemIdx}`);
                        if (qtyInput && item.qty > 0) {
                            qtyInput.value = item.qty;
                            const extEl = document.getElementById(`ext-radio-${catId}-${item.itemIdx}`);
                            if (extEl && !item.isTBD) {
                                extEl.textContent = '$' + (item.price * item.qty).toLocaleString();
                            }
                        }
                    }
                }
            } else if (String(key).startsWith('custom-')) {
                // Restore custom checkbox item
                const checkboxGroup = document.getElementById('checkbox-' + catId);
                if (checkboxGroup && item.qty > 0) {
                    const customLabel = document.createElement('label');
                    customLabel.className = 'checkbox-option selected custom-added-item';
                    customLabel.id = `chk-${catId}-${key}`;
                    customLabel.innerHTML = `
                        <input type="checkbox" checked>
                        <div class="option-details"><div class="option-name">✨ ${item.name}</div></div>
                        <div class="qty-stepper">
                            <button type="button" onclick="event.stopPropagation();updateCustomQty('${category}','${key}',Math.max(0,parseInt(this.nextElementSibling.value)||0)-1+'');this.nextElementSibling.value=Math.max(0,parseInt(this.nextElementSibling.value)||0)" tabindex="-1">−</button>
                            <input type="number" value="${item.qty}" min="0" max="99" onchange="updateCustomQty('${category}','${key}',this.value)" onclick="event.stopPropagation()">
                            <button type="button" onclick="event.stopPropagation();updateCustomQty('${category}','${key}',Math.min(99,parseInt(this.previousElementSibling.value)||0)+1+'');this.previousElementSibling.value=Math.min(99,parseInt(this.previousElementSibling.value)||0)" tabindex="-1">+</button>
                        </div>
                        <div class="option-price" style="color:var(--success);">$${fmt(item.price)}</div>
                        <div class="option-extended" style="color:var(--success);">$${fmt(item.price * item.qty)}</div>
                    `;
                    const customRow = checkboxGroup.querySelector('.custom-item-row');
                    if (customRow) checkboxGroup.insertBefore(customLabel, customRow);
                    else checkboxGroup.appendChild(customLabel);
                }
            } else if (key !== 'radio') {
                // Checkbox option - restore selection (key can be number or string)
                const checkOpt = document.getElementById(`chk-${catId}-${key}`);
                if (checkOpt) {
                    checkOpt.classList.add('selected');
                    const checkbox = checkOpt.querySelector('input[type="checkbox"]');
                    if (checkbox) checkbox.checked = true;
                    
                    // Restore qty
                    const qtyInput = checkOpt.querySelector('.qty-stepper input[type="number"]');
                    if (qtyInput && item.qty > 0) {
                        qtyInput.value = item.qty;
                    }
                    
                    // Update extended price
                    const extEl = checkOpt.querySelector('.option-extended');
                    if (extEl && !item.isTBD) {
                        extEl.textContent = '$' + (item.price * item.qty).toLocaleString();
                    }
                }
            }
        });
        
        // Update category total
        updateCategoryTotal(category);
    });
    
    // Update all totals
    updateTotals();
}

function toggleMainGroup(groupId) {
    const content = document.getElementById(groupId);
    const header = content.previousElementSibling;
    content.classList.toggle('open');
    header.classList.toggle('open');
}

function toggleSubgroup(subgroupId) {
    const content = document.getElementById(subgroupId);
    const header = content.previousElementSibling;
    content.classList.toggle('open');
    header.classList.toggle('open');
}

function toggleCategory(catId) {
    const content = document.getElementById('content-' + catId);
    const header = content.previousElementSibling;
    content.classList.toggle('open');
    header.classList.toggle('open');
}

function addItem(category) {
    const catId = category.replace(/[^a-zA-Z0-9]/g, '');
    const itemsDiv = document.getElementById('items-' + catId);
    const id = ++itemCounter;
    const selectedSize = getSelectedSize();
    const accessories = ACCESSORIES[state.boatType][category];
    
    // Build options - only show items available for this size
    let options = '<option value="">-- Select Item --</option>';
    accessories.forEach((item, i) => {
        const price = item.prices[selectedSize];
        if (price === 'X' || price === undefined) return; // Skip unavailable
        
        let priceDisplay;
        if (price === 'TBD') {
            priceDisplay = 'TBD';
        } else if (price === 'Incl.') {
            priceDisplay = 'Included';
        } else {
            priceDisplay = '$' + fmt(price);
        }
        options += `<option value="${i}">${item.name} - ${priceDisplay}</option>`;
    });
    options += '<option value="custom">+ Custom Item</option>';
    
    const row = document.createElement('div');
    row.className = 'item-row';
    row.id = 'row-' + id;
    row.innerHTML = `
        <select onchange="itemSelected(this, '${category}', ${id})">${options}</select>
        <input type="number" value="0" min="0" id="qty-${id}" onchange="updateItemQty(${id}, '${category}')">
        <input type="text" class="price-input" id="price-${id}" value="$0" onchange="updateItemPrice(${id}, '${category}')">
        <div class="extended" id="ext-${id}">$0</div>
        <button class="delete-btn" onclick="removeItem(${id}, '${category}')">×</button>
    `;
    itemsDiv.appendChild(row);
    
    if (!state.items[category]) state.items[category] = {};
    state.items[category][id] = {itemIdx: null, qty: 0, price: 0, name: '', isCustom: false, isTBD: false};
}

function itemSelected(select, category, id) {
    const val = select.value;
    const priceInput = document.getElementById('price-' + id);
    const extDiv = document.getElementById('ext-' + id);
    const selectedSize = getSelectedSize();
    
    if (val === 'custom') {
        const parent = select.parentElement;
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'custom-input';
        input.placeholder = 'Enter custom item name...';
        input.id = 'name-' + id;
        input.onchange = () => updateCustomItem(id, category);
        parent.replaceChild(input, select);
        
        state.items[category][id].isCustom = true;
        state.items[category][id].itemIdx = -1;
        priceInput.value = '$0';
        priceInput.focus();
    } else if (val !== '') {
        const itemIdx = parseInt(val);
        const item = ACCESSORIES[state.boatType][category][itemIdx];
        const price = item.prices[selectedSize];
        
        state.items[category][id].itemIdx = itemIdx;
        state.items[category][id].name = item.name;
        
        if (price === 'TBD') {
            state.items[category][id].price = 0;
            state.items[category][id].isTBD = true;
            priceInput.value = 'TBD';
            priceInput.disabled = true;
            extDiv.innerHTML = '<span class="tbd">TBD</span>';
        } else if (price === 'Incl.') {
            state.items[category][id].price = 0;
            state.items[category][id].isTBD = false;
            priceInput.value = 'Included';
            priceInput.disabled = true;
            extDiv.textContent = 'Incl.';
        } else {
            state.items[category][id].price = price;
            state.items[category][id].isTBD = false;
            priceInput.value = '$' + fmt(price);
            priceInput.disabled = false;
        }
    } else {
        state.items[category][id].itemIdx = null;
        state.items[category][id].price = 0;
        state.items[category][id].name = '';
        state.items[category][id].isTBD = false;
        priceInput.value = '$0';
        priceInput.disabled = false;
    }
    
    updateItemExtended(id, category);
    updateCategoryTotal(category);
    updateTotals();
}

function updateCustomItem(id, category) {
    const nameInput = document.getElementById('name-' + id);
    state.items[category][id].name = nameInput.value;
}

function updateItemQty(id, category) {
    const qty = parseInt(document.getElementById('qty-' + id).value) || 1;
    state.items[category][id].qty = qty;
    updateItemExtended(id, category);
    updateCategoryTotal(category);
    updateTotals();
}

function updateItemPrice(id, category) {
    const priceInput = document.getElementById('price-' + id);
    const price = parseFloat(priceInput.value.replace(/[^0-9.]/g, '')) || 0;
    state.items[category][id].price = price;
    priceInput.value = '$' + fmt(price);
    updateItemExtended(id, category);
    updateCategoryTotal(category);
    updateTotals();
}

function updateItemExtended(id, category) {
    const item = state.items[category][id];
    if (item.isTBD) {
        document.getElementById('ext-' + id).innerHTML = '<span class="tbd">TBD</span>';
    } else {
        const extended = item.price * item.qty;
        document.getElementById('ext-' + id).textContent = '$' + fmt(extended);
    }
}

function removeItem(id, category) {
    document.getElementById('row-' + id).remove();
    delete state.items[category][id];
    updateCategoryTotal(category);
    updateTotals();
}

function updateCategoryTotal(category) {
    const catId = category.replace(/[^a-zA-Z0-9]/g, '');
    let total = 0;
    let selectedCount = 0;
    
    if (state.items[category]) {
        Object.values(state.items[category]).forEach(item => {
            // Check if this is a real selection (not "None" which has itemIdx -1)
            if (item.itemIdx !== -1 && item.qty > 0) {
                selectedCount++;
                if (item.price && !item.isTBD) {
                    total += item.price * item.qty;
                }
            }
        });
    }
    
    const el = document.getElementById('catTotal-' + catId);
    if (el) {
        el.textContent = '$' + fmt(total);
        el.style.display = 'inline-block';
        el.classList.toggle('has-value', total > 0);
    }
    
    // Update selected count badge
    const countEl = document.getElementById('catSelCount-' + catId);
    if (countEl) {
        countEl.textContent = selectedCount + ' selected';
        countEl.classList.toggle('visible', selectedCount > 0);
    }
}

// ==================== TOTALS ====================
function updateTotals() {
    const boatQty = parseInt(document.getElementById('boatQty')?.value) || 1;
    const basePerBoat = state.boatType && state.sizeIdx !== null ? BOATS[state.boatType].sizes[state.sizeIdx].price : 0;
    const base = basePerBoat * boatQty;
    let optionsPerBoat = 0;
    
    // Category breakdown
    const engineCats = ["Propulsion / Engine", "Engine"];
    const electronicsCats = ["GPS", "Radar", "VHF", "Other Communication", "FLIR / Thermal", "Lighting & Electrical"];
    let engineTotal = 0, accessoriesTotal = 0, electronicsTotal = 0;
    
    Object.entries(state.items).forEach(([cat, items]) => {
        Object.values(items).forEach(item => {
            if (item.price && item.qty && !item.isTBD) {
                const amt = item.price * item.qty;
                optionsPerBoat += amt;
                if (engineCats.includes(cat)) engineTotal += amt;
                else if (electronicsCats.includes(cat)) electronicsTotal += amt;
                else accessoriesTotal += amt;
            }
        });
    });
    
    const options = optionsPerBoat * boatQty;
    const subtotal = base + options;
    const discountPct = parseFloat(document.getElementById('discount')?.value) || 0;
    const discount = subtotal * (discountPct / 100);
    const total = subtotal - discount;
    
    // Update summaries
    const qtyLabel = boatQty > 1 ? ` (×${boatQty})` : '';
    document.getElementById('sumType').textContent = state.boatType ? BOATS[state.boatType].name : '-';
    document.getElementById('sumSize').textContent = state.sizeIdx !== null ? BOATS[state.boatType].sizes[state.sizeIdx].size : '-';
    document.getElementById('sumBase').textContent = basePerBoat ? fmtPrice(base) + qtyLabel : '-';
    document.getElementById('sumOptions').textContent = fmtPrice(options);
    document.getElementById('sumTotal').textContent = fmtPrice(total);
    
    const sumTotal2 = document.getElementById('sumTotal2');
    if (sumTotal2) sumTotal2.textContent = fmtPrice(total);
    
    // Update sidebar category breakdown
    const breakdown = document.getElementById('sidebarBreakdown');
    if (breakdown) {
        const hasOptions = optionsPerBoat > 0;
        breakdown.style.display = hasOptions ? 'block' : 'none';
        document.getElementById('sideEngine').textContent = fmtPrice(engineTotal * boatQty);
        document.getElementById('sideAccessories').textContent = fmtPrice(accessoriesTotal * boatQty);
        document.getElementById('sideElectronics').textContent = fmtPrice(electronicsTotal * boatQty);
    }
    
    const sumSub3 = document.getElementById('sumSub3');
    if (sumSub3) sumSub3.textContent = fmtPrice(subtotal);
    const sumDisc3 = document.getElementById('sumDisc3');
    if (sumDisc3) sumDisc3.textContent = '-' + fmtPrice(discount);
    const sumTotal3 = document.getElementById('sumTotal3');
    if (sumTotal3) sumTotal3.textContent = fmtPrice(total);
    
    // Update selected items list
    updateSelectedItemsList();
    
    // Trigger autosave on any change
    if (currentUser && document.getElementById('editorScreen')?.style.display !== 'none') {
        triggerAutosave();
    }
}

function updateSelectedItemsList() {
    const list = document.getElementById('selectedItemsList');
    if (!list) return;
    const boatQty = parseInt(document.getElementById('boatQty')?.value) || 1;
    
    let html = '';
    if (state.boatType && state.sizeIdx !== null) {
        const boatPrice = BOATS[state.boatType].sizes[state.sizeIdx].price * boatQty;
        const qtyLabel = boatQty > 1 ? `${boatQty}× ` : '';
        html += `<div class="sel-item sel-item-boat"><span class="name">🚤 ${qtyLabel}${BOATS[state.boatType].sizes[state.sizeIdx].size} ${BOATS[state.boatType].name}</span><span class="amt">${fmtPrice(boatPrice)}</span></div>`;
    }
    
    let itemCount = 0;
    Object.entries(state.items).forEach(([cat, items]) => {
        Object.values(items).forEach(item => {
            // Skip "None" selections (itemIdx === -1)
            if (item.name && item.itemIdx !== -1 && item.qty > 0) {
                itemCount++;
                const totalQty = item.qty * boatQty;
                const amt = item.isTBD ? 'TBD' : fmtPrice(item.price * item.qty * boatQty);
                html += `<div class="sel-item"><span class="name">${totalQty}× ${item.name}</span><span class="amt">${amt}</span></div>`;
            }
        });
    });
    
    if (!html) {
        list.innerHTML = '<div style="color:var(--gray-500);font-size:12px;padding:10px 0;text-align:center;">No items selected yet</div>';
    } else {
        list.innerHTML = html;
        if (itemCount > 0) {
            list.innerHTML += `<div style="color:var(--gray-500);font-size:10px;text-align:center;padding-top:6px;border-top:1px solid rgba(255,255,255,0.06);margin-top:4px;">${itemCount} accessory item${itemCount !== 1 ? 's' : ''}</div>`;
        }
    }
}

// ==================== CURRENCY ====================
function setCurrency(curr) {
    state.currency = curr;
    document.querySelectorAll('.curr-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll(`.curr-btn`).forEach(b => {
        if (b.textContent === curr) b.classList.add('active');
    });
    const sizesCurrLabel = document.getElementById('sizesCurrLabel');
    if (sizesCurrLabel) sizesCurrLabel.textContent = curr;
    if (state.boatType) renderBoatSizes();
    updateTotals();
}

// ==================== NAVIGATION ====================
function goTo(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page' + page).classList.add('active');
    
    document.querySelectorAll('.step').forEach((s, i) => {
        s.classList.remove('active', 'done');
        if (i + 1 < page) s.classList.add('done');
        if (i + 1 === page) s.classList.add('active');
    });
    
    if (page === 1) {
        // Enable Continue button if a boat is already selected
        if (state.boatType && state.sizeIdx !== null) {
            document.getElementById('nextBtn1').disabled = false;
        }
    }
    if (page === 2) {
        buildCategories();
        // Auto-open all categories
        openAllCategories();
        // Clear search
        const searchInput = document.getElementById('configSearchInput');
        if (searchInput) searchInput.value = '';
        const clearBtn = document.getElementById('clearSearchBtn');
        if (clearBtn) clearBtn.classList.remove('visible');
        const noResults = document.getElementById('searchNoResults');
        if (noResults) noResults.classList.remove('visible');
    }
    if (page === 3) {
        // Set default quotation title based on boat type and size
        const titleField = document.getElementById('quoteTitle');
        if (!titleField.value) {
            const size = getSelectedSize();
            const boatType = state.boatType;
            if (size && boatType) {
                let typeName = '';
                if (boatType === 'aluminum') typeName = 'Aluminum RIB Boats';
                else if (boatType === 'fiberglass') typeName = 'Fiberglass RIB Boats';
                else if (boatType === 'inflatable') typeName = 'Inflatable Boats';
                titleField.value = `${size} ${typeName}`;
            }
        }
    }
    if (page === 4) {
        buildPreview();
    }
    
    window.scrollTo(0, 0);
}

// Open all categories, main groups, and subgroups
function openAllCategories() {
    // Open all main groups
    document.querySelectorAll('.main-group-content').forEach(content => {
        content.classList.add('open');
        content.previousElementSibling.classList.add('open');
    });
    
    // Open all subgroups
    document.querySelectorAll('.subgroup-content').forEach(content => {
        content.classList.add('open');
        content.previousElementSibling.classList.add('open');
    });
    
    // Open all categories
    document.querySelectorAll('.cat-content').forEach(content => {
        content.classList.add('open');
        content.previousElementSibling.classList.add('open');
    });
    
    // Update button text
    const btn = document.getElementById('toggleAllBtn');
    if (btn) btn.innerHTML = '▲ Collapse All';
    state.allExpanded = true;
}

function closeAllCategories() {
    // Close all main groups
    document.querySelectorAll('.main-group-content').forEach(content => {
        content.classList.remove('open');
        content.previousElementSibling.classList.remove('open');
    });
    
    // Close all subgroups
    document.querySelectorAll('.subgroup-content').forEach(content => {
        content.classList.remove('open');
        content.previousElementSibling.classList.remove('open');
    });
    
    // Close all categories
    document.querySelectorAll('.cat-content').forEach(content => {
        content.classList.remove('open');
        content.previousElementSibling.classList.remove('open');
    });
    
    // Update button text
    const btn = document.getElementById('toggleAllBtn');
    if (btn) btn.innerHTML = '▼ Expand All';
    state.allExpanded = false;
}

// ==================== SEARCH & STEPPER ====================
function handleConfigSearch(query) {
    const clearBtn = document.getElementById('clearSearchBtn');
    clearBtn.classList.toggle('visible', query.length > 0);
    
    const q = query.toLowerCase().trim();
    const container = document.getElementById('categoriesContainer');
    const noResults = document.getElementById('searchNoResults');
    
    if (!q) {
        // Clear search - show everything
        container.querySelectorAll('.search-hidden, .search-hidden-cat, .search-hidden-group, .search-hidden-sub').forEach(el => {
            el.classList.remove('search-hidden', 'search-hidden-cat', 'search-hidden-group', 'search-hidden-sub');
        });
        // Remove highlights
        container.querySelectorAll('.search-highlight').forEach(el => {
            el.replaceWith(el.textContent);
        });
        noResults.classList.remove('visible');
        return;
    }
    
    let anyVisible = false;
    
    // First, reset all
    container.querySelectorAll('.search-hidden, .search-hidden-cat, .search-hidden-group, .search-hidden-sub').forEach(el => {
        el.classList.remove('search-hidden', 'search-hidden-cat', 'search-hidden-group', 'search-hidden-sub');
    });
    // Remove old highlights
    container.querySelectorAll('.search-highlight').forEach(el => {
        el.replaceWith(el.textContent);
    });
    
    // Search through items
    container.querySelectorAll('.radio-option, .checkbox-option').forEach(opt => {
        const name = opt.getAttribute('data-item-name') || '';
        if (name && name.includes(q)) {
            opt.classList.remove('search-hidden');
            anyVisible = true;
        } else if (opt.classList.contains('none-option')) {
            // Always show "none" option if its category has visible items
            opt.classList.remove('search-hidden');
        } else {
            opt.classList.add('search-hidden');
        }
    });
    
    // Hide categories with no visible items
    container.querySelectorAll('.category').forEach(cat => {
        const visibleItems = cat.querySelectorAll('.radio-option:not(.search-hidden):not(.none-option), .checkbox-option:not(.search-hidden)');
        // Also check if category name matches
        const catName = (cat.getAttribute('data-category') || '').toLowerCase();
        if (visibleItems.length > 0 || catName.includes(q)) {
            cat.classList.remove('search-hidden-cat');
            if (catName.includes(q)) {
                // Show all items in matching category
                cat.querySelectorAll('.search-hidden').forEach(el => el.classList.remove('search-hidden'));
                anyVisible = true;
            }
            // Auto-open matching categories
            const content = cat.querySelector('.cat-content');
            const header = cat.querySelector('.cat-header');
            if (content && !content.classList.contains('open')) {
                content.classList.add('open');
                if (header) header.classList.add('open');
            }
        } else {
            cat.classList.add('search-hidden-cat');
        }
    });
    
    // Hide main groups with no visible categories
    container.querySelectorAll('.main-group').forEach(group => {
        const visibleCats = group.querySelectorAll('.category:not(.search-hidden-cat)');
        if (visibleCats.length > 0) {
            group.classList.remove('search-hidden-group');
            // Auto-open group
            const content = group.querySelector('.main-group-content');
            const header = group.querySelector('.main-group-header');
            if (content && !content.classList.contains('open')) {
                content.classList.add('open');
                if (header) header.classList.add('open');
            }
        } else {
            group.classList.add('search-hidden-group');
        }
    });
    
    // Hide flat categories with no visible items
    container.querySelectorAll('.flat-category').forEach(flat => {
        const visibleItems = flat.querySelectorAll('.radio-option:not(.search-hidden):not(.none-option), .checkbox-option:not(.search-hidden)');
        const catName = (flat.getAttribute('data-category') || flat.querySelector('.cat-header h3')?.textContent || '').toLowerCase();
        if (visibleItems.length > 0 || catName.includes(q)) {
            flat.classList.remove('search-hidden-cat');
            anyVisible = true;
        } else {
            flat.classList.add('search-hidden-cat');
        }
    });
    
    // Hide subgroups with no visible categories
    container.querySelectorAll('.subgroup').forEach(sub => {
        const visibleCats = sub.querySelectorAll('.category:not(.search-hidden-cat)');
        if (visibleCats.length > 0) {
            sub.classList.remove('search-hidden-sub');
            // Auto-open
            const content = sub.querySelector('.subgroup-content');
            const header = sub.querySelector('.subgroup-header');
            if (content && !content.classList.contains('open')) {
                content.classList.add('open');
                if (header) header.classList.add('open');
            }
        } else {
            sub.classList.add('search-hidden-sub');
        }
    });
    
    noResults.classList.toggle('visible', !anyVisible);
}

function clearConfigSearch() {
    const input = document.getElementById('configSearchInput');
    if (input) {
        input.value = '';
        handleConfigSearch('');
        input.focus();
    }
}

function stepQty(category, idx, delta, type) {
    const catId = category.replace(/[^a-zA-Z0-9]/g, '');
    let inputId, updateFn;
    
    if (type === 'chk') {
        inputId = `qty-${catId}-${idx}`;
        updateFn = () => updateCheckboxQty(category, idx);
    } else {
        // radio type
        inputId = `qty-radio-${catId}-${idx}`;
        updateFn = () => updateRadioQty(category, idx);
    }
    
    const input = document.getElementById(inputId);
    if (!input) return;
    
    let val = parseInt(input.value) || 0;
    val = Math.max(0, Math.min(99, val + delta));
    input.value = val;
    
    // If checkbox type, auto-check when incrementing from 0
    if (type === 'chk' && delta > 0 && val === 1) {
        const chkEl = document.getElementById(`chk-${catId}-${idx}`);
        if (chkEl) {
            const checkbox = chkEl.querySelector('input[type="checkbox"]');
            if (checkbox && !checkbox.checked) {
                checkbox.checked = true;
                toggleCheckboxOption(category, idx, checkbox);
                return; // toggleCheckboxOption already handles qty
            }
        }
    }
    
    // If radio type and incrementing from 0, auto-select this option
    if (type === 'radio' && delta > 0 && val === 1) {
        const radioOpt = document.getElementById(`radio-opt-${catId}-${idx}`);
        if (radioOpt && !radioOpt.classList.contains('selected')) {
            selectRadioOptionWithQty(category, idx, radioOpt);
            return; // selectRadioOptionWithQty handles everything
        }
    }
    
    updateFn();
}

function toggleAllCategories() {
    if (state.allExpanded) {
        closeAllCategories();
    } else {
        openAllCategories();
    }
}

// ==================== PREVIEW ====================
function buildPreview() {
    const boat = BOATS[state.boatType].sizes[state.sizeIdx];
    const boatQty = parseInt(document.getElementById('boatQty')?.value) || 1;
    const salesmanInfo = getSalesmanInfo();
    const tender = document.getElementById('tenderNum').value;
    const quoteTitle = document.getElementById('quoteTitle').value;
    
    // Set quotation title in preview
    document.getElementById('prevQuoteTitle').textContent = quoteTitle;
    
    // Quote info with better organization
    let quoteInfoHtml = `
        <span class="label">Quote #:</span><span class="value">${document.getElementById('quoteNum').value}</span>
        <span class="label">Date:</span><span class="value">${document.getElementById('quoteDate').value}</span>
        <span class="label">Validity:</span><span class="value">${document.getElementById('validity').value}</span>
    `;
    if (salesmanInfo) {
        if (salesmanInfo.name) quoteInfoHtml += `<span class="label">Salesman:</span><span class="value">${salesmanInfo.name}</span>`;
        if (salesmanInfo.email) quoteInfoHtml += `<span class="label">Email:</span><span class="value">${salesmanInfo.email}</span>`;
        if (salesmanInfo.phone) quoteInfoHtml += `<span class="label">Phone:</span><span class="value">${salesmanInfo.phone}</span>`;
    }
    quoteInfoHtml += `
        <span class="label">Payment:</span><span class="value">${document.getElementById('payTerms').value}</span>
        <span class="label">Delivery Terms:</span><span class="value">${document.getElementById('deliveryTerms').value}</span>
        <span class="label">Timeline:</span><span class="value">${getDeliveryTimeline()}</span>
    `;
    document.getElementById('prevQuoteInfo').innerHTML = quoteInfoHtml;
    
    // Customer info with better organization
    let custInfoHtml = `
        <span class="label">Company:</span><span class="value">${document.getElementById('custCompany').value || '-'}</span>
        <span class="label">Contact:</span><span class="value">${document.getElementById('custName').value || '-'}</span>
        <span class="label">Email:</span><span class="value">${document.getElementById('custEmail').value || '-'}</span>
        <span class="label">Phone:</span><span class="value">${document.getElementById('custPhone').value || '-'}</span>
    `;
    if (tender) {
        custInfoHtml += `<span class="label">Tender #:</span><span class="value">${tender}</span>`;
    }
    const addr = document.getElementById('custAddr').value;
    if (addr) {
        custInfoHtml += `<span class="label">Address:</span><span class="value">${addr}</span>`;
    }
    document.getElementById('prevCustInfo').innerHTML = custInfoHtml;
    
    // Calculate totals first (per boat then multiply)
    let optionsPerBoat = 0;
    let engineTotal = 0;
    let accessoriesTotal = 0;
    let electronicsTotal = 0;
    
    // Categorize items by group
    const engineCats = ["Propulsion / Engine", "Engine"];
    const electronicsCats = ["GPS", "Radar", "VHF", "Other Communication", "FLIR / Thermal", "Lighting & Electrical"];
    
    Object.entries(state.items).forEach(([cat, items]) => {
        Object.values(items).forEach(item => {
            if (item.price && item.qty && !item.isTBD) {
                const itemTotal = item.price * item.qty;
                optionsPerBoat += itemTotal;
                
                if (engineCats.includes(cat)) {
                    engineTotal += itemTotal;
                } else if (electronicsCats.includes(cat)) {
                    electronicsTotal += itemTotal;
                } else {
                    accessoriesTotal += itemTotal;
                }
            }
        });
    });
    
    const boatTotal = boat.price * boatQty;
    const optionsTotal = optionsPerBoat * boatQty;
    const subtotal = boatTotal + optionsTotal;
    const discountPct = parseFloat(document.getElementById('discount').value) || 0;
    const discount = subtotal * (discountPct / 100);
    const total = subtotal - discount;
    
    // Collect items grouped by type
    const engineItems = [];
    const accessoriesItems = [];
    const electronicsItems = [];
    
    Object.entries(state.items).forEach(([cat, items]) => {
        Object.values(items).forEach(item => {
            if (item.name && item.itemIdx !== -1 && item.qty > 0) {
                const itemData = {
                    name: item.name,
                    qty: item.qty * boatQty,
                    unitPrice: item.isTBD ? 'TBD' : fmtPrice(item.price),
                    total: item.isTBD ? 'TBD' : fmtPrice(item.price * item.qty * boatQty)
                };
                
                if (engineCats.includes(cat)) {
                    engineItems.push(itemData);
                } else if (electronicsCats.includes(cat)) {
                    electronicsItems.push(itemData);
                } else {
                    accessoriesItems.push(itemData);
                }
            }
        });
    });
    
    // Build items table - grouped by category
    let itemsHtml = '';
    
    // 1. Boat row (prominent)
    itemsHtml += `<tr class="cat-boat"><td><strong>${BOATS[state.boatType].name} - ${boat.size}</strong></td><td>${boatQty}</td><td class="right">${fmtPrice(boat.price)}</td><td class="right">${fmtPrice(boatTotal)}</td></tr>`;
    
    // 2. Engine section
    if (engineItems.length > 0) {
        itemsHtml += `<tr class="section-header"><td colspan="4">⚙️ ENGINE / PROPULSION</td></tr>`;
        engineItems.forEach(item => {
            itemsHtml += `<tr class="cat-engine"><td>${item.name}</td><td>${item.qty}</td><td class="right">${item.unitPrice}</td><td class="right">${item.total}</td></tr>`;
        });
    }
    
    // 3. ASIS Accessories section
    if (accessoriesItems.length > 0) {
        itemsHtml += `<tr class="section-header"><td colspan="4">🛠️ ASIS ACCESSORIES</td></tr>`;
        accessoriesItems.forEach(item => {
            itemsHtml += `<tr class="cat-accessories"><td>${item.name}</td><td>${item.qty}</td><td class="right">${item.unitPrice}</td><td class="right">${item.total}</td></tr>`;
        });
    }
    
    // 4. Electronics section
    if (electronicsItems.length > 0) {
        itemsHtml += `<tr class="section-header"><td colspan="4">📡 ELECTRONICS & COMMUNICATION</td></tr>`;
        electronicsItems.forEach(item => {
            itemsHtml += `<tr class="cat-electronics"><td>${item.name}</td><td>${item.qty}</td><td class="right">${item.unitPrice}</td><td class="right">${item.total}</td></tr>`;
        });
    }
    
    document.getElementById('prevItems').innerHTML = itemsHtml;
    
    // Totals - only show subtotal separately if there's a discount
    let totalsHtml = '';
    if (discountPct > 0) {
        totalsHtml = `
            <div>Subtotal: ${fmtPrice(subtotal)}</div>
            <div>Discount (${discountPct}%): -${fmtPrice(discount)}</div>
            <div class="grand">TOTAL: ${fmtPrice(total)}</div>
        `;
    } else {
        totalsHtml = `<div class="grand">TOTAL: ${fmtPrice(total)}</div>`;
    }
    document.getElementById('prevTotals').innerHTML = totalsHtml;
    
    // Notes
    const notes = document.getElementById('quoteNotes').value;
    if (notes) {
        document.getElementById('prevNotes').style.display = 'block';
        document.getElementById('prevNotesText').textContent = notes;
    } else {
        document.getElementById('prevNotes').style.display = 'none';
    }
}

// ==================== PDF CONFIGURATION ====================
// Base URL for static assets - change this to your Vercel deployment URL
const PDF_CONFIG = {
    // Set this to your Vercel URL when deployed, e.g., 'https://your-app.vercel.app'
    // For local testing, use relative paths or a local server
    baseUrl: '', // Leave empty for relative paths
    
    // Static PDF paths (relative to baseUrl)
    staticPdfs: {
        page1Template: '/assets/pdf/page1_template.pdf',
        companyPresentation: '/assets/pdf/company_presentation.pdf',
        termsConditions: '/assets/pdf/terms_conditions.pdf'
    },
    
    // Technical specs folder
    specsFolder: '/specs/',
    
    // Image assets
    images: {
        asusLogo: '/assets/images/asis_logo.jpg',
        asisDiamond: '/assets/images/asis_diamond.jpg',
        shield: '/assets/images/shield.png',
        arrow: '/assets/images/arrow.png',
        stamp: '/assets/images/stamp.png'
    }
};

// Helper function to get spec PDF filename based on boat type and size
function getSpecPdfFilename() {
    const boat = BOATS[state.boatType].sizes[state.sizeIdx];
    const sizeStr = boat.size.replace('.', '_').replace('M', '').toLowerCase();
    
    if (state.boatType === 'aluminum') {
        return `alu_${sizeStr}.pdf`;
    } else if (state.boatType === 'fiberglass') {
        return `grp_${sizeStr}.pdf`;
    } else if (state.boatType === 'inflatable') {
        return `hdib_${sizeStr}.pdf`;
    }
    return null;
}

// ==================== EXPORT ====================
async function downloadPDF() {
    const { PDFDocument, rgb, StandardFonts } = PDFLib;
    
    // Show loading indicator
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'Generating PDF...';
    btn.disabled = true;
    
    try {
        // Gather all form data
        const formData = gatherFormData();
        
        // Create the main PDF document
        const pdfDoc = await PDFDocument.create();
        
        // Embed fonts
        const helvetica = await pdfDoc.embedFont(StandardFonts.Helvetica);
        const helveticaBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
        const timesRoman = await pdfDoc.embedFont(StandardFonts.TimesRoman);
        const timesItalic = await pdfDoc.embedFont(StandardFonts.TimesRomanItalic);
        
        const fonts = { helvetica, helveticaBold, timesRoman, timesItalic };
        
        // Page 1: Cover Page
        await generateCoverPage(pdfDoc, fonts, formData);
        
        // Page 2: Company Presentation (static PDF)
        await embedStaticPdf(pdfDoc, PDF_CONFIG.staticPdfs.companyPresentation, 'Company Presentation');
        
        // Page 3: Quotation Details
        await generateQuotationPage(pdfDoc, fonts, formData);
        
        // Page 4: Annex (accessories list) - may be multiple pages
        await generateAnnexPages(pdfDoc, fonts, formData);
        
        // Page 5: Technical Specifications (boat-specific PDF)
        const specFilename = getSpecPdfFilename();
        if (specFilename) {
            await embedStaticPdf(pdfDoc, PDF_CONFIG.specsFolder + specFilename, 'Technical Specifications');
        }
        
        // Page 6: Terms & Conditions (static PDF)
        await embedStaticPdf(pdfDoc, PDF_CONFIG.staticPdfs.termsConditions, 'Terms & Conditions');
        
        // Add "Page X of Y" to every page (bottom-right corner)
        const allPages = pdfDoc.getPages();
        const totalPages = allPages.length;
        const goldColor = PDFLib.rgb(0.788, 0.659, 0.298); // ASIS gold
        
        for (let i = 0; i < totalPages; i++) {
            const pg = allPages[i];
            const { width } = pg.getSize();
            const bigNum = `${i + 1}`;
            const totalNum = `${totalPages}`;
            
            // Colors: always navy number with white outline
            const bigColor = PDFLib.rgb(0.059, 0.157, 0.278);
            const outlineColor = PDFLib.rgb(1, 1, 1);
            const smallColor = PDFLib.rgb(0.5, 0.5, 0.5);
            
            // Big bold page number
            const bigSize = 18;
            const bigWidth = fonts.helveticaBold.widthOfTextAtSize(bigNum, bigSize);
            const rightEdge = Math.min(width, 595) - 8; // Cap to A4 width so all pages align
            const baseY = 14;
            
            // Layout: [big number] [gold line] [of / total]
            const smallSize = 8;
            const ofText = 'of';
            const ofWidth = fonts.timesRoman.widthOfTextAtSize(ofText, smallSize);
            const totalWidth = fonts.timesRoman.widthOfTextAtSize(totalNum, smallSize);
            const smallBlockW = Math.max(ofWidth, totalWidth);
            
            const totalBlockW = bigWidth + 4 + smallBlockW; // 4px gap for gold line
            const startX = rightEdge - totalBlockW;
            
            // Draw big number with white outline for contrast
            // Draw outline in 8 directions
            for (const [ox, oy] of [[0.8,0],[-0.8,0],[0,0.8],[0,-0.8],[0.6,0.6],[-0.6,-0.6],[0.6,-0.6],[-0.6,0.6]]) {
                pg.drawText(bigNum, { x: startX + ox, y: baseY + oy, size: bigSize, font: fonts.helveticaBold, color: outlineColor });
            }
            // Draw main number on top
            pg.drawText(bigNum, { x: startX, y: baseY, size: bigSize, font: fonts.helveticaBold, color: bigColor });
            
            // Draw gold vertical line
            const lineX = startX + bigWidth + 1.5;
            pg.drawLine({
                start: { x: lineX, y: baseY - 2 },
                end: { x: lineX, y: baseY + 16 },
                thickness: 0.8,
                color: goldColor
            });
            
            // Draw "of" (top) and total (bottom) with white outline
            const smallX = lineX + 3;
            for (const [ox, oy] of [[0.5,0],[-0.5,0],[0,0.5],[0,-0.5]]) {
                pg.drawText(ofText, { x: smallX + ox, y: baseY + 8 + oy, size: smallSize, font: fonts.timesRoman, color: outlineColor });
                pg.drawText(totalNum, { x: smallX + ox, y: baseY - 1 + oy, size: smallSize, font: fonts.timesRoman, color: outlineColor });
            }
            pg.drawText(ofText, { x: smallX, y: baseY + 8, size: smallSize, font: fonts.timesRoman, color: smallColor });
            pg.drawText(totalNum, { x: smallX, y: baseY - 1, size: smallSize, font: fonts.timesRoman, color: smallColor });
        }
        
        // Save and download
        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${formData.quoteNum}.pdf`;
        link.click();
        URL.revokeObjectURL(url);
        showToast('PDF downloaded successfully', 'success', 2500);
        
    } catch (error) {
        console.error('PDF Generation Error:', error);
        showToast('Error generating PDF. Generating simplified version...', 'error', 5000);
        
        // Fallback: generate simplified PDF without static pages
        await generateSimplifiedPDF();
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

// Gather all form data into a single object
function gatherFormData() {
    const boat = BOATS[state.boatType].sizes[state.sizeIdx];
    const boatQty = parseInt(document.getElementById('boatQty')?.value) || 1;
    const salesmanInfo = getSalesmanInfo();
    const showCategoryTotals = document.getElementById('showCategoryTotals').checked;
    const showAllPrices = document.getElementById('showAllPrices').checked;
    
    // Calculate category totals
    let engineTotal = 0;
    let asiaAccessoriesTotal = 0;
    let electronicsTotal = 0;
    let engineName = '';
    
    const groups = CATEGORY_GROUPS[state.boatType] || [];
    
    Object.entries(state.items).forEach(([cat, items]) => {
        Object.values(items).forEach(item => {
            if (item.name && item.itemIdx !== -1 && item.qty > 0) {
                const itemTotal = item.isTBD ? 0 : (item.price * item.qty);
                
                if (cat === 'Propulsion / Engine' || cat === 'Engine') {
                    engineTotal += itemTotal;
                    engineName = item.name;
                } else {
                    // Check which group this category belongs to
                    for (const group of groups) {
                        if (group.categories && group.categories.includes(cat)) {
                            if (group.name === 'ASIS Accessories') {
                                asiaAccessoriesTotal += itemTotal;
                            } else if (group.name === 'Electronics & Communication') {
                                electronicsTotal += itemTotal;
                            }
                            break;
                        }
                        if (group.subgroups) {
                            for (const subgroup of group.subgroups) {
                                if (subgroup.categories && subgroup.categories.includes(cat)) {
                                    if (group.name === 'ASIS Accessories') {
                                        asiaAccessoriesTotal += itemTotal;
                                    }
                                    break;
                                }
                            }
                        }
                    }
                }
            }
        });
    });
    
    // Calculate totals
    const boatTotal = boat.price * boatQty;
    let optionsPerBoat = 0;
    Object.values(state.items).forEach(cat => {
        Object.values(cat).forEach(item => {
            if (item.price && item.qty && !item.isTBD && item.itemIdx !== -1) {
                optionsPerBoat += item.price * item.qty;
            }
        });
    });
    const optionsTotal = optionsPerBoat * boatQty;
    const subtotal = boatTotal + optionsTotal;
    const discountPct = parseFloat(document.getElementById('discount').value) || 0;
    const discount = subtotal * (discountPct / 100);
    const total = subtotal - discount;
    
    return {
        // Quote info
        quoteNum: document.getElementById('quoteNum').value || 'Q-000',
        quoteDate: document.getElementById('quoteDate').value || new Date().toLocaleDateString(),
        quoteTitle: document.getElementById('quoteTitle').value || `${boat.size} ${BOATS[state.boatType].name}`,
        tender: document.getElementById('tenderNum').value || '',
        
        // Customer info
        custCompany: document.getElementById('custCompany').value || '',
        custContact: document.getElementById('custName').value || '',
        custPhone: document.getElementById('custPhone').value || '',
        custEmail: document.getElementById('custEmail').value || '',
        custAddress: document.getElementById('custAddr').value || '',
        
        // Salesman info
        salesmanInfo,
        
        // Boat info
        boatType: state.boatType,
        boatTypeName: BOATS[state.boatType].name,
        boatSize: boat.size,
        boatPrice: boat.price,
        boatQty,
        boatTotal,
        
        // Engine
        engineName,
        engineTotal: engineTotal * boatQty,
        
        // Category totals
        asiaAccessoriesTotal: asiaAccessoriesTotal * boatQty,
        electronicsTotal: electronicsTotal * boatQty,
        
        // Overall totals
        optionsTotal,
        subtotal,
        discountPct,
        discount,
        total,
        
        // Currency
        currency: state.currency,
        
        // PDF Options
        showCategoryTotals,
        showAllPrices,
        
        // Terms
        paymentTerms: document.getElementById('payTerms').value || '',
        deliveryTimeline: getDeliveryTimeline(),
        deliveryTerms: document.getElementById('deliveryTerms').value || '',
        validity: document.getElementById('validity').value || '',
        notes: document.getElementById('quoteNotes').value || '',
        
        // Items for annex
        items: state.items,
        categoryGroups: CATEGORY_GROUPS[state.boatType] || []
    };
}

// ==================== PAGE 1: COVER PAGE (Using Template) ====================
async function generateCoverPage(pdfDoc, fonts, formData) {
    const { rgb } = PDFLib;
    
    try {
        // Try to load the page 1 template
        const templateUrl = PDF_CONFIG.baseUrl + PDF_CONFIG.staticPdfs.page1Template;
        const response = await fetch(templateUrl);
        
        if (!response.ok) {
            console.warn('Page 1 template not found, generating from scratch');
            await generateCoverPageFallback(pdfDoc, fonts, formData);
            return;
        }
        
        const templateBytes = await response.arrayBuffer();
        const templatePdf = await PDFLib.PDFDocument.load(templateBytes);
        const [templatePage] = await pdfDoc.copyPages(templatePdf, [0]);
        pdfDoc.addPage(templatePage);
        
        // Get the page we just added (last page)
        const page = pdfDoc.getPages()[pdfDoc.getPageCount() - 1];
        const { width, height } = page.getSize();
        
        // Colors
        const asiaRed = rgb(0.722, 0.196, 0.251); // #B83240
        const darkGray = rgb(0.3, 0.3, 0.3);
        const black = rgb(0, 0, 0);
        
        // === ADD DYNAMIC TEXT ON TOP OF TEMPLATE ===
        // Page 1 coordinates - adjust each field individually
        // To find these lines: search for "PAGE1_FIELD:" in your editor
        
        // PAGE1_FIELD: Quote Number (right-aligned, right edge position)
        const quoteNumWidth = fonts.helveticaBold.widthOfTextAtSize(formData.quoteNum, 18);
        page.drawText(formData.quoteNum, {
            x: 444 - quoteNumWidth,  // LINE ~2567: Adjust X (right edge at 444)
            y: 586,                   // LINE ~2568: Adjust Y
            size: 18,
            font: fonts.helveticaBold,
            color: asiaRed
        });
        
        // PAGE1_FIELD: Title and Tender - Dynamic positioning
        // Stack from bottom (Y=436) upward based on what's present
        const titleLines = splitTextToLines(formData.quoteTitle, 45);
        const hasTitle2 = titleLines[1] ? true : false;
        const hasTender = formData.tender ? true : false;
        
        // Calculate Y positions based on what elements exist
        let title1Y, title2Y, tenderY;
        
        if (hasTitle2 && hasTender) {
            // All three present: stack normally
            title1Y = 480;
            title2Y = 456;
            tenderY = 436;
        } else if (!hasTitle2 && hasTender) {
            // No title line 2: title1 moves to title2 position
            title1Y = 456;
            tenderY = 436;
        } else if (hasTitle2 && !hasTender) {
            // No tender: both titles move down
            title1Y = 456;
            title2Y = 436;
        } else {
            // Only title line 1: moves to bottom position
            title1Y = 436;
        }
        
        // Draw Title Line 1
        page.drawText(titleLines[0] || '', {
            x: 73,
            y: title1Y,
            size: 18,
            font: fonts.helveticaBold,
            color: black
        });
        
        // Draw Title Line 2 (if exists)
        if (hasTitle2) {
            page.drawText(titleLines[1], {
                x: 73,
                y: title2Y,
                size: 18,
                font: fonts.helveticaBold,
                color: black
            });
        }
        
        // Draw Tender Number (if exists)
        if (hasTender) {
            page.drawText('Tender No. ' + formData.tender, {
                x: 73,
                y: tenderY,
                size: 11,
                font: fonts.helvetica,
                color: darkGray
            });
        }
        
        // PAGE1_FIELD: Customer Company
        if (formData.custCompany) {
            page.drawText(formData.custCompany, {
                x: 83,   // LINE ~2609: Adjust X
                y: 388,  // LINE ~2610: Adjust Y
                size: 16,
                font: fonts.helveticaBold,
                color: black
            });
        }
        
        // PAGE1_FIELD: Customer Contact
        if (formData.custContact) {
            page.drawText(formData.custContact, {
                x: 83,   // LINE ~2620: Adjust X
                y: 367,  // LINE ~2621: Adjust Y
                size: 14,
                font: fonts.helveticaBold,
                color: black
            });
        }
        
        // PAGE1_FIELD: Customer Address (compounded into one line with semicolons)
        if (formData.custAddress) {
            const addressOneLine = formData.custAddress.replace(/\n/g, '; ').replace(/;\s*;/g, ';').trim();
            const maxLen = 50;
            const displayAddr = addressOneLine.length > maxLen ? addressOneLine.substring(0, maxLen) + '...' : addressOneLine;
            page.drawText(displayAddr, {
                x: 100,   // LINE ~2632: Adjust X
                y: 346,  // LINE ~2633: Adjust Y
                size: 10,
                font: fonts.helvetica,
                color: darkGray
            });
        }
        
        // PAGE1_FIELD: Customer Phone
        if (formData.custPhone) {
            page.drawText(formData.custPhone, {
                x: 100,   // LINE ~2643: Adjust X
                y: 329,  // LINE ~2644: Adjust Y
                size: 10,
                font: fonts.helvetica,
                color: darkGray
            });
        }
        
        // PAGE1_FIELD: Customer Email
        if (formData.custEmail) {
            page.drawText(formData.custEmail, {
                x: 100,   // LINE ~2654: Adjust X
                y: 312,  // LINE ~2655: Adjust Y
                size: 10,
                font: fonts.helvetica,
                color: darkGray
            });
        }
        
        // PAGE1_FIELD: Salesman Name (or Company if no salesman)
        if (formData.salesmanInfo) {
            page.drawText(formData.salesmanInfo.name.toUpperCase(), {
                x: 82,
                y: 165,
                size: 14,
                font: fonts.helveticaBold,
                color: black
            });
            
            // PAGE1_FIELD: Salesman Email
            if (formData.salesmanInfo.email) {
                page.drawText(formData.salesmanInfo.email, {
                    x: 100,
                    y: 149,
                    size: 10,
                    font: fonts.helvetica,
                    color: darkGray
                });
            }
            
            // PAGE1_FIELD: Salesman Phone
            if (formData.salesmanInfo.phone) {
                page.drawText(formData.salesmanInfo.phone, {
                    x: 100,
                    y: 131,
                    size: 10,
                    font: fonts.helvetica,
                    color: darkGray
                });
            }
        } else {
            // No salesman — show company info instead
            page.drawText('ASIS BOATS L.L.C.', {
                x: 82,
                y: 165,
                size: 14,
                font: fonts.helveticaBold,
                color: black
            });
            page.drawText('info@asisboats.com', {
                x: 100,
                y: 149,
                size: 10,
                font: fonts.helvetica,
                color: darkGray
            });
            page.drawText('+971 (0)4 880 4441', {
                x: 100,
                y: 131,
                size: 10,
                font: fonts.helvetica,
                color: darkGray
            });
        }
        
        console.log('Cover page generated from template');
        
    } catch (error) {
        console.warn('Error loading template, using fallback:', error);
        await generateCoverPageFallback(pdfDoc, fonts, formData);
    }
}

// Fallback cover page if template is not available
async function generateCoverPageFallback(pdfDoc, fonts, formData) {
    const { rgb } = PDFLib;
    const page = pdfDoc.addPage([612, 792]); // US Letter size
    const { width, height } = page.getSize();
    
    // Colors
    const asiaRed = rgb(0.722, 0.196, 0.251);
    const darkGray = rgb(0.4, 0.4, 0.4);
    const black = rgb(0, 0, 0);
    
    // Header - ASIS text placeholder
    page.drawText('ASIS BOATS', {
        x: 220,
        y: height - 60,
        size: 28,
        font: fonts.helveticaBold,
        color: asiaRed
    });
    page.drawText('ACES OF THE SEA', {
        x: 225,
        y: height - 80,
        size: 10,
        font: fonts.helvetica,
        color: darkGray
    });
    
    // "ADVANCE MARITIME SOLUTION" + Quote Number
    page.drawText('ADVANCE MARITIME SOLUTION', {
        x: 250,
        y: height - 180,
        size: 14,
        font: fonts.helveticaBold,
        color: black
    });
    page.drawText(formData.quoteNum, {
        x: 250,
        y: height - 205,
        size: 20,
        font: fonts.helveticaBold,
        color: asiaRed
    });
    
    // Quotation Title
    const titleLines = splitTextToLines(formData.quoteTitle, 50);
    let yPos = height - 320;
    titleLines.forEach((line, i) => {
        page.drawText(line, {
            x: 50,
            y: yPos - (i * 25),
            size: 18,
            font: fonts.helveticaBold,
            color: black
        });
    });
    yPos -= (titleLines.length * 25) + 10;
    
    // Tender
    if (formData.tender) {
        page.drawText('Tender No. ' + formData.tender, {
            x: 50,
            y: yPos,
            size: 11,
            font: fonts.helvetica,
            color: darkGray
        });
        yPos -= 30;
    }
    
    // "Proposed To:" section
    yPos -= 20;
    page.drawText('Proposed To:', {
        x: 50,
        y: yPos,
        size: 11,
        font: fonts.helvetica,
        color: darkGray
    });
    yPos -= 25;
    
    if (formData.custCompany) {
        page.drawText(formData.custCompany, { x: 50, y: yPos, size: 16, font: fonts.helveticaBold, color: black });
        yPos -= 22;
    }
    if (formData.custContact) {
        page.drawText(formData.custContact, { x: 50, y: yPos, size: 14, font: fonts.helveticaBold, color: black });
        yPos -= 22;
    }
    if (formData.custAddress) {
        page.drawText(formData.custAddress, { x: 50, y: yPos, size: 10, font: fonts.helvetica, color: darkGray });
        yPos -= 18;
    }
    if (formData.custPhone) {
        page.drawText(formData.custPhone, { x: 50, y: yPos, size: 10, font: fonts.helvetica, color: darkGray });
        yPos -= 18;
    }
    if (formData.custEmail) {
        page.drawText(formData.custEmail, { x: 50, y: yPos, size: 10, font: fonts.helvetica, color: darkGray });
    }
    
    // "Prepared" section
    let prepY = 180;
    page.drawText('Prepared', { x: 50, y: prepY, size: 11, font: fonts.helvetica, color: darkGray });
    prepY -= 25;
    
    if (formData.salesmanInfo) {
        if (formData.salesmanInfo.name) {
            page.drawText(formData.salesmanInfo.name.toUpperCase(), { x: 50, y: prepY, size: 14, font: fonts.helveticaBold, color: black });
            prepY -= 18;
        }
        if (formData.salesmanInfo.email) {
            page.drawText(formData.salesmanInfo.email, { x: 50, y: prepY, size: 10, font: fonts.helvetica, color: darkGray });
            prepY -= 16;
        }
        if (formData.salesmanInfo.phone) {
            page.drawText(formData.salesmanInfo.phone, { x: 50, y: prepY, size: 10, font: fonts.helvetica, color: darkGray });
        }
    } else {
        // No salesman — show company info
        page.drawText('ASIS BOATS L.L.C.', { x: 50, y: prepY, size: 14, font: fonts.helveticaBold, color: black });
        prepY -= 18;
        page.drawText('info@asisboats.com', { x: 50, y: prepY, size: 10, font: fonts.helvetica, color: darkGray });
        prepY -= 16;
        page.drawText('+971 (0)4 880 4441', { x: 50, y: prepY, size: 10, font: fonts.helvetica, color: darkGray });
    }
    
    // Footer
    page.drawText('ASIS Boats L.L.C, Jebel Ali Industrial Area 2, Dubai, UAE | Tel: +971 880 4441 | www.asisboats.com', {
        x: 80,
        y: 30,
        size: 8,
        font: fonts.helvetica,
        color: darkGray
    });
}

// ==================== PAGE 3: QUOTATION DETAILS (Using Template) ====================
async function generateQuotationPage(pdfDoc, fonts, formData) {
    const { rgb } = PDFLib;
    
    // Colors
    const asiaRed = rgb(0.722, 0.196, 0.251);
    const darkGray = rgb(0.4, 0.4, 0.4);
    const black = rgb(0, 0, 0);
    const lightGray = rgb(0.9, 0.9, 0.9);
    const white = rgb(1, 1, 1);
    
    // Try to load the page 3 template
    let page;
    let height = 792;
    
    try {
        const templateUrl = PDF_CONFIG.baseUrl + '/assets/pdf/page3_template.pdf';
        const response = await fetch(templateUrl);
        
        if (response.ok) {
            const templateBytes = await response.arrayBuffer();
            const templatePdf = await PDFLib.PDFDocument.load(templateBytes);
            const [templatePage] = await pdfDoc.copyPages(templatePdf, [0]);
            pdfDoc.addPage(templatePage);
            page = pdfDoc.getPages()[pdfDoc.getPageCount() - 1];
            console.log('Page 3 template loaded successfully');
        } else {
            page = pdfDoc.addPage([612, 792]);
            // Draw header manually if no template
            drawDiamond(page, 306, height - 25, 12, asiaRed);
            page.drawText('QUOTATION', { x: 200, y: height - 90, size: 28, font: fonts.timesItalic, color: black });
            // Draw footer
            page.drawLine({ start: { x: 180, y: 50 }, end: { x: 415, y: 50 }, thickness: 0.5, color: darkGray });
            page.drawText('www.asisboats.com', { x: 255, y: 35, size: 10, font: fonts.helveticaBold, color: black });
        }
    } catch (e) {
        page = pdfDoc.addPage([612, 792]);
        drawDiamond(page, 306, height - 25, 12, asiaRed);
        page.drawText('QUOTATION', { x: 200, y: height - 90, size: 28, font: fonts.timesItalic, color: black });
        page.drawLine({ start: { x: 180, y: 50 }, end: { x: 415, y: 50 }, thickness: 0.5, color: darkGray });
        page.drawText('www.asisboats.com', { x: 255, y: 35, size: 10, font: fonts.helveticaBold, color: black });
    }
    
    // Currency symbol/code for display
    const currencyDisplay = formData.currency || 'USD';
    
    // === DYNAMIC CONTENT ===
    
    // Ref. No. and Date line
    let y = height - 130;
    page.drawText('Ref. No.', { x: 60, y, size: 10, font: fonts.helvetica, color: darkGray });
    page.drawText(formData.quoteNum, { x: 110, y, size: 11, font: fonts.helveticaBold, color: black });
    // Date - right-aligned with same spacing as Ref. No. (50px gap between label and value)
    const dateText = formData.quoteDate;
    const dateWidth = fonts.helveticaBold.widthOfTextAtSize(dateText, 11);
    const dateLabelX = 552 - dateWidth - 50; // 50px gap like Ref. No.
    page.drawText('Date:', { x: dateLabelX, y, size: 10, font: fonts.helvetica, color: darkGray });
    page.drawText(dateText, { x: dateLabelX + 50, y, size: 11, font: fonts.helveticaBold, color: black });
    
    // Horizontal line under Ref/Date
    y -= 15;
    page.drawLine({ start: { x: 60, y }, end: { x: 552, y }, thickness: 0.5, color: lightGray });
    
    // === DESIGN K: Split Frame (Asymmetric Border) ===
    
    // Draw the split frame border
    const frameThickness = 8;
    const pageWidth = 612;
    const pageHeight = 792;
    
    // Left border (full height)
    page.drawRectangle({ x: 0, y: 0, width: frameThickness, height: pageHeight, color: asiaRed });
    // Bottom border (full width)
    page.drawRectangle({ x: 0, y: 0, width: pageWidth, height: frameThickness, color: asiaRed });
    // Top-right corner - horizontal part
    page.drawRectangle({ x: pageWidth - 150, y: pageHeight - frameThickness, width: 150, height: frameThickness, color: asiaRed });
    // Top-right corner - vertical part
    page.drawRectangle({ x: pageWidth - frameThickness, y: pageHeight - 100, width: frameThickness, height: 100, color: asiaRed });
    
    // TO: section - Design K: Red text with underline
    y -= 25;
    page.drawText('TO:', { x: 60, y, size: 12, font: fonts.helveticaBold, color: asiaRed });
    page.drawLine({ start: { x: 60, y: y - 5 }, end: { x: 85, y: y - 5 }, thickness: 2, color: asiaRed });
    
    // FROM: section - Design K: Red text with underline
    page.drawText('FROM:', { x: 310, y, size: 12, font: fonts.helveticaBold, color: asiaRed });
    page.drawLine({ start: { x: 310, y: y - 5 }, end: { x: 355, y: y - 5 }, thickness: 2, color: asiaRed });
    
    // Customer and Company details
    y -= 25;
    const leftCol = 60;
    const leftValCol = 140;
    const rightCol = 310;
    const rightValCol = 380;
    
    page.drawText('Company /Dep.:', { x: leftCol, y, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(formData.custCompany || '-', { x: leftValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    page.drawText('Company:', { x: rightCol, y, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText('ASIS BOATS LLC, DUBAI UAE', { x: rightValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    
    y -= 18;
    page.drawText('Point of Contact:', { x: leftCol, y, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(formData.custContact || '-', { x: leftValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    page.drawText('Telephone:', { x: rightCol, y, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText('+971 (0)4 880 4441', { x: rightValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    
    y -= 18;
    page.drawText('Contact #:', { x: leftCol, y, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(formData.custPhone || '-', { x: leftValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    if (formData.salesmanInfo) {
        page.drawText('Sales Person:', { x: rightCol, y, size: 9, font: fonts.helvetica, color: darkGray });
        page.drawText(formData.salesmanInfo.name || '', { x: rightValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    }
    
    y -= 18;
    page.drawText('Email:', { x: leftCol, y, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(formData.custEmail || '-', { x: leftValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    if (formData.salesmanInfo && formData.salesmanInfo.phone) {
        page.drawText('Contact #:', { x: rightCol, y, size: 9, font: fonts.helvetica, color: darkGray });
        page.drawText(formData.salesmanInfo.phone, { x: rightValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    }
    
    y -= 18;
    page.drawText('Address:', { x: leftCol, y, size: 9, font: fonts.helvetica, color: darkGray });
    // Combine multiple address lines into one line separated by semicolons
    const addressOneLine = (formData.custAddress || '-').replace(/\n/g, '; ').replace(/;\s*;/g, ';').trim();
    // Truncate if too long
    const maxAddrLength = 40;
    const displayAddress = addressOneLine.length > maxAddrLength ? addressOneLine.substring(0, maxAddrLength) + '...' : addressOneLine;
    page.drawText(displayAddress, { x: leftValCol, y, size: 9, font: fonts.helvetica, color: black });
    if (formData.salesmanInfo && formData.salesmanInfo.email) {
        page.drawText('Email:', { x: rightCol, y, size: 9, font: fonts.helvetica, color: darkGray });
        page.drawText(formData.salesmanInfo.email, { x: rightValCol, y, size: 9, font: fonts.helveticaBold, color: black });
    }
    
    // Description table header - Design K: Top/bottom borders + gradient
    y -= 35;
    const tableHeaderHeight = 24;
    const gradientLightRed = rgb(0.97, 0.93, 0.94); // rgba(184,50,64,0.08)
    
    // Gradient background (light red fade)
    page.drawRectangle({ x: 60, y: y - 8, width: 492, height: tableHeaderHeight, color: gradientLightRed });
    // Top border
    page.drawLine({ start: { x: 60, y: y + 14 }, end: { x: 552, y: y + 14 }, thickness: 2, color: asiaRed });
    // Bottom border
    page.drawLine({ start: { x: 60, y: y - 8 }, end: { x: 552, y: y - 8 }, thickness: 2, color: asiaRed });
    // Header text
    page.drawText('DESCRIPTION', { x: 70, y, size: 11, font: fonts.helveticaBold, color: asiaRed });
    page.drawText('QTY.', { x: 415, y, size: 11, font: fonts.helveticaBold, color: asiaRed });
    if (formData.showCategoryTotals || formData.showAllPrices) {
        const priceLabel = 'PRICE ' + currencyDisplay;
        // Right-align the price header
        const priceLabelWidth = fonts.helveticaBold.widthOfTextAtSize(priceLabel, 11);
        page.drawText(priceLabel, { x: 542 - priceLabelWidth, y, size: 11, font: fonts.helveticaBold, color: asiaRed });
    }
    
    // Table rows
    y -= 22;
    
    // Row 1: Boat Type and Size (format: "ASIS 9.5M Aluminium RHIB")
    const boatTypeLabels = {
        'aluminum': 'Aluminium RHIB',
        'fiberglass': 'GRP RHIB',
        'inflatable': 'HDIB'
    };
    const boatDescription = `ASIS ${formData.boatSize} ${boatTypeLabels[formData.boatType] || formData.boatTypeName}`;
    page.drawText(boatDescription, { x: 70, y, size: 10, font: fonts.helveticaBold, color: black });
    page.drawText(formData.boatQty.toString(), { x: 420, y, size: 10, font: fonts.helvetica, color: black });
    if (formData.showCategoryTotals || formData.showAllPrices) {
        const boatPriceText = formatNumber(formData.boatPrice);
        const boatPriceWidth = fonts.helvetica.widthOfTextAtSize(boatPriceText, 10);
        page.drawText(boatPriceText, { x: 542 - boatPriceWidth, y, size: 10, font: fonts.helvetica, color: black });
    }
    
    // Dotted line UNDER boat type row
    y -= 10;
    drawDottedLine(page, 70, y, 542, y, lightGray);
    
    // Row 2: Engine (BOLD) - only if engine is selected
    if (formData.engineName) {
        y -= 15;
        const engineText = `- ${formData.engineName}`;
        const engineLines = splitTextToLines(engineText, 55);
        
        engineLines.forEach((line, i) => {
            page.drawText(line, { x: 70, y: y - (i * 12), size: 9, font: fonts.helveticaBold, color: black });
        });
        
        if ((formData.showCategoryTotals || formData.showAllPrices) && formData.engineTotal > 0) {
            const enginePriceText = formatNumber(formData.engineTotal / formData.boatQty);
            const enginePriceWidth = fonts.helvetica.widthOfTextAtSize(enginePriceText, 9);
            page.drawText(enginePriceText, { x: 542 - enginePriceWidth, y, size: 9, font: fonts.helvetica, color: black });
        }
        
        if (engineLines.length > 1) {
            y -= (engineLines.length - 1) * 12;
        }
    }
    
    // Row 3: ASIS ACCESSORIES
    y -= 20;
    page.drawText('- ASIS ACCESSORIES - (ANNEX-1)', { x: 70, y, size: 9, font: fonts.helvetica, color: black });
    if ((formData.showCategoryTotals || formData.showAllPrices) && formData.asiaAccessoriesTotal > 0) {
        const accPriceText = formatNumber(formData.asiaAccessoriesTotal / formData.boatQty);
        const accPriceWidth = fonts.helvetica.widthOfTextAtSize(accPriceText, 9);
        page.drawText(accPriceText, { x: 542 - accPriceWidth, y, size: 9, font: fonts.helvetica, color: black });
    }
    
    // Row 4: ELECTRONIC AND COMMUNICATION
    y -= 20;
    page.drawText('- ELECTRONIC AND COMMUNICATION - (ANNEX-2)', { x: 70, y, size: 9, font: fonts.helvetica, color: black });
    if ((formData.showCategoryTotals || formData.showAllPrices) && formData.electronicsTotal > 0) {
        const elecPriceText = formatNumber(formData.electronicsTotal / formData.boatQty);
        const elecPriceWidth = fonts.helvetica.widthOfTextAtSize(elecPriceText, 9);
        page.drawText(elecPriceText, { x: 542 - elecPriceWidth, y, size: 9, font: fonts.helvetica, color: black });
    }
    
    // Row 5: TECHNICAL SPECIFICATIONS
    y -= 20;
    page.drawText('- TECHNICAL SPECIFICATIONS - (See Attached)', { x: 70, y, size: 9, font: fonts.helvetica, color: black });
    
    // Dotted line after last description item
    y -= 15;
    drawDottedLine(page, 70, y, 542, y, lightGray);
    
    // === NOTE SECTION - Design K: Top/bottom borders + gradient ===
    y -= 25;
    const noteBoxY = y;
    
    // Calculate note lines - support up to 4 lines with tighter spacing
    let noteLines = [];
    if (formData.notes) {
        // Split by newlines first, then wrap each line if needed
        const rawLines = formData.notes.split(/\n/);
        rawLines.forEach(rawLine => {
            if (rawLine.trim()) {
                const wrapped = splitTextToLines(rawLine, 50);
                noteLines = noteLines.concat(wrapped);
            }
        });
        noteLines = noteLines.slice(0, 4); // Max 4 lines
    }
    
    const noteLineHeight = 10; // Tighter line spacing
    const minLines = 2; // Minimum box height = 2 lines
    const actualLines = Math.max(minLines, noteLines.length);
    const noteTextHeight = actualLines * noteLineHeight;
    const noteHeight = noteTextHeight + 12; // Dynamic height based on lines
    
    // Gradient background (using gradientLightRed defined earlier)
    page.drawRectangle({ x: 60, y: noteBoxY - noteHeight + 10, width: 492, height: noteHeight, color: gradientLightRed });
    // Top border
    page.drawLine({ start: { x: 60, y: noteBoxY + 10 }, end: { x: 552, y: noteBoxY + 10 }, thickness: 2, color: asiaRed });
    // Bottom border
    page.drawLine({ start: { x: 60, y: noteBoxY - noteHeight + 10 }, end: { x: 552, y: noteBoxY - noteHeight + 10 }, thickness: 2, color: asiaRed });
    
    // Note label and text
    page.drawText('NOTE:', { x: 70, y: noteBoxY - 5, size: 9, font: fonts.helveticaBold, color: asiaRed });
    noteLines.forEach((line, i) => {
        page.drawText(line, { x: 110, y: noteBoxY - 5 - (i * noteLineHeight), size: 9, font: fonts.helvetica, color: black });
    });
    
    // Total with currency - vertically centered in box
    const boxTopY = noteBoxY + 10;
    const boxBottomY = noteBoxY - noteHeight + 10;
    const boxCenterY = (boxTopY + boxBottomY) / 2 - 2;
    const totalLabel = `TOTAL ${currencyDisplay}`;
    page.drawText(totalLabel, { x: 400, y: boxCenterY, size: 11, font: fonts.helveticaBold, color: black });
    const totalAmountText = formatNumber(formData.total);
    const totalAmountWidth = fonts.helveticaBold.widthOfTextAtSize(totalAmountText, 14);
    page.drawText(totalAmountText, { x: 542 - totalAmountWidth, y: boxCenterY, size: 14, font: fonts.helveticaBold, color: asiaRed });
    
    // === TERMS SECTION ===
    y = noteBoxY - noteHeight - 20;
    const termY = y;
    const termLabelX = 60;
    const termValueX = 155;
    const termLineEnd = 400;
    const lineHeight = 18;
    
    page.drawText('Term of Payment', { x: termLabelX, y: termY, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(`:  ${formData.paymentTerms}`, { x: termValueX, y: termY, size: 9, font: fonts.helveticaBold, color: black });
    drawDottedLine(page, termValueX + 5, termY - 3, termLineEnd, termY - 3, lightGray);
    
    page.drawText('Delivery Schedule', { x: termLabelX, y: termY - lineHeight, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(`:  ${formData.deliveryTimeline}`, { x: termValueX, y: termY - lineHeight, size: 9, font: fonts.helveticaBold, color: black });
    drawDottedLine(page, termValueX + 5, termY - lineHeight - 3, termLineEnd, termY - lineHeight - 3, lightGray);
    
    page.drawText('Delivery Terms', { x: termLabelX, y: termY - lineHeight * 2, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(`:  ${formData.deliveryTerms}`, { x: termValueX, y: termY - lineHeight * 2, size: 9, font: fonts.helveticaBold, color: black });
    drawDottedLine(page, termValueX + 5, termY - lineHeight * 2 - 3, termLineEnd, termY - lineHeight * 2 - 3, lightGray);
    
    page.drawText('Warranty', { x: termLabelX, y: termY - lineHeight * 3, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(':  Click here to read full warranty', { x: termValueX, y: termY - lineHeight * 3, size: 9, font: fonts.helveticaBold, color: black });
    drawDottedLine(page, termValueX + 5, termY - lineHeight * 3 - 3, termLineEnd, termY - lineHeight * 3 - 3, lightGray);
    
    page.drawText('Validity', { x: termLabelX, y: termY - lineHeight * 4, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(`:  ${formData.validity}`, { x: termValueX, y: termY - lineHeight * 4, size: 9, font: fonts.helveticaBold, color: black });
    drawDottedLine(page, termValueX + 5, termY - lineHeight * 4 - 3, termLineEnd, termY - lineHeight * 4 - 3, lightGray);
    
    page.drawText('Country of Origin', { x: termLabelX, y: termY - lineHeight * 5, size: 9, font: fonts.helvetica, color: darkGray });
    page.drawText(':  United Arab Emirates', { x: termValueX, y: termY - lineHeight * 5, size: 9, font: fonts.helveticaBold, color: black });
    drawDottedLine(page, termValueX + 5, termY - lineHeight * 5 - 3, termLineEnd, termY - lineHeight * 5 - 3, lightGray);
    
    // === SIGNATURE SECTION (with more space for stamp/signature) ===
    const sigY = termY - lineHeight * 6 - 15;
    
    // "For ASIS Boats L.L.C,"
    page.drawText('For ', { x: termLabelX, y: sigY, size: 10, font: fonts.helvetica, color: black });
    page.drawText('ASIS Boats L.L.C', { x: termLabelX + 20, y: sigY, size: 10, font: fonts.helveticaBold, color: black });
    page.drawText(',', { x: termLabelX + 105, y: sigY, size: 10, font: fonts.helvetica, color: black });
    
    // Salesman name much lower (90px gap for signature/stamp space)
    page.drawText(formData.salesmanInfo?.name || '', { x: termLabelX, y: sigY - 90, size: 10, font: fonts.helveticaBold, color: black });
}

// ==================== PAGE 4: ANNEX PAGES ====================
async function generateAnnexPages(pdfDoc, fonts, formData) {
    const { rgb } = PDFLib;
    
    // Colors
    const asiaRed = rgb(0.722, 0.196, 0.251);
    const darkGray = rgb(0.4, 0.4, 0.4);
    const black = rgb(0, 0, 0);
    
    // Currency display
    const currencySymbols = { USD: '$', AED: 'AED ', EUR: '€' };
    const currencyDisplay = currencySymbols[formData.currency] || '$';
    const rate = RATES[formData.currency] || 1;
    
    function formatNumber(num) {
        const converted = num * rate;
        return currencyDisplay + converted.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }
    
    // Collect items by annex category
    const annexItems = {
        'ASIS ACCESSORIES': [],
        'ELECTRONICS & COMMUNICATION': []
    };
    
    const groups = formData.categoryGroups;
    
    Object.entries(formData.items).forEach(([cat, items]) => {
        Object.values(items).forEach(item => {
            if (item.name && item.itemIdx !== -1 && item.qty > 0) {
                // Skip engine - it's shown separately
                if (cat === 'Propulsion / Engine' || cat === 'Engine') return;
                
                const itemData = { 
                    name: item.name, 
                    qty: item.qty * formData.boatQty,
                    price: item.isTBD ? 'TBD' : item.price,
                    isTBD: item.isTBD
                };
                
                // Determine which annex this belongs to
                for (const group of groups) {
                    if (group.categories && group.categories.includes(cat)) {
                        if (group.name === 'ASIS Accessories') {
                            annexItems['ASIS ACCESSORIES'].push(itemData);
                        } else if (group.name === 'Electronics & Communication') {
                            annexItems['ELECTRONICS & COMMUNICATION'].push(itemData);
                        }
                        break;
                    }
                    if (group.subgroups) {
                        for (const subgroup of group.subgroups) {
                            if (subgroup.categories && subgroup.categories.includes(cat)) {
                                if (group.name === 'ASIS Accessories') {
                                    annexItems['ASIS ACCESSORIES'].push(itemData);
                                }
                                break;
                            }
                        }
                    }
                }
            }
        });
    });
    
    // Try to load annex template
    let templateAvailable = false;
    let height = STANDARD_PAGE_HEIGHT;  // US Letter height (792)
    try {
        const templateUrl = PDF_CONFIG.baseUrl + 'assets/pdf/annex_template.pdf';
        const response = await fetch(templateUrl);
        if (response.ok) {
            templateAvailable = true;
        }
    } catch (e) {
        console.warn('Annex template not found, using blank page');
    }
    
    // Helper function to add a new annex page (scaled to Letter size)
    async function addAnnexPage() {
        let page;
        if (templateAvailable) {
            // Copy template for each new page
            const templateUrl = PDF_CONFIG.baseUrl + 'assets/pdf/annex_template.pdf';
            const response = await fetch(templateUrl);
            const templateBytes = await response.arrayBuffer();
            const templatePdf = await PDFLib.PDFDocument.load(templateBytes);
            const [newPage] = await pdfDoc.copyPages(templatePdf, [0]);
            
            // Scale to standard Letter size if needed
            const { width: origWidth, height: origHeight } = newPage.getSize();
            if (Math.abs(origWidth - STANDARD_PAGE_WIDTH) > 1 || Math.abs(origHeight - STANDARD_PAGE_HEIGHT) > 1) {
                const scaleX = STANDARD_PAGE_WIDTH / origWidth;
                const scaleY = STANDARD_PAGE_HEIGHT / origHeight;
                const scale = Math.min(scaleX, scaleY);
                
                newPage.setSize(STANDARD_PAGE_WIDTH, STANDARD_PAGE_HEIGHT);
                newPage.scaleContent(scale, scale);
                
                // Center content if aspect ratios differ
                if (scaleX !== scaleY) {
                    const newWidth = origWidth * scale;
                    const newHeight = origHeight * scale;
                    const xOffset = (STANDARD_PAGE_WIDTH - newWidth) / 2;
                    const yOffset = (STANDARD_PAGE_HEIGHT - newHeight) / 2;
                    newPage.translateContent(xOffset, yOffset);
                }
                console.log(`Scaled annex page from ${origWidth}x${origHeight} to ${STANDARD_PAGE_WIDTH}x${STANDARD_PAGE_HEIGHT}`);
            }
            
            pdfDoc.addPage(newPage);
            page = pdfDoc.getPages()[pdfDoc.getPageCount() - 1];
        } else {
            page = pdfDoc.addPage([STANDARD_PAGE_WIDTH, STANDARD_PAGE_HEIGHT]); // US Letter
            // Draw header manually if no template
            drawDiamond(page, 306, height - 25, 12, asiaRed);
            page.drawText('PERFORMANCE - QUALITY - DESIGN - SAFETY', { x: 178, y: height - 50, size: 10, font: fonts.helveticaBold, color: black });
        }
        return page;
    }
    
    // Generate first annex page
    let page = await addAnnexPage();
    let { width } = page.getSize();
    height = STANDARD_PAGE_HEIGHT;  // US Letter height
    let y = STANDARD_PAGE_HEIGHT - 100;  // Start higher on page (moved up from -130)
    
    // ANNEX 1: ASIS ACCESSORIES
    page.drawText('ANNEX 1:', { x: 60, y, size: 12, font: fonts.helveticaBold, color: black });
    y -= 20;
    page.drawText('ASIS ACCESSORIES', { x: 60, y, size: 11, font: fonts.helveticaBold, color: asiaRed });
    y -= 25;
    
    if (annexItems['ASIS ACCESSORIES'].length === 0) {
        page.drawText('- No accessories selected', { x: 70, y, size: 10, font: fonts.helvetica, color: darkGray });
        y -= 20;
    } else {
        for (const item of annexItems['ASIS ACCESSORIES']) {
            if (y < 100) {
                // Add new page using template
                page = await addAnnexPage();
                y = STANDARD_PAGE_HEIGHT - 100;  // Start higher on page
            }
            
            let itemText = `- ${item.name} (Qty: ${item.qty})`;
            if (formData.showAllPrices && item.price) {
                const priceText = item.isTBD ? 'TBD' : formatNumber(item.price);
                itemText += ` - ${priceText}`;
            }
            page.drawText(truncateText(itemText, 85), { x: 70, y, size: 10, font: fonts.helvetica, color: black });
            y -= 18;
        }
    }
    
    // ANNEX 2: ELECTRONICS & COMMUNICATION
    y -= 30;
    if (y < 150) {
        page = await addAnnexPage();
        y = STANDARD_PAGE_HEIGHT - 100;  // Start higher on page
    }
    
    page.drawText('ANNEX 2:', { x: 60, y, size: 12, font: fonts.helveticaBold, color: black });
    y -= 20;
    page.drawText('ELECTRONICS & COMMUNICATION', { x: 60, y, size: 11, font: fonts.helveticaBold, color: asiaRed });
    y -= 25;
    
    if (annexItems['ELECTRONICS & COMMUNICATION'].length === 0) {
        page.drawText('- No electronics selected', { x: 70, y, size: 10, font: fonts.helvetica, color: darkGray });
    } else {
        for (const item of annexItems['ELECTRONICS & COMMUNICATION']) {
            if (y < 100) {
                page = await addAnnexPage();
                y = STANDARD_PAGE_HEIGHT - 100;  // Start higher on page
            }
            
            let itemText = `- ${item.name} (Qty: ${item.qty})`;
            if (formData.showAllPrices && item.price) {
                const priceText = item.isTBD ? 'TBD' : formatNumber(item.price);
                itemText += ` - ${priceText}`;
            }
            page.drawText(truncateText(itemText, 85), { x: 70, y, size: 10, font: fonts.helvetica, color: black });
            y -= 18;
        }
    }
    
    // Footer is already on the template - no need to draw it
}

// ==================== EMBED STATIC PDF ====================
// Standard page size - US Letter (612 x 792)
const STANDARD_PAGE_WIDTH = 612;
const STANDARD_PAGE_HEIGHT = 792;

async function embedStaticPdf(pdfDoc, pdfPath, description) {
    try {
        const url = PDF_CONFIG.baseUrl + pdfPath;
        const response = await fetch(url);
        
        if (!response.ok) {
            console.warn(`Could not load ${description} from ${url}`);
            return;
        }
        
        const pdfBytes = await response.arrayBuffer();
        const externalPdf = await PDFLib.PDFDocument.load(pdfBytes);
        const pages = await pdfDoc.copyPages(externalPdf, externalPdf.getPageIndices());
        
        pages.forEach(page => {
            // Scale page to standard Letter size if different
            const { width, height } = page.getSize();
            if (Math.abs(width - STANDARD_PAGE_WIDTH) > 1 || Math.abs(height - STANDARD_PAGE_HEIGHT) > 1) {
                // Calculate scale to fit content
                const scaleX = STANDARD_PAGE_WIDTH / width;
                const scaleY = STANDARD_PAGE_HEIGHT / height;
                const scale = Math.min(scaleX, scaleY); // Maintain aspect ratio
                
                // Set the page to standard size
                page.setSize(STANDARD_PAGE_WIDTH, STANDARD_PAGE_HEIGHT);
                
                // Scale and center the content
                page.scaleContent(scale, scale);
                
                // Center the content if aspect ratios differ
                if (scaleX !== scaleY) {
                    const newWidth = width * scale;
                    const newHeight = height * scale;
                    const xOffset = (STANDARD_PAGE_WIDTH - newWidth) / 2;
                    const yOffset = (STANDARD_PAGE_HEIGHT - newHeight) / 2;
                    page.translateContent(xOffset, yOffset);
                }
                
                console.log(`Scaled ${description} page from ${width}x${height} to ${STANDARD_PAGE_WIDTH}x${STANDARD_PAGE_HEIGHT}`);
            }
            pdfDoc.addPage(page);
        });
        console.log(`Embedded ${description}: ${pages.length} page(s)`);
    } catch (error) {
        console.warn(`Failed to embed ${description}:`, error);
    }
}

// ==================== FALLBACK SIMPLIFIED PDF ====================
async function generateSimplifiedPDF() {
    const { PDFDocument, rgb, StandardFonts } = PDFLib;
    
    const formData = gatherFormData();
    const pdfDoc = await PDFDocument.create();
    
    const helvetica = await pdfDoc.embedFont(StandardFonts.Helvetica);
    const helveticaBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
    const timesRoman = await pdfDoc.embedFont(StandardFonts.TimesRoman);
    const timesItalic = await pdfDoc.embedFont(StandardFonts.TimesRomanItalic);
    
    const fonts = { helvetica, helveticaBold, timesRoman, timesItalic };
    
    // Generate only the dynamic pages
    await generateCoverPage(pdfDoc, fonts, formData);
    await generateQuotationPage(pdfDoc, fonts, formData);
    await generateAnnexPages(pdfDoc, fonts, formData);
    
    // Save and download
    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${formData.quoteNum}_simplified.pdf`;
    link.click();
    URL.revokeObjectURL(url);
}

// ==================== HELPER FUNCTIONS ====================
function splitTextToLines(text, maxChars) {
    if (!text) return [''];
    const words = text.split(' ');
    const lines = [];
    let currentLine = '';
    
    words.forEach(word => {
        if ((currentLine + ' ' + word).trim().length <= maxChars) {
            currentLine = (currentLine + ' ' + word).trim();
        } else {
            if (currentLine) lines.push(currentLine);
            currentLine = word;
        }
    });
    if (currentLine) lines.push(currentLine);
    return lines.length > 0 ? lines : [''];
}

function truncateText(text, maxChars) {
    if (!text) return '';
    return text.length > maxChars ? text.substring(0, maxChars - 3) + '...' : text;
}

function formatNumber(num) {
    if (typeof num !== 'number') return '0';
    return num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function drawDottedLine(page, x1, y1, x2, y2, color) {
    const dotSpacing = 3;
    const distance = x2 - x1;
    const dots = Math.floor(distance / dotSpacing);
    
    for (let i = 0; i < dots; i++) {
        const x = x1 + (i * dotSpacing);
        page.drawCircle({ x, y: y1, size: 0.5, color });
    }
}

// Draw a diamond shape (ASIS logo placeholder)
function drawDiamond(page, x, y, size, color) {
    const half = size / 2;
    // Draw as a rotated square using lines
    page.drawLine({ start: { x: x, y: y + half }, end: { x: x + half, y: y }, thickness: 2, color });
    page.drawLine({ start: { x: x + half, y: y }, end: { x: x, y: y - half }, thickness: 2, color });
    page.drawLine({ start: { x: x, y: y - half }, end: { x: x - half, y: y }, thickness: 2, color });
    page.drawLine({ start: { x: x - half, y: y }, end: { x: x, y: y + half }, thickness: 2, color });
}

// Draw a location pin icon
function drawLocationPin(page, x, y, color) {
    // Simple circle with a point below
    page.drawCircle({ x: x, y: y + 3, size: 4, color, borderWidth: 1.5, borderColor: color });
    page.drawLine({ start: { x: x - 3, y: y + 1 }, end: { x: x, y: y - 5 }, thickness: 1.5, color });
    page.drawLine({ start: { x: x + 3, y: y + 1 }, end: { x: x, y: y - 5 }, thickness: 1.5, color });
}

// Draw a phone icon
function drawPhoneIcon(page, x, y, color) {
    // Simple rectangle for phone body
    page.drawRectangle({ x: x - 3, y: y - 5, width: 6, height: 10, borderColor: color, borderWidth: 1.5 });
    page.drawCircle({ x: x, y: y - 3, size: 1, color });
}

// Draw an envelope icon
function drawEnvelopeIcon(page, x, y, color) {
    // Rectangle body
    page.drawRectangle({ x: x - 5, y: y - 3, width: 10, height: 7, borderColor: color, borderWidth: 1.5 });
    // V shape for flap
    page.drawLine({ start: { x: x - 5, y: y + 4 }, end: { x: x, y: y }, thickness: 1.5, color });
    page.drawLine({ start: { x: x + 5, y: y + 4 }, end: { x: x, y: y }, thickness: 1.5, color });
}

function downloadCSV() {
    const boat = BOATS[state.boatType].sizes[state.sizeIdx];
    const boatQty = parseInt(document.getElementById('boatQty')?.value) || 1;
    const salesmanInfo = getSalesmanInfo();
    const discountPct = parseFloat(document.getElementById('discount').value) || 0;
    
    // Calculate totals
    let optionsTotal = 0;
    let engineTotal = 0;
    let accessoriesTotal = 0;
    let electronicsTotal = 0;
    
    const engineCats = ["Propulsion / Engine", "Engine"];
    const electronicsCats = ["GPS", "Radar", "VHF", "Other Communication", "FLIR / Thermal", "Lighting & Electrical"];
    
    // Collect items by category
    const engineItems = [];
    const accessoriesItems = [];
    const electronicsItems = [];
    
    Object.entries(state.items).forEach(([cat, items]) => {
        Object.values(items).forEach(item => {
            if (item.name && item.itemIdx !== -1 && item.qty > 0) {
                const totalQty = item.qty * boatQty;
                const total = item.isTBD ? 0 : item.price * totalQty;
                const itemData = {
                    name: item.name,
                    qty: totalQty,
                    price: item.isTBD ? 'TBD' : item.price,
                    total: item.isTBD ? 'TBD' : total
                };
                
                if (engineCats.includes(cat)) {
                    engineItems.push(itemData);
                    if (!item.isTBD) engineTotal += total;
                } else if (electronicsCats.includes(cat)) {
                    electronicsItems.push(itemData);
                    if (!item.isTBD) electronicsTotal += total;
                } else {
                    accessoriesItems.push(itemData);
                    if (!item.isTBD) accessoriesTotal += total;
                }
                
                if (!item.isTBD) optionsTotal += total;
            }
        });
    });
    
    const boatTotal = boat.price * boatQty;
    const subtotal = boatTotal + optionsTotal;
    const discount = subtotal * (discountPct / 100);
    const grandTotal = subtotal - discount;
    
    // Style definitions
    const borderAll = {
        top: { style: 'thin', color: { rgb: '000000' } },
        bottom: { style: 'thin', color: { rgb: '000000' } },
        left: { style: 'thin', color: { rgb: '000000' } },
        right: { style: 'thin', color: { rgb: '000000' } }
    };
    
    const borderGold = {
        top: { style: 'medium', color: { rgb: 'D4A800' } },
        bottom: { style: 'medium', color: { rgb: 'D4A800' } },
        left: { style: 'medium', color: { rgb: 'D4A800' } },
        right: { style: 'medium', color: { rgb: 'D4A800' } }
    };
    
    // Build single sheet data
    const data = [];
    const styles = {}; // Will store row styles
    let row = 0;
    
    // === HEADER ===
    data.push([{ v: 'ASIS BOATS LLC', s: { font: { bold: true, sz: 18, color: { rgb: 'FFFFFF' } }, fill: { fgColor: { rgb: '0A1628' } }, alignment: { horizontal: 'center' }, border: borderAll } }, '', '', '']);
    row++;
    data.push([{ v: 'QUOTATION', s: { font: { bold: true, sz: 14, color: { rgb: 'D4A800' } }, fill: { fgColor: { rgb: '0A1628' } }, alignment: { horizontal: 'center' }, border: borderAll } }, '', '', '']);
    row++;
    data.push(['', '', '', '']);
    row++;
    
    // === QUOTE INFO SECTION ===
    data.push([
        { v: 'Quote #', s: { font: { bold: true }, fill: { fgColor: { rgb: 'E5E7EB' } }, border: borderAll } },
        { v: document.getElementById('quoteNum').value, s: { border: borderAll } },
        { v: 'Date', s: { font: { bold: true }, fill: { fgColor: { rgb: 'E5E7EB' } }, border: borderAll } },
        { v: document.getElementById('quoteDate').value, s: { border: borderAll } }
    ]);
    row++;
    data.push([
        { v: 'Title', s: { font: { bold: true }, fill: { fgColor: { rgb: 'E5E7EB' } }, border: borderAll } },
        { v: document.getElementById('quoteTitle').value, s: { border: borderAll } },
        { v: 'Validity', s: { font: { bold: true }, fill: { fgColor: { rgb: 'E5E7EB' } }, border: borderAll } },
        { v: document.getElementById('validity').value, s: { border: borderAll } }
    ]);
    row++;
    data.push(['', '', '', '']);
    row++;
    
    // === CUSTOMER SECTION ===
    data.push([{ v: 'CUSTOMER INFORMATION', s: { font: { bold: true, sz: 11, color: { rgb: 'FFFFFF' } }, fill: { fgColor: { rgb: '1E3A5F' } }, border: borderAll } }, '', '', '']);
    row++;
    data.push([
        { v: 'Company', s: { font: { bold: true }, fill: { fgColor: { rgb: 'F3F4F6' } }, border: borderAll } },
        { v: document.getElementById('custCompany').value || '-', s: { border: borderAll } },
        { v: 'Contact', s: { font: { bold: true }, fill: { fgColor: { rgb: 'F3F4F6' } }, border: borderAll } },
        { v: document.getElementById('custName').value || '-', s: { border: borderAll } }
    ]);
    row++;
    data.push([
        { v: 'Email', s: { font: { bold: true }, fill: { fgColor: { rgb: 'F3F4F6' } }, border: borderAll } },
        { v: document.getElementById('custEmail').value || '-', s: { border: borderAll } },
        { v: 'Phone', s: { font: { bold: true }, fill: { fgColor: { rgb: 'F3F4F6' } }, border: borderAll } },
        { v: document.getElementById('custPhone').value || '-', s: { border: borderAll } }
    ]);
    row++;
    const tender = document.getElementById('tenderNum').value;
    if (tender) {
        data.push([
            { v: 'Tender #', s: { font: { bold: true }, fill: { fgColor: { rgb: 'F3F4F6' } }, border: borderAll } },
            { v: tender, s: { border: borderAll } },
            '', ''
        ]);
        row++;
    }
    data.push(['', '', '', '']);
    row++;
    
    // === SALESMAN SECTION ===
    if (salesmanInfo) {
        data.push([{ v: 'SALESMAN', s: { font: { bold: true, sz: 11, color: { rgb: 'FFFFFF' } }, fill: { fgColor: { rgb: '1E3A5F' } }, border: borderAll } }, '', '', '']);
        row++;
        data.push([
            { v: 'Name', s: { font: { bold: true }, fill: { fgColor: { rgb: 'F3F4F6' } }, border: borderAll } },
            { v: salesmanInfo.name, s: { border: borderAll } },
            { v: 'Phone', s: { font: { bold: true }, fill: { fgColor: { rgb: 'F3F4F6' } }, border: borderAll } },
            { v: salesmanInfo.phone, s: { border: borderAll } }
        ]);
        row++;
        data.push([
            { v: 'Email', s: { font: { bold: true }, fill: { fgColor: { rgb: 'F3F4F6' } }, border: borderAll } },
            { v: salesmanInfo.email, s: { border: borderAll } },
            '', ''
        ]);
        row++;
        data.push(['', '', '', '']);
        row++;
    }
    
    // === ITEMS SECTION ===
    data.push([{ v: 'QUOTATION ITEMS', s: { font: { bold: true, sz: 11, color: { rgb: 'FFFFFF' } }, fill: { fgColor: { rgb: '1E3A5F' } }, border: borderAll } }, '', '', '']);
    row++;
    
    // Items header
    data.push([
        { v: 'Description', s: { font: { bold: true, color: { rgb: 'FFFFFF' } }, fill: { fgColor: { rgb: '374151' } }, border: borderAll, alignment: { horizontal: 'left' } } },
        { v: 'Qty', s: { font: { bold: true, color: { rgb: 'FFFFFF' } }, fill: { fgColor: { rgb: '374151' } }, border: borderAll, alignment: { horizontal: 'center' } } },
        { v: 'Unit Price', s: { font: { bold: true, color: { rgb: 'FFFFFF' } }, fill: { fgColor: { rgb: '374151' } }, border: borderAll, alignment: { horizontal: 'right' } } },
        { v: 'Total', s: { font: { bold: true, color: { rgb: 'FFFFFF' } }, fill: { fgColor: { rgb: '374151' } }, border: borderAll, alignment: { horizontal: 'right' } } }
    ]);
    row++;
    
    // Boat row
    data.push([
        { v: `${BOATS[state.boatType].name} - ${boat.size}`, s: { font: { bold: true }, fill: { fgColor: { rgb: 'DBEAFE' } }, border: borderAll } },
        { v: boatQty, s: { fill: { fgColor: { rgb: 'DBEAFE' } }, border: borderAll, alignment: { horizontal: 'center' } } },
        { v: boat.price, s: { fill: { fgColor: { rgb: 'DBEAFE' } }, border: borderAll, numFmt: '$#,##0', alignment: { horizontal: 'right' } } },
        { v: boatTotal, s: { font: { bold: true }, fill: { fgColor: { rgb: 'DBEAFE' } }, border: borderAll, numFmt: '$#,##0', alignment: { horizontal: 'right' } } }
    ]);
    row++;
    
    // Engine items
    if (engineItems.length > 0) {
        data.push([{ v: 'Engine / Propulsion', s: { font: { bold: true, italic: true }, fill: { fgColor: { rgb: 'E6F4F8' } }, border: borderAll } }, '', '', '']);
        row++;
        engineItems.forEach(item => {
            data.push([
                { v: item.name, s: { fill: { fgColor: { rgb: 'E6F4F8' } }, border: borderAll } },
                { v: item.qty, s: { fill: { fgColor: { rgb: 'E6F4F8' } }, border: borderAll, alignment: { horizontal: 'center' } } },
                { v: item.price, s: { fill: { fgColor: { rgb: 'E6F4F8' } }, border: borderAll, numFmt: typeof item.price === 'number' ? '$#,##0' : '@', alignment: { horizontal: 'right' } } },
                { v: item.total, s: { fill: { fgColor: { rgb: 'E6F4F8' } }, border: borderAll, numFmt: typeof item.total === 'number' ? '$#,##0' : '@', alignment: { horizontal: 'right' } } }
            ]);
            row++;
        });
    }
    
    // Accessories items
    if (accessoriesItems.length > 0) {
        data.push([{ v: 'ASIS Accessories', s: { font: { bold: true, italic: true }, fill: { fgColor: { rgb: 'FDF6E9' } }, border: borderAll } }, '', '', '']);
        row++;
        accessoriesItems.forEach(item => {
            data.push([
                { v: item.name, s: { fill: { fgColor: { rgb: 'FDF6E9' } }, border: borderAll } },
                { v: item.qty, s: { fill: { fgColor: { rgb: 'FDF6E9' } }, border: borderAll, alignment: { horizontal: 'center' } } },
                { v: item.price, s: { fill: { fgColor: { rgb: 'FDF6E9' } }, border: borderAll, numFmt: typeof item.price === 'number' ? '$#,##0' : '@', alignment: { horizontal: 'right' } } },
                { v: item.total, s: { fill: { fgColor: { rgb: 'FDF6E9' } }, border: borderAll, numFmt: typeof item.total === 'number' ? '$#,##0' : '@', alignment: { horizontal: 'right' } } }
            ]);
            row++;
        });
    }
    
    // Electronics items
    if (electronicsItems.length > 0) {
        data.push([{ v: 'Electronics & Communication', s: { font: { bold: true, italic: true }, fill: { fgColor: { rgb: 'F3EAFA' } }, border: borderAll } }, '', '', '']);
        row++;
        electronicsItems.forEach(item => {
            data.push([
                { v: item.name, s: { fill: { fgColor: { rgb: 'F3EAFA' } }, border: borderAll } },
                { v: item.qty, s: { fill: { fgColor: { rgb: 'F3EAFA' } }, border: borderAll, alignment: { horizontal: 'center' } } },
                { v: item.price, s: { fill: { fgColor: { rgb: 'F3EAFA' } }, border: borderAll, numFmt: typeof item.price === 'number' ? '$#,##0' : '@', alignment: { horizontal: 'right' } } },
                { v: item.total, s: { fill: { fgColor: { rgb: 'F3EAFA' } }, border: borderAll, numFmt: typeof item.total === 'number' ? '$#,##0' : '@', alignment: { horizontal: 'right' } } }
            ]);
            row++;
        });
    }
    
    // Empty row before totals
    data.push(['', '', '', '']);
    row++;
    
    // Totals
    if (discountPct > 0) {
        data.push([
            '', '',
            { v: 'Subtotal:', s: { font: { bold: true }, alignment: { horizontal: 'right' } } },
            { v: subtotal, s: { numFmt: '$#,##0', alignment: { horizontal: 'right' } } }
        ]);
        row++;
        data.push([
            '', '',
            { v: `Discount (${discountPct}%):`, s: { font: { bold: true }, alignment: { horizontal: 'right' } } },
            { v: -discount, s: { numFmt: '$#,##0', alignment: { horizontal: 'right' }, font: { color: { rgb: 'DC2626' } } } }
        ]);
        row++;
    }
    
    // Grand Total
    data.push([
        '', '',
        { v: 'GRAND TOTAL:', s: { font: { bold: true, sz: 12, color: { rgb: 'FFFFFF' } }, fill: { fgColor: { rgb: '0A1628' } }, border: borderGold, alignment: { horizontal: 'right' } } },
        { v: grandTotal, s: { font: { bold: true, sz: 12, color: { rgb: 'FFFFFF' } }, fill: { fgColor: { rgb: '0A1628' } }, border: borderGold, numFmt: '$#,##0', alignment: { horizontal: 'right' } } }
    ]);
    row++;
    
    data.push(['', '', '', '']);
    row++;
    
    // === TERMS SECTION ===
    data.push([{ v: 'TERMS & CONDITIONS', s: { font: { bold: true, sz: 11, color: { rgb: 'FFFFFF' } }, fill: { fgColor: { rgb: '1E3A5F' } }, border: borderAll } }, '', '', '']);
    row++;
    data.push([
        { v: 'Payment', s: { font: { bold: true }, fill: { fgColor: { rgb: 'F3F4F6' } }, border: borderAll } },
        { v: document.getElementById('payTerms').value, s: { border: borderAll } },
        { v: 'Delivery', s: { font: { bold: true }, fill: { fgColor: { rgb: 'F3F4F6' } }, border: borderAll } },
        { v: document.getElementById('deliveryTerms').value, s: { border: borderAll } }
    ]);
    row++;
    data.push([
        { v: 'Timeline', s: { font: { bold: true }, fill: { fgColor: { rgb: 'F3F4F6' } }, border: borderAll } },
        { v: getDeliveryTimeline(), s: { border: borderAll } },
        '', ''
    ]);
    row++;
    
    // Notes
    const notes = document.getElementById('quoteNotes').value;
    if (notes) {
        data.push(['', '', '', '']);
        row++;
        data.push([{ v: 'NOTES', s: { font: { bold: true, sz: 11, color: { rgb: 'FFFFFF' } }, fill: { fgColor: { rgb: '1E3A5F' } }, border: borderAll } }, '', '', '']);
        row++;
        data.push([{ v: notes, s: { border: borderAll } }, '', '', '']);
        row++;
    }
    
    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    // Set column widths
    ws['!cols'] = [
        { wch: 40 },  // Description
        { wch: 30 },  // Value / Qty
        { wch: 15 },  // Unit Price
        { wch: 15 }   // Total
    ];
    
    // Merge cells for headers
    ws['!merges'] = [
        { s: { r: 0, c: 0 }, e: { r: 0, c: 3 } }, // ASIS BOATS LLC
        { s: { r: 1, c: 0 }, e: { r: 1, c: 3 } }, // QUOTATION
    ];
    
    // Create workbook and download
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Quotation');
    XLSX.writeFile(wb, `${document.getElementById('quoteNum').value}.xlsx`);
}

// Auto-capitalize first letter of inputs and limit notes to 4 lines
function setupStep3Inputs() {
    // Text inputs to auto-capitalize (first letter)
    const textInputIds = ['quoteTitle', 'custCompany', 'custName', 'tenderNum', 'deliveryTerms', 'deliveryCustom'];
    
    textInputIds.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', function() {
                if (this.value.length === 1) {
                    this.value = this.value.charAt(0).toUpperCase();
                } else if (this.value.length > 1 && this.value.charAt(0) !== this.value.charAt(0).toUpperCase()) {
                    this.value = this.value.charAt(0).toUpperCase() + this.value.slice(1);
                }
            });
        }
    });
    
    // Auto-capitalize textareas (custAddr, quoteNotes)
    const textareaIds = ['custAddr', 'quoteNotes'];
    textareaIds.forEach(id => {
        const textarea = document.getElementById(id);
        if (textarea) {
            textarea.addEventListener('input', function() {
                if (this.value.length === 1) {
                    this.value = this.value.charAt(0).toUpperCase();
                } else if (this.value.length > 1 && this.value.charAt(0) !== this.value.charAt(0).toUpperCase()) {
                    this.value = this.value.charAt(0).toUpperCase() + this.value.slice(1);
                }
            });
        }
    });
    
    // Limit notes to 4 lines
    const notesTextarea = document.getElementById('quoteNotes');
    if (notesTextarea) {
        notesTextarea.addEventListener('input', function() {
            const lines = this.value.split('\n');
            if (lines.length > 4) {
                this.value = lines.slice(0, 4).join('\n');
            }
        });
        notesTextarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const lines = this.value.split('\n');
                if (lines.length >= 4) {
                    e.preventDefault();
                }
            }
        });
    }
}

// ==================== AUTOSAVE LISTENERS ====================
function setupAutosaveListeners() {
    // All Step 3 form fields
    const formFields = [
        'quoteTitle', 'quoteNum', 'boatQty', 'quoteDate', 'validity', 'salesman',
        'custCompany', 'custName', 'custEmail', 'custPhone', 'tenderNum', 'custAddr',
        'payTerms', 'deliveryTerms', 'deliverySelect', 'deliveryCustom', 'discount',
        'quoteNotes', 'showCategoryTotals', 'showAllPrices'
    ];
    
    formFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('change', triggerAutosave);
            if (el.tagName === 'INPUT' && el.type === 'text' || el.tagName === 'TEXTAREA') {
                el.addEventListener('input', triggerAutosave);
            }
        }
    });
}

// Warn before leaving with unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes.';
    }
});

// Init
setupStep3Inputs();
setupAutosaveListeners();
init();
</script>
</body>
</html>
